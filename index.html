<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma Formaci√≥n Policial - NOJ Salamanca (CLOUD)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #0a2e5c; --accent: #d4af37; --bg: #f4f7f9; --text: #333; --danger: #c0392b; --success: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; background: linear-gradient(rgba(10,46,92,0.9), rgba(10,46,92,0.9)), url('jefatura.jpg') no-repeat center center fixed; background-size: cover; display: flex; justify-content: center; align-items: center; }
        .login-card { background: white; padding: 40px; border-radius: 12px; width: 320px; text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.5); }
        .login-card img { width: 100px; margin-bottom: 20px; }
        .login-card input { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing:border-box; font-size: 16px; }
        .btn-enter { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 15px; }
        .btn-enter:disabled { background: #ccc; cursor: not-allowed; }
        
        /* APP LAYOUT */
        #main-app { display: none; height: 100%; flex-direction: column; }
        .app-header { background: white; padding: 10px; text-align: center; border-bottom: 4px solid #d4af37; flex-shrink: 0; }
        .app-header img { height: 80px; width: auto; max-width: 100%; } 
        .top-bar { background: var(--primary); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .btn-logout { background: #c0392b; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        .content-area { flex: 1; display: flex; overflow: hidden; }
        .sidebar { width: 260px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; }
        .sidebar-logo { text-align: center; padding: 20px; border-bottom: 1px solid #eee; background: #fdfdfd; }
        .sidebar-logo img { width: 120px; height: auto; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        
        .menu-item { padding: 15px; cursor: pointer; border-bottom: 1px solid #eee; color: #555; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background: #f0f4f8; color: var(--primary); border-left: 4px solid var(--primary); }
        .menu-item i { width: 25px; text-align: center; margin-right: 10px; }

        .viewport { flex: 1; padding: 30px; overflow-y: auto; background: #f4f7f9; position: relative; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }

        /* TEMARIO */
        .doc-nav { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 20px; }
        .doc-tab { padding: 10px; background: #e0e0e0; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.8rem; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .doc-tab.active { background: var(--primary); color: white; }
        .doc-page { display: none; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); line-height: 1.6; text-align: justify; }
        .doc-page.active { display: block; }
        .doc-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .doc-table th, .doc-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .doc-table th { background: #f1f1f1; }

        /* FLASHCARDS */
        .fc-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .fc-container { perspective: 1000px; height: 320px; width: 100%; max-width: 600px; cursor: pointer; position: relative; z-index: 1; }
        .fc-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .fc-flipped .fc-inner { transform: rotateY(180deg); }
        .fc-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; display: flex; align-items: center; justify-content: center; padding: 20px; text-align: center; border-radius: 15px; font-size: 1.3rem; box-sizing: border-box; background: white; border: 2px solid var(--primary); }
        .fc-front { background: var(--primary); color: white; z-index: 2; transform: rotateY(0deg); }
        .fc-back { transform: rotateY(180deg); color: #333; }
        .fc-controls { display: flex; gap: 20px; z-index: 10; margin-bottom: 50px; }
        .btn-fc { padding: 12px 30px; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; width: 140px; }
        .btn-prev { background: #c0392b; }
        .btn-next { background: #27ae60; }

        /* TEST */
        .quiz-option { padding: 15px; margin: 10px 0; background: white; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; display: flex; align-items: center; position: relative; z-index: 5; }
        .quiz-option:hover { background: #f9f9f9; }
        .quiz-option.selected { background: #e3f2fd; border-color: var(--primary); }
        .quiz-option.correct { background: #d4edda; border-color: green; }
        .quiz-option.wrong { background: #f8d7da; border-color: red; }

        /* ADMIN & UTILS */
        .admin-table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; font-size: 0.9rem; }
        .admin-table th, .admin-table td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        .admin-table th { background: #eee; }
        .import-area { width: 100%; height: 100px; padding: 10px; margin-top: 10px; font-family: monospace; font-size: 11px; }
        .media-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .media-card { background: white; padding: 15px; cursor: pointer; text-align: center; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .media-card:hover { transform: translateY(-5px); border: 2px solid var(--primary); }
        .media-card img { max-width: 100%; height: 180px; object-fit: cover; border-radius: 4px; }
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <img src="poli (2).png" alt="Logo" class="login-card img" onerror="this.style.display='none'">
            <h2>Acceso Restringido</h2>
            <p>NOJ Salamanca (Cloud)</p>
            <input type="text" id="user" placeholder="Usuario">
            <input type="password" id="pass" placeholder="Contrase√±a">
            <button class="btn-enter" onclick="window.App.login()" id="btn-login-action">Entrar</button>
            <p id="msg" style="color:red; margin-top:10px;"></p>
            <p id="loading-msg" style="color:blue; margin-top:5px; font-size:0.8rem; display:none;">Conectando a Firebase...</p>
        </div>
    </div>

    <div id="password-screen" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--primary); z-index:5001; display:flex; justify-content:center; align-items:center;">
        <div class="login-card">
            <h2 style="color:var(--danger)">Seguridad</h2>
            <p>Primer acceso. Cambie su contrase√±a.</p>
            <input type="password" id="new-p1" placeholder="Nueva Contrase√±a">
            <input type="password" id="new-p2" placeholder="Repita Contrase√±a">
            <button class="btn-enter" onclick="window.App.changePass()">Guardar y Acceder</button>
            <p id="pass-msg" style="color:red; margin-top:10px;"></p>
        </div>
    </div>

    <div id="main-app">
        <div class="app-header"><img src="pie175PLSA.jpg" alt="Cabecera" onerror="this.style.display='none'"></div>
        <div class="top-bar">
            <span id="user-display"></span>
            <button class="btn-logout" onclick="location.reload()">Salir</button>
        </div>
        <div class="content-area">
            <div class="sidebar">
                <div class="sidebar-logo"><img src="escudoPLSA.jpg" alt="Escudo" onerror="this.style.display='none'"></div>
                <div class="menu-item active" onclick="window.App.nav('temario')"><i class="fas fa-book"></i> Temario</div>
                <div class="menu-item" onclick="window.App.nav('biblio')"><i class="fas fa-folder"></i> Documentaci√≥n</div>
                <div class="menu-item" onclick="window.App.nav('media')"><i class="fas fa-image"></i> Multimedia</div>
                <div class="menu-item" onclick="window.App.nav('flashcards')"><i class="fas fa-brain"></i> Tarjetas</div>
                <div class="menu-item" onclick="window.App.nav('test')"><i class="fas fa-check-circle"></i> Test</div>
                <div class="menu-item hidden" id="menu-admin" onclick="window.App.nav('admin')"><i class="fas fa-users-cog"></i> Gesti√≥n</div>
            </div>
            
            <div class="viewport">
                <div id="view-temario" class="view-section active">
                    <h2>Gu√≠a Operativa</h2>
                    <div id="doc-tabs" class="doc-nav"></div>
                    <div id="doc-content"></div>
                </div>

                <div id="view-biblio" class="view-section">
                    <h2>Biblioteca</h2>
                    <ul id="file-tree" style="list-style:none; padding:0;"></ul>
                </div>

                <div id="view-media" class="view-section">
                    <h2>Multimedia</h2>
                    <div id="media-container" class="media-grid"></div>
                    <div style="margin-top:20px; background:white; padding:20px; border-radius:8px;">
                        <h3>Audio Resumen</h3>
                        <audio id="main-audio" controls style="width:100%"></audio>
                    </div>
                </div>

                <div id="view-flashcards" class="view-section">
                    <h2 style="text-align:center">Entrenamiento (30 Aleatorias)</h2>
                    <div class="fc-wrapper">
                        <div id="fc-canvas" class="fc-container"></div>
                        <div class="fc-controls">
                            <button class="btn-fc btn-prev" onclick="window.App.moveFC(-1)">Anterior</button>
                            <span id="fc-count" style="align-self:center; font-weight:bold;"></span>
                            <button class="btn-fc btn-next" onclick="window.App.moveFC(1)">Siguiente</button>
                        </div>
                    </div>
                </div>

                <div id="view-test" class="view-section">
                    <h2>Evaluaci√≥n (20 Aleatorias)</h2>
                    <div id="test-container"></div>
                    <button class="btn-enter" style="width:auto; margin-top:20px;" onclick="window.App.submitTest()">Corregir Test</button>
                    <div id="test-result" style="margin-top:20px; font-weight:bold; font-size:1.2rem; text-align:center;"></div>
                </div>

                <div id="view-admin" class="view-section">
                    <h2>Panel de Gesti√≥n (CLOUD)</h2>
                    
                    <div id="admin-tools">
                        <div style="background:white; padding:20px; border-radius:8px; margin-bottom:20px;">
                            <h3>A√±adir Usuario</h3>
                            <input type="text" id="new-u" placeholder="Usuario" style="width:100%; padding:8px; margin-bottom:5px;">
                            <input type="text" id="new-p" placeholder="Clave" style="width:100%; padding:8px; margin-bottom:5px;">
                            <select id="new-r" style="width:100%; padding:8px; margin-bottom:5px;">
                                <optgroup label="Agentes">
                                    <option value="adc">Agente DC</option>
                                    <option value="adt">Agente DT</option>
                                    <option value="aut">Agente UT</option>
                                </optgroup>
                                <optgroup label="Mandos (Jefes de Equipo)">
                                    <option value="mdc">Mando Calle (MDC)</option>
                                    <option value="mdt">Mando Territorial (MDT)</option>
                                    <option value="mut">Mando T√©cnico (MUT)</option>
                                </optgroup>
                                <optgroup label="Direcci√≥n">
                                    <option value="jef">Jefatura (JEF)</option>
                                    <option value="admin">Administrador</option>
                                    <option value="master">MASTER</option>
                                </optgroup>
                            </select>
                            <select id="new-b" style="width:100%; padding:8px; margin-bottom:10px; background:#f0f7ff;">
                                <option value="">-- Asignar Jefe --</option>
                            </select>
                            <button class="btn-enter" onclick="window.App.addUser()">Crear Usuario</button>
                        </div>
                        
                        <div style="background:white; padding:20px; border-radius:8px; margin-bottom:20px;">
                            <h3>Importar Excel</h3>
                            <textarea id="import-data" class="import-area" placeholder="Usuario | Clave | Rol | Jefe"></textarea>
                            <button class="btn-enter" style="background:#27ae60;" onclick="window.App.importUsers()">Importar Masivo</button>
                            <p id="import-msg" style="color:green; font-weight:bold;"></p>
                        </div>
                    </div>

                    <h3>Resultados Acad√©micos</h3>
                    <table class="admin-table">
                        <thead><tr><th>Usuario</th><th>Rol</th><th>Fecha</th><th>Nota</th><th>Fallos</th><th>Mando Asignado</th></tr></thead>
                        <tbody id="admin-logs"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, setDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- TUS CLAVES DE FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyAYhB2TFiyT2N0Fob37fwwIzuru_L5fOAA",
      authDomain: "plsa-formacion-c2e68.firebaseapp.com",
      projectId: "plsa-formacion-c2e68",
      storageBucket: "plsa-formacion-c2e68.firebasestorage.app",
      messagingSenderId: "502759440918",
      appId: "1:502759440918:web:7d3269ed04db54b2b2ab37"
    };

    // INICIALIZAR FIREBASE
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- DATOS COMPLETOS (COPIADOS DE TU HTML ORIGINAL) ---
    const DB = {
        audio_url: "audio.m4a",
        imagenes: [
            {nombre: "Infograf√≠a Estructura (Clic para ver)", url: "estructura.png"},
            {nombre: "Mapa Mental Protocolo (Clic para ver)", url: "mapa.png"}
        ],
        bibliografia: [
            {nivel: "Normativa", archivos: [{nombre:"OJ-PROTOCOLO-ACTUACION-SALAMANCA-FIRMADO (1).pdf", desc:"Protocolo Actuaci√≥n"}, {nombre:"Anexo-I-Manual-de-Organizacion-Salamanca-firmado.pdf", desc:"Manual Organizaci√≥n"}]},
            {nivel: "Manuales", archivos: [{nombre:"Anexo-II-Manual-del-SCT-Salamanca-firmado.pdf", desc:"Manual SCT"}, {nombre:"Anexo-III-Manual-del-SCG-Salamanca-firmado - copia.pdf", desc:"Manual SCG"}, {nombre:"Anexo-IV-Manual-SCEJ-Salamanca-firmado - copia.pdf", desc:"Manual SCEJ"}]}
        ],
        secciones_temario: [
          { "titulo": "1. Introducci√≥n", "contenido": "<h3>1. Introducci√≥n: La transformaci√≥n del sistema judicial en Salamanca</h3><p>El presente documento tiene como finalidad servir de manual operativo...</p><p>Este modelo, que entrar√° en vigor el <strong>31 de diciembre de 2025</strong>, deriva de la Ley Org√°nica 1/2025...</p>" },
          { "titulo": "2. Visi√≥n General", "contenido": "<h3>2. Visi√≥n general de la nueva Oficina Judicial (OJ)</h3><p>La nueva OJ redefine completamente la relaci√≥n funcional...</p><h4>2.1 El Tribunal de Instancia (TI)</h4><p>Integra en una √∫nica estructura todas las anteriores plazas judiciales...</p>" },
          { "titulo": "3. Servicios Comunes", "contenido": "<h3>2.2 Los Servicios Comunes</h3><p>La Oficina Judicial se estructura en tres Servicios Comunes...</p><table class='doc-table'><tr><th>Servicio Com√∫n</th><th>Acr√≥nimo</th><th>Funci√≥n principal</th></tr><tr><td>Servicio Com√∫n General</td><td>SCG</td><td>Punto √∫nico de entrada...</td></tr><tr><td>Servicio Com√∫n de Tramitaci√≥n</td><td>SCT</td><td>Gesti√≥n integral...</td></tr><tr><td>Servicio Com√∫n de Ejecuci√≥n</td><td>SCEJ</td><td>Ejecuci√≥n...</td></tr></table>" },
          { "titulo": "4. Gu√≠a Operativa", "contenido": "<h3>3. Gu√≠a operativa</h3><h4>3.1 Inicio del procedimiento</h4><p>Principio fundamental: Todo documento policial tiene un √∫nico punto de entrada ordinario: el <strong>Servicio Com√∫n General (SCG)</strong>.</p>" },
          { "titulo": "5. Guardia", "contenido": "<h4>3.2 Interacci√≥n con el Servicio de Guardia (GU)</h4><p>El Servicio de Guardia constituye una excepci√≥n... Atestados con persona detenida, Solicitudes urgentes...</p>" },
          { "titulo": "6. Polic√≠a Judicial", "contenido": "<h3>4. Manual avanzado para agentes</h3><h4>4.1 Servicio Com√∫n de Tramitaci√≥n (SCT) ‚Äì √Årea Penal</h4><p>El SCT Penal gestiona los procedimientos penales desde el inicio hasta la firmeza.</p>" },
          { "titulo": "7. Unidades Espec.", "contenido": "<h4>4.2 Unidades especializadas (S4M)</h4><ul><li>Violencia sobre la Mujer</li><li>Menores</li><li>Familia, Infancia y Capacidad</li></ul>" },
          { "titulo": "8. Ejecuci√≥n", "contenido": "<h4>4.3 Fase de ejecuci√≥n: SCEJ ‚Äì √Årea Penal</h4><p>Una vez firme la sentencia, la competencia pasa al SCEJ...</p>" },
          { "titulo": "9. Mandos", "contenido": "<h3>5. Pautas para la escala t√©cnica</h3><h4>5.1 Estructura de mando</h4><p>Director/a (LAJ), Jefatura de √Årea, Jefatura de Equipo...</p>" },
          { "titulo": "10. Protocolos", "contenido": "<h3>6. Instrucci√≥n interna</h3><p>Obligatoria y vinculante. Entrada en vigor 31/12/2025...</p>" }
        ],
        flashcards: [
            { "front": "¬øFecha de entrada en vigor de la Nueva OJ?", "back": "31 de diciembre de 2025" },
            { "front": "¬øLey que impulsa la transformaci√≥n?", "back": "Ley Org√°nica 1/2025" },
            { "front": "¬øQu√© √≥rgano sustituye a los juzgados individuales?", "back": "El Tribunal de Instancia (TI)" },
            { "front": "¬øCu√°l es el punto √∫nico de entrada de documentos ordinarios?", "back": "El Servicio Com√∫n General (SCG)" },
            { "front": "¬øHorario de recepci√≥n del SCG?", "back": "Lunes a viernes laborables, 08:30 a 15:00" },
            { "front": "¬øD√≥nde se entregan atestados con DETENIDO?", "back": "Directamente al Servicio de Guardia (GU)" },
            { "front": "¬øD√≥nde van las solicitudes urgentes de entradas y registros?", "back": "Al Servicio de Guardia (GU)" },
            { "front": "¬øQu√© servicio gestiona la fase de Instrucci√≥n?", "back": "SCT (Servicio Com√∫n de Tramitaci√≥n) - √Årea Penal" },
            { "front": "¬øQu√© servicio gestiona la ejecuci√≥n de sentencias firmes?", "back": "SCEJ (Servicio Com√∫n de Ejecuci√≥n)" },
            { "front": "¬øQui√©n dirige un Servicio Com√∫n (M√°xima autoridad)?", "back": "El Director/a del Servicio (LAJ)" },
            { "front": "¬øQui√©n resuelve un error de datos en un escrito?", "back": "La Jefatura de Equipo de la unidad tramitadora" },
            { "front": "¬øQui√©n resuelve una devoluci√≥n por reparto incorrecto?", "back": "La Jefatura de Equipo (se devuelve al equipo de inicio)" },
            { "front": "¬øQu√© hacer con un documento no registrado?", "back": "Remitirlo al equipo de inicio para su registro oficial" },
            { "front": "¬øQu√© unidad gestiona Violencia sobre la Mujer?", "back": "Grupo de Trabajo Instrucci√≥n n¬∫ 3" },
            { "front": "¬øQu√© unidad gestiona Menores (enjuiciamiento y ejecuci√≥n)?", "back": "SCT - Equipo de Enjuiciamiento (Secci√≥n Menores)" },
            { "front": "¬øQui√©n gestiona internamientos no voluntarios?", "back": "SCT Civil - Negociado de familia" },
            { "front": "¬øQu√© servicio tramita una orden de busca y captura POST-sentencia?", "back": "SCEJ (Ejecuci√≥n)" },
            { "front": "¬øQu√© servicio realiza la averiguaci√≥n patrimonial?", "back": "SCEJ (Ejecuci√≥n)" },
            { "front": "¬øPrincipal √≥rgano estrat√©gico de la OJ?", "back": "Comit√© de Direcci√≥n" },
            { "front": "¬øQui√©n compone el Comit√© de Direcci√≥n?", "back": "Direcci√≥n, Jefaturas de √Årea y Jefaturas de Equipo" },
            { "front": "¬øPlataforma de comunicaci√≥n con operadores?", "back": "LexNet" },
            { "front": "¬øSistema de gesti√≥n procesal interno?", "back": "Atenea" },
            { "front": "¬øForma preferente de presentaci√≥n de atestados?", "back": "Telem√°tica" },
            { "front": "¬øQui√©n gestiona los juicios por delitos leves?", "back": "Grupos de Trabajo de Delitos Leves (SCT)" },
            { "front": "¬øQui√©n coordina un √Årea dentro de un servicio?", "back": "Jefatura de √Årea (LAJ o GPA)" },
            { "front": "¬øFunci√≥n principal del SCG?", "back": "Registro, reparto, actos de comunicaci√≥n, archivo y dep√≥sito" },
            { "front": "¬øQu√© equipo del SCG realiza notificaciones en calle?", "back": "Equipo 2: Servicios Transversales (Actos de Comunicaci√≥n)" },
            { "front": "¬øQui√©n gestiona el Dep√≥sito de Efectos Judiciales?", "back": "SCG - Equipo 2" },
            { "front": "¬øQu√© grupo gestiona el Apud-Acta?", "back": "Grupo de Trabajo de Apud-Actas (Equipo 1 SCG)" },
            { "front": "¬øQu√© significa SCT?", "back": "Servicio Com√∫n de Tramitaci√≥n" },
            { "front": "¬øEl SCT de la Audiencia Provincial es independiente?", "back": "S√≠, existe un SCT para el TI y otro para la AP" },
            { "front": "¬øQu√© significa SCEJ?", "back": "Servicio Com√∫n de Ejecuci√≥n" },
            { "front": "¬øQui√©n tramita las subastas judiciales?", "back": "SCEJ" },
            { "front": "¬øQui√©n gestiona la Cuenta de Dep√≥sitos y Consignaciones?", "back": "SCEJ" },
            { "front": "¬øQu√© significa OJM?", "back": "Oficinas de Justicia en el Municipio (Sustituyen Juzgados Paz)" },
            { "front": "¬øD√≥nde se publicita el protocolo?", "back": "Punto de Acceso General de la Administraci√≥n de Justicia (PAGAJ)" },
            { "front": "¬øQui√©n cuida la aplicaci√≥n de protecci√≥n de datos?", "back": "El titular de la Direcci√≥n de cada servicio com√∫n" },
            { "front": "¬øNormativa de protecci√≥n de datos aplicable?", "back": "LOPJ, Reglamento (UE) 2016/679 y LO 3/2018" },
            { "front": "¬øCar√°cter del protocolo?", "back": "Normativo, flexible y din√°mico" },
            { "front": "¬øSistema para videoconferencias?", "back": "EVID" },
            { "front": "¬øFrecuencia control cuentas consignaci√≥n?", "back": "Trimestral" },
            { "front": "¬øQui√©n propone el r√©gimen de sustituciones en SCT?", "back": "La Jefatura de √Årea" },
            { "front": "¬øHorario atenci√≥n al p√∫blico general?", "back": "09:00 a 14:00 (Verificar protocolo espec√≠fico)" },
            { "front": "¬øA qui√©n se comunica la entrada en vigor?", "back": "Sala Gobierno TSJ, Fiscal√≠a, Colegios, Gerencia, etc." },
            { "front": "¬øNivel 4 de organizaci√≥n interna?", "back": "Unidades Funcionales" },
            { "front": "¬øNivel 1 de organizaci√≥n interna?", "back": "Equipos" },
            { "front": "¬øQui√©n firma el protocolo?", "back": "Secretario Coordinador Provincial y Secretario de Gobierno TSJ" },
            { "front": "¬øUbicaci√≥n personal funcionario?", "back": "Puestos de trabajo pr√≥ximos por equipos" },
            { "front": "¬øQui√©n gestiona el Archivo Judicial de Gesti√≥n?", "back": "SCG - Equipo 2" },
            { "front": "¬øRegistro electr√≥nico habilitado?", "back": "Registro SIR" },
            { "front": "¬øObjetivo de las OJM?", "back": "Acercar la justicia al ciudadano en municipios sin sede TI" },
            { "front": "¬øQui√©n dirige t√©cnico-procesalmente la oficina?", "back": "El Letrado de la Admon. de Justicia (LAJ)" },
            { "front": "¬øQu√© es la UPAD?", "back": "Unidad Procesal de Apoyo Directo al Juez" },
            { "front": "¬øQu√© es un SCP?", "back": "Servicio Com√∫n Procesal (Transversal)" },
            { "front": "¬øPlazo detenci√≥n policial m√°xima?", "back": "72 horas (Constituci√≥n)" },
            { "front": "¬øPlazo Habeas Corpus?", "back": "Resoluci√≥n en 24 horas" },
            { "front": "¬øQui√©n instruye causas con aforados?", "back": "Tribunales Superiores (TSJ / Supremo)" },
            { "front": "¬øQu√© es el PNJ?", "back": "Punto Neutro Judicial (Base de datos)" },
            { "front": "¬øQui√©n autoriza el levantamiento de cad√°ver?", "back": "Juez de Guardia (con M√©dico Forense)" },
            { "front": "¬øD√≥nde se notifican resoluciones a la Polic√≠a?", "back": "A trav√©s de la unidad de enlace / Gesti√≥n" },
            { "front": "¬øQu√© es un exhorto?", "back": "Comunicaci√≥n entre √≥rganos judiciales" },
            { "front": "¬øQu√© es un mandamiento?", "back": "Orden judicial a registrador, funcionario o polic√≠a" },
            { "front": "¬øQu√© es una providencia?", "back": "Resoluci√≥n judicial de tr√°mite (Juez)" },
            { "front": "¬øQu√© es una diligencia de ordenaci√≥n?", "back": "Resoluci√≥n de impulso procesal (LAJ)" },
            { "front": "¬øQu√© es un Decreto?", "back": "Resoluci√≥n finalizadora o de admisi√≥n del LAJ" },
            { "front": "¬øRecurso contra Providencia?", "back": "Recurso de Reforma" },
            { "front": "¬øQui√©n hace la tasaci√≥n de costas?", "back": "El LAJ" },
            { "front": "¬øQu√© es el turno de oficio?", "back": "Justicia Gratuita (Abogados designados)" },
            { "front": "¬øQui√©n custodia los expedientes activos?", "back": "El servicio tramitador (SCT/SCEJ)" },
            { "front": "¬øQui√©n custodia los expedientes archivados?", "back": "El Archivo (SCG)" },
            { "front": "¬øQu√© es el SIRAJ?", "back": "Sistema de Registros Administrativos de Apoyo a la Admon. Justicia" },
            { "front": "¬øQu√© se inscribe en el Registro Central de Penados?", "back": "Sentencias firmes condenatorias" },
            { "front": "¬øQui√©n expide la orden de alejamiento?", "back": "El Juez (Auto de medidas cautelares)" },
            { "front": "¬øQu√© es un juicio 'in voce'?", "back": "Sentencia dictada oralmente en el acto" },
            { "front": "¬øPlazo para recurrir en apelaci√≥n (general penal)?", "back": "10 d√≠as" },
            { "front": "¬øQu√© es la conformidad?", "back": "Acusado reconoce hechos y acepta pena reducida" },
            { "front": "¬øQui√©n asiste al levantamiento de cad√°ver si no va el Juez?", "back": "El LAJ (por delegaci√≥n) y el Forense" },
            { "front": "¬øQu√© es el 'reparto'?", "back": "Distribuci√≥n de asuntos entre juzgados (SCG)" },
            { "front": "¬øQu√© es una pieza separada?", "back": "Expediente paralelo para un tema concreto (ej. situaci√≥n personal)" },
            { "front": "¬øQu√© es el 'secreto de sumario'?", "back": "Restricci√≥n de acceso a las partes (no al Fiscal)" },
            { "front": "¬øQui√©n solicita la prisi√≥n provisional?", "back": "Fiscal o Acusaci√≥n Particular (nunca el Juez de oficio)" },
            { "front": "¬øM√°ximo prisi√≥n provisional (regla general)?", "back": "1 a√±o (delitos < 9 a√±os) o 2 a√±os (delitos > 9 a√±os)" },
            { "front": "¬øQu√© es la fianza 'pudendo'?", "back": "Fianza para asegurar la libertad provisional" },
            { "front": "¬øQu√© es la responsabilidad civil?", "back": "Indemnizaci√≥n econ√≥mica por el delito" },
            { "front": "¬øQui√©n ejecuta la pena de trabajos en beneficio comunidad?", "back": "Servicios de Gesti√≥n de Penas (Instituciones Penitenciarias)" },
            { "front": "¬øQu√© es el 'expurgo'?", "back": "Destrucci√≥n de expedientes antiguos sin valor" },
            { "front": "¬øQu√© es un 'lanzamiento'?", "back": "Desahucio forzoso de un inmueble" },
            { "front": "¬øQui√©n acompa√±a a la Comisi√≥n Judicial?", "back": "Agentes de la autoridad (si se solicita auxilio)" },
            { "front": "¬øQu√© es la 'averiguaci√≥n patrimonial'?", "back": "B√∫squeda de bienes del condenado (PNJ)" },
            { "front": "¬øQu√© es una requisitoria?", "back": "Orden de busca y captura" },
            { "front": "¬øQu√© es la rebeld√≠a procesal?", "back": "Ausencia injustificada del acusado" },
            { "front": "¬øCu√°ndo prescribe una falta (delito leve)?", "back": "Al a√±o" },
            { "front": "¬øCu√°ndo prescribe un delito grave (general)?", "back": "A los 20 a√±os (si pena > 15 a√±os)" },
            { "front": "¬øQu√© es el 'habeas corpus'?", "back": "Procedimiento por detenci√≥n ilegal" },
            { "front": "¬øAnte qui√©n se pide el habeas corpus?", "back": "Juez de Instrucci√≥n del lugar" },
            { "front": "¬øEs obligatorio abogado en habeas corpus?", "back": "No" },
            { "front": "¬øQu√© es la LECrim?", "back": "Ley de Enjuiciamiento Criminal" },
            { "front": "¬øQu√© es la LOPJ?", "back": "Ley Org√°nica del Poder Judicial" },
            { "front": "¬øQu√© es el EVID?", "back": "Sistema de Grabaci√≥n de Vistas" },
            { "front": "¬øQu√© es la firma digital?", "back": "Autenticaci√≥n electr√≥nica de documentos" },
            { "front": "¬øQui√©n nombra a los peritos judiciales?", "back": "El √≥rgano judicial (por listas o sorteo)" },
            { "front": "¬øSe pueden usar USB en equipos judiciales?", "back": "No, est√° prohibido por seguridad inform√°tica" }
        ],
        test: [
            { "pregunta": "¬øCu√°l es la 'puerta √∫nica' de entrada para documentaci√≥n ordinaria?", "respuestas": ["Decanato", "SCG (Servicio Com√∫n General)", "SCT Penal"], "correcta": 1 },
            { "pregunta": "¬øHasta qu√© hora se pueden presentar atestados en el SCG?", "respuestas": ["14:00", "15:00", "24 horas"], "correcta": 1 },
            { "pregunta": "¬øD√≥nde se entrega un atestado con DETENIDO?", "respuestas": ["SCG", "Servicio de Guardia (GU)", "SCT"], "correcta": 1 },
            { "pregunta": "¬øQu√© servicio gestiona la fase de instrucci√≥n?", "respuestas": ["SCT (Tramitaci√≥n)", "SCEJ (Ejecuci√≥n)", "SCG"], "correcta": 0 },
            { "pregunta": "¬øQu√© servicio ejecuta una sentencia firme de prisi√≥n?", "respuestas": ["SCT", "SCEJ (Ejecuci√≥n)", "Servicio de Guardia"], "correcta": 1 },
            { "pregunta": "¬øQui√©n es la m√°xima autoridad funcional de un Servicio Com√∫n?", "respuestas": ["El Juez Decano", "El Director/a del Servicio (LAJ)", "El Gestor Procesal"], "correcta": 1 },
            { "pregunta": "¬øQu√© unidad lleva los casos de Violencia de G√©nero?", "respuestas": ["Grupo Instrucci√≥n n¬∫ 3", "Secci√≥n de Menores", "SCG"], "correcta": 0 },
            { "pregunta": "¬øQui√©n resuelve un error en el DNI de un atestado?", "respuestas": ["Se devuelve a comisar√≠a", "Jefatura de Equipo de la unidad tramitadora", "El Decanato"], "correcta": 1 },
            { "pregunta": "¬øQu√© ocurre si presentas un documento sin registrar?", "respuestas": ["Se archiva", "Se devuelve al equipo de inicio para registro", "Se procesa igual"], "correcta": 1 },
            { "pregunta": "¬øQui√©n realiza las notificaciones en la calle?", "respuestas": ["Polic√≠a Local", "SCG (Actos de Comunicaci√≥n)", "SCT"], "correcta": 1 },
            { "pregunta": "¬øD√≥nde se tramitan los delitos leves?", "respuestas": ["Grupos de Trabajo de Delitos Leves (SCT)", "SCEJ", "Juzgados de Paz"], "correcta": 0 },
            { "pregunta": "¬øQui√©n gestiona la averiguaci√≥n patrimonial para embargos?", "respuestas": ["SCT", "SCEJ", "SCG"], "correcta": 1 },
            { "pregunta": "¬øQu√© √≥rgano decide las estrategias de la OJ?", "respuestas": ["Comit√© de Direcci√≥n", "Junta de Personal", "Sindicatos"], "correcta": 0 },
            { "pregunta": "¬øQu√© ley regula la NOJ de Salamanca?", "respuestas": ["LO 1/2025", "LECrim", "Ley de Enjuiciamiento Civil"], "correcta": 0 },
            { "pregunta": "¬øLas solicitudes de entrada y registro urgentes van a...?", "respuestas": ["SCG", "Servicio de Guardia", "SCT"], "correcta": 1 },
            { "pregunta": "¬øQui√©n gestiona el Dep√≥sito de Efectos Judiciales?", "respuestas": ["SCG", "SCT", "Polic√≠a Cient√≠fica"], "correcta": 0 },
            { "pregunta": "¬øQu√© sustituye a los Juzgados de Paz?", "respuestas": ["OJM (Oficinas de Justicia en el Municipio)", "Ayuntamientos", "Registros Civiles"], "correcta": 0 },
            { "pregunta": "¬øCu√°ndo entra en vigor el modelo?", "respuestas": ["31/12/2025", "01/01/2026", "Inmediatamente"], "correcta": 0 },
            { "pregunta": "¬øEl Tribunal de Instancia sustituye a...?", "respuestas": ["La Audiencia Provincial", "Los juzgados unipersonales", "El Tribunal Supremo"], "correcta": 1 },
            { "pregunta": "¬øC√≥mo se llama el sistema de gesti√≥n procesal?", "respuestas": ["Atenea", "LexNet", "Siraj"], "correcta": 0 },
            { "pregunta": "¬øQui√©n realiza el reparto de asuntos?", "respuestas": ["El Juez Decano", "El SCG", "El SCT"], "correcta": 1 },
            { "pregunta": "¬øQu√© servicio tramita un divorcio contencioso?", "respuestas": ["SCT Civil", "SCEJ", "SCG"], "correcta": 0 },
            { "pregunta": "¬øQui√©n coordina a los equipos de un servicio?", "respuestas": ["Jefatura de √Årea", "Jefatura de Equipo", "Direcci√≥n"], "correcta": 0 },
            { "pregunta": "¬øD√≥nde se ubica la Secci√≥n de Menores?", "respuestas": ["SCT Penal - Enjuiciamiento", "SCT Civil", "SCEJ"], "correcta": 0 },
            { "pregunta": "¬øQui√©n firma los mandamientos de prisi√≥n?", "respuestas": ["El Juez/Magistrado", "El LAJ", "El Gestor"], "correcta": 0 },
            { "pregunta": "¬øQu√© es el PAGAJ?", "respuestas": ["Punto de Acceso General de la Admon. Justicia", "Un sindicato", "Un juzgado"], "correcta": 0 },
            { "pregunta": "¬øQui√©n asume las competencias de los antiguos Secretarios Judiciales?", "respuestas": ["LAJ (Letrados de la Admon. Justicia)", "Jueces", "Fiscales"], "correcta": 0 },
            { "pregunta": "¬øEl Servicio de Guardia funciona las 24h?", "respuestas": ["S√≠", "No, solo ma√±anas", "Solo fines de semana"], "correcta": 0 },
            { "pregunta": "¬øQui√©n gestiona la agenda de se√±alamientos?", "respuestas": ["SCT", "SCG", "SCEJ"], "correcta": 0 },
            { "pregunta": "¬øQu√© pasa si un atestado va al SCT sin pasar por SCG?", "respuestas": ["Se devuelve a SCG para registro", "Se tramita igual", "Se archiva"], "correcta": 0 },
            { "pregunta": "¬øQui√©n custodia las grabaciones de los juicios?", "respuestas": ["LAJ", "Polic√≠a", "Juez"], "correcta": 0 },
            { "pregunta": "¬øQu√© servicio lleva la ejecuci√≥n de penas de multa?", "respuestas": ["SCEJ", "SCT", "Hacienda"], "correcta": 0 },
            { "pregunta": "¬øQu√© es la fase declarativa?", "respuestas": ["Desde inicio hasta sentencia firme", "Solo el juicio", "La ejecuci√≥n"], "correcta": 0 },
            { "pregunta": "¬øQui√©n resuelve dudas sobre protecci√≥n de datos?", "respuestas": ["Director del Servicio Com√∫n", "Jefe de Polic√≠a", "Delegado del Gobierno"], "correcta": 0 },
            { "pregunta": "¬øLas OJM dependen funcionalmente de...?", "respuestas": ["La Oficina Judicial", "El Ayuntamiento", "La Comunidad Aut√≥noma"], "correcta": 0 },
            { "pregunta": "¬øQui√©n dirige al personal funcionario en el d√≠a a d√≠a?", "respuestas": ["Jefatura de Equipo", "Juez", "Fiscal"], "correcta": 0 },
            { "pregunta": "¬øD√≥nde se solicitan los antecedentes penales?", "respuestas": ["Gerencia Territorial / SCG", "Comisar√≠a", "Ayuntamiento"], "correcta": 0 },
            { "pregunta": "¬øQui√©n realiza el expurgo de expedientes?", "respuestas": ["Junta de Expurgo / SCG Archivo", "Empresa de limpieza", "Polic√≠a"], "correcta": 0 },
            { "pregunta": "¬øQu√© es SIR?", "respuestas": ["Sistema de Interconexi√≥n de Registros", "Sistema Interno R√°pido", "Servicio Integral"], "correcta": 0 },
            { "pregunta": "¬øEl TI tiene presidente?", "respuestas": ["S√≠", "No", "Depende del tama√±o"], "correcta": 0 },
            { "pregunta": "¬øQui√©n gestiona la caja de dep√≥sitos?", "respuestas": ["SCEJ", "Banco Santander", "SCG"], "correcta": 0 },
            { "pregunta": "¬øQu√© ley modifica la planta judicial?", "respuestas": ["LO 1/2025", "Constituci√≥n", "Estatuto Autonom√≠a"], "correcta": 0 },
            { "pregunta": "¬øQui√©n asiste a la Comisi√≥n Judicial en lanzamientos?", "respuestas": ["SCG - Actos de Comunicaci√≥n", "SCT", "SCEJ"], "correcta": 0 },
            { "pregunta": "¬øQui√©n gestiona las videoconferencias con prisiones?", "respuestas": ["SCG / SCT seg√∫n fase", "Polic√≠a", "Director Prisi√≥n"], "correcta": 0 },
            { "pregunta": "¬øEs obligatorio el uso de medios telem√°ticos para Polic√≠a?", "respuestas": ["S√≠", "No", "Solo para delitos graves"], "correcta": 0 },
            { "pregunta": "¬øQui√©n controla el cumplimiento de penas de trabajos en beneficio de la comunidad?", "respuestas": ["SCEJ / Servicios Sociales Penitenciarios", "SCT", "Polic√≠a Local"], "correcta": 0 },
            { "pregunta": "¬øQu√© pasa con los Juzgados de Paz?", "respuestas": ["Se transforman en OJM", "Desaparecen sin m√°s", "Se mantienen igual"], "correcta": 0 },
            { "pregunta": "¬øQui√©n coordina a los m√©dicos forenses?", "respuestas": ["Director IML", "Juez Decano", "Comisario"], "correcta": 0 },
            { "pregunta": "¬øD√≥nde se presentan las denuncias por particulares?", "respuestas": ["SCG o Comisar√≠a", "SCT", "SCEJ"], "correcta": 0 },
            { "pregunta": "¬øCu√°l es el objetivo principal de la NOJ?", "respuestas": ["Agilidad y eficiencia", "Ahorrar papel", "Contratar m√°s gente"], "correcta": 0 },
            { "pregunta": "¬øQu√© principio rige la actuaci√≥n de los Servicios Comunes Procesales?", "respuestas": ["Independencia absoluta", "Jerarqu√≠a y unidad de actuaci√≥n", "Autonom√≠a de cada funcionario"], "correcta": 1 },
            { "pregunta": "¬øQui√©n es el responsable de la direcci√≥n t√©cnico-procesal del SCT?", "respuestas": ["El Juez Decano", "El LAJ Director", "El Fiscal Jefe"], "correcta": 1 },
            { "pregunta": "¬øA qu√© servicio corresponde la expedici√≥n de certificaciones sobre asuntos archivados?", "respuestas": ["SCG", "SCT", "Decanato"], "correcta": 0 },
            { "pregunta": "¬øC√≥mo se denominan las unidades que prestan soporte a varios √≥rganos judiciales?", "respuestas": ["Unidades Procesales de Apoyo Directo (UPAD)", "Servicios Comunes Procesales (SCP)", "Juzgados Bis"], "correcta": 1 },
            { "pregunta": "¬øQui√©n autoriza la entrada y registro en un domicilio en fase de instrucci√≥n?", "respuestas": ["El LAJ", "El Juez de Instrucci√≥n / Guardia", "El Comisario"], "correcta": 1 },
            { "pregunta": "¬øQu√© ocurre con las piezas de convicci√≥n t√≥xicas o peligrosas?", "respuestas": ["Se guardan en el despacho del Juez", "Se sigue un protocolo especial de destrucci√≥n/custodia", "Se entregan al denunciante"], "correcta": 1 },
            { "pregunta": "¬øEl Servicio Com√∫n de Ejecuci√≥n (SCEJ) puede realizar lanzamientos?", "respuestas": ["No, eso es del SCG", "S√≠, a trav√©s de sus funcionarios o comisi√≥n", "Solo si va el Juez"], "correcta": 1 },
            { "pregunta": "¬øD√≥nde se presentan los escritos de mero tr√°mite?", "respuestas": ["Directamente al Juez", "En el SCG (Registro)", "En Comisar√≠a"], "correcta": 1 },
            { "pregunta": "¬øQu√© sistema se utiliza para el embargo telem√°tico de cuentas?", "respuestas": ["Punto Neutro Judicial", "Google Pay", "Agencia Tributaria Directa"], "correcta": 0 },
            { "pregunta": "¬øQui√©n es el superior jer√°rquico del Cuerpo de Auxilio Judicial en la OJ?", "respuestas": ["El Gestor Procesal", "El LAJ Director del Servicio", "El Polic√≠a de la puerta"], "correcta": 1 },
            { "pregunta": "¬øQu√© servicio gestiona las Salas de Vistas?", "respuestas": ["SCT / SCG (seg√∫n protocolo)", "El servicio de limpieza", "Los abogados"], "correcta": 0 },
            { "pregunta": "¬øQui√©n notifica la sentencia al penado?", "respuestas": ["El Juez oralmente", "El SCG (Actos de Comunicaci√≥n)", "El abogado siempre"], "correcta": 1 },
            { "pregunta": "¬øCu√°l es el plazo para detener a una persona sin ponerla a disposici√≥n judicial?", "respuestas": ["72 horas m√°ximo", "24 horas", "48 horas"], "correcta": 0 },
            { "pregunta": "¬øLas citaciones a polic√≠as para juicios se hacen a trav√©s de...?", "respuestas": ["Tel√©fono personal", "Conducto reglamentario / Gesti√≥n Policial", "Correo postal ordinario"], "correcta": 1 },
            { "pregunta": "¬øQu√© es la Oficina de Atenci√≥n al Ciudadano/V√≠ctima?", "respuestas": ["Un servicio externo", "Una unidad dentro de la OJ/Fiscal√≠a", "Una ONG"], "correcta": 1 },
            { "pregunta": "¬øQui√©n decreta el secreto de sumario?", "respuestas": ["El LAJ", "El Juez de Instrucci√≥n", "La Polic√≠a Judicial"], "correcta": 1 },
            { "pregunta": "¬øA qui√©n corresponde la tasaci√≥n de costas?", "respuestas": ["Al Colegio de Abogados", "Al LAJ del servicio correspondiente", "Al Juez"], "correcta": 1 },
            { "pregunta": "¬øQu√© documento inicia el procedimiento de Habeas Corpus?", "respuestas": ["Una querella", "Una solicitud/escrito del detenido o tercero", "Un atestado ordinario"], "correcta": 1 },
            { "pregunta": "¬øD√≥nde se ubica f√≠sicamente el SCG de Salamanca?", "respuestas": ["En la Comisar√≠a Provincial", "En la sede principal de los Juzgados (Plaza Col√≥n/Gran V√≠a)", "En el Ayuntamiento"], "correcta": 1 },
            { "pregunta": "¬øQui√©n gestiona el turno de oficio?", "respuestas": ["El Colegio de Abogados", "El Juez Decano", "El SCG"], "correcta": 0 }
        ]
    };

    // --- L√ìGICA DE LA APP (CONECTADA A LA NUBE) ---
    const App = {
        data: DB,
        user: null,
        userDocId: null,

        init: async () => {
            // Listener para Enter en Login
            document.addEventListener('keyup', (e) => {
                if(e.key === 'Enter' && !document.getElementById('login-screen').classList.contains('hidden')) App.login();
            });

            // COMPROBACI√ìN INICIAL: SI NO HAY USUARIOS, CREAR MASTER AUTOM√ÅTICAMENTE
            try {
                const q = query(collection(db, "noj_users"), where("u", "==", "master"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    console.log("Inicializando base de datos con usuario master...");
                    await addDoc(collection(db, "noj_users"), { u:'master', p:'master', r:'master', boss:'', change:true });
                }
            } catch (e) { 
                console.error("Esperando conexi√≥n...", e); 
            }

            // BARAJAR Y SELECCIONAR (30 Flashcards, 20 Test)
            if(App.data.flashcards) App.sessionCards = App.shuffle([...App.data.flashcards]).slice(0, 30);
            if(App.data.test) App.sessionTest = App.shuffle([...App.data.test]).slice(0, 20);

            // RENDERIZAR TODO
            App.renderTemario();
            App.renderBiblio();
            App.renderMedia();
            App.renderFC();
            App.renderTest();
            if(document.getElementById('main-audio')) document.getElementById('main-audio').src = App.data.audio_url;
        },

        shuffle: (a) => { for(let i=a.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; },

        login: async () => {
            const u = document.getElementById('user').value.trim();
            const p = document.getElementById('pass').value.trim();
            const btn = document.getElementById('btn-login-action');
            const load = document.getElementById('loading-msg');
            
            if(!u || !p) return;

            btn.disabled = true;
            load.style.display = 'block';

            try {
                const q = query(collection(db, "noj_users"), where("u", "==", u), where("p", "==", p));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const docSnap = querySnapshot.docs[0];
                    App.user = docSnap.data();
                    App.userDocId = docSnap.id;

                    // Si requiere cambio de contrase√±a
                    if (App.user.change) {
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('password-screen').classList.remove('hidden');
                        return;
                    }
                    App.enterApp();
                } else {
                    document.getElementById('msg').innerText = "Credenciales incorrectas";
                }
            } catch (e) {
                console.error(e);
                document.getElementById('msg').innerText = "Error de conexi√≥n (Verifique internet)";
            } finally {
                btn.disabled = false;
                load.style.display = 'none';
            }
        },

        changePass: async () => {
            const p1 = document.getElementById('new-p1').value;
            const p2 = document.getElementById('new-p2').value;
            if(p1.length<4 || p1!==p2) return document.getElementById('pass-msg').innerText = "M√≠nimo 4 caracteres y deben coincidir";
            
            try {
                const userRef = doc(db, "noj_users", App.userDocId);
                await updateDoc(userRef, { p: p1, change: false });
                App.user.p = p1;
                document.getElementById('password-screen').classList.add('hidden');
                App.enterApp();
            } catch(e) { console.error(e); }
        },

        enterApp: () => {
            document.getElementById('login-screen').style.display='none';
            document.getElementById('main-app').style.display='flex';
            document.getElementById('user-display').innerText = App.user.u.toUpperCase();
            
            // Mostrar men√∫ admin si corresponde
            if(['admin','master','jef','mdc','mdt','mut'].includes(App.user.r)) { 
                document.getElementById('menu-admin').classList.remove('hidden'); 
                App.renderAdmin(); 
            }
        },

        renderTemario: () => {
            const t = document.getElementById('doc-tabs'), c = document.getElementById('doc-content'); t.innerHTML=''; c.innerHTML='';
            App.data.secciones_temario.forEach((s,i) => {
                t.innerHTML += `<button class="doc-tab ${i===0?'active':''}" onclick="window.App.tab(${i})">${s.titulo}</button>`;
                c.innerHTML += `<div id="p${i}" class="doc-page ${i===0?'active':''}">${s.contenido}</div>`;
            });
        },
        tab: (i) => {
            document.querySelectorAll('.doc-tab').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('.doc-page').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('.doc-tab')[i].classList.add('active');
            document.getElementById('p'+i).classList.add('active');
        },

        renderBiblio: () => { 
            const t = document.getElementById('file-tree'); t.innerHTML = ''; 
            App.data.bibliografia.forEach(c => { 
                let l = c.archivos.map(f => `<li style="margin-bottom:5px;"><a href="${f.nombre}" target="_blank" style="text-decoration:none; color:#0a2e5c;">üìÑ ${f.desc}</a></li>`).join(''); 
                t.innerHTML += `<li style="margin-bottom:15px;"><strong>${c.nivel}</strong><ul style="list-style:none; padding-left:10px;">${l}</ul></li>`; 
            }); 
        },

        renderMedia: () => {
            const c = document.getElementById('media-container'); c.innerHTML='';
            App.data.imagenes.forEach(i => c.innerHTML += `<div class="media-card" onclick="window.open('${i.url}','_blank')"><img src="${i.url}" onerror="this.src='//via.placeholder.com/300'"><p>${i.nombre}</p></div>`);
        },

        renderFC: () => { App.fcI=0; App.drawFC(); },
        drawFC: () => {
            if(!App.sessionCards || !App.sessionCards.length) return;
            const c = App.sessionCards[App.fcI];
            document.getElementById('fc-canvas').innerHTML = `<div class="fc-inner"><div class="fc-face fc-front"><div><i class="fas fa-question-circle fa-2x"></i><br><br>${c.front}</div></div><div class="fc-face fc-back"><div>${c.back}</div></div></div>`;
            document.getElementById('fc-canvas').onclick = function() { this.classList.toggle('fc-flipped'); };
            document.getElementById('fc-count').innerText = `${App.fcI+1} / ${App.sessionCards.length}`;
        },
        moveFC: (d) => {
            if(!App.sessionCards) return;
            App.fcI += d; 
            if(App.fcI < 0) App.fcI = App.sessionCards.length - 1;
            if(App.fcI >= App.sessionCards.length) App.fcI = 0;
            document.getElementById('fc-canvas').classList.remove('fc-flipped'); 
            setTimeout(() => App.drawFC(), 200);
        },

        renderTest: () => {
            if(!App.sessionTest) return;
            document.getElementById('test-container').innerHTML = App.sessionTest.map((q,i) => `<div class="q-block" data-c="${q.correcta}"><p><b>${i+1}. ${q.pregunta}</b></p>${q.respuestas.map(r => `<div class="quiz-option" onclick="window.App.selOpt(this)">${r}</div>`).join('')}</div>`).join('');
        },
        selOpt: (el) => {
            el.parentElement.querySelectorAll('.quiz-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
        },
        submitTest: async () => {
            let s = 0; 
            const blocks = document.querySelectorAll('.q-block');
            blocks.forEach(b => {
                const sel = b.querySelector('.selected'); const c = parseInt(b.dataset.c); const opts = b.querySelectorAll('.quiz-option');
                opts.forEach(o => o.classList.remove('correct','wrong'));
                if(sel) { if(Array.from(opts).indexOf(sel)===c) { sel.classList.add('correct'); s++; } else { sel.classList.add('wrong'); opts[c].classList.add('correct'); } }
            });
            document.getElementById('test-result').innerText = `Resultado: ${s} / ${blocks.length} Aciertos`;
            
            // GUARDAR LOG EN FIREBASE
            try {
                await addDoc(collection(db, "noj_logs"), {
                    u: App.user.u,
                    d: new Date().toLocaleString(),
                    s: s,
                    f: blocks.length - s,
                    timestamp: Date.now()
                });
            } catch(e) { console.error(e); }

            if(['admin','master','jef'].includes(App.user.r)) App.renderAdmin();
        },

        renderAdmin: async () => {
            const global = ['admin','master'].includes(App.user.r); 
            const jefatura = App.user.r === 'jef';
            
            // CARGAR USUARIOS
            let users = [];
            const uSnap = await getDocs(collection(db, "noj_users"));
            uSnap.forEach(d => users.push(d.data()));

            // CARGAR LOGS
            let logs = [];
            const lSnap = await getDocs(query(collection(db, "noj_logs"), orderBy("timestamp", "desc"), limit(50)));
            lSnap.forEach(d => logs.push(d.data()));

            const t = document.getElementById('admin-logs'); t.innerHTML='';

            if(!global && !jefatura) {
                // Si es un mando normal, ocultar herramientas de crear usuario
                document.getElementById('admin-tools').style.display='none';
            } else {
                // Si es global/jefatura, rellenar selector de jefes
                const bs = document.getElementById('new-b'); 
                bs.innerHTML = '<option value="">-- Asignar Jefe --</option>';
                users.filter(u => ['mdc','mdt','mut','jef'].includes(u.r)).forEach(b => { bs.innerHTML += `<option value="${b.u}">${b.u} (${b.r})</option>`; });
            }

            logs.forEach(l => {
                let show = false; 
                const uData = users.find(x => x.u === l.u); 
                const boss = uData ? uData.boss : '';
                
                // L√≥gica de visualizaci√≥n jer√°rquica
                if(global || jefatura) show = true; 
                else if(boss === App.user.u) show = true; // Solo veo a mis subordinados

                if(show) t.innerHTML += `<tr><td>${l.u}</td><td>${uData?uData.r:'?'}</td><td>${l.d}</td><td>${l.s}</td><td>${l.f}</td><td>${boss}</td></tr>`;
            });
        },

        addUser: async () => {
            const u = document.getElementById('new-u').value; const p = document.getElementById('new-p').value; const r = document.getElementById('new-r').value; const b = document.getElementById('new-b').value;
            
            if(!u || !p) return alert("Rellena usuario y clave");

            const q = query(collection(db, "noj_users"), where("u", "==", u));
            const check = await getDocs(q);
            if(!check.empty) return alert("Usuario existe");

            await addDoc(collection(db, "noj_users"), {u,p,r,boss:b, change:true});
            App.renderAdmin(); 
            alert("Usuario creado");
            document.getElementById('new-u').value='';
            document.getElementById('new-p').value='';
        },

        importUsers: async () => {
            const raw = document.getElementById('import-data').value;
            const map = {'AGENTE (DC)':'adc','AGENTE (DT)':'adt','AGENTE (UT)':'aut','MANDO (DC)':'mdc','MANDO (DT)':'mdt','MANDO (UT)':'mut','JEFATURA':'jef','ADMIN':'admin','MASTER':'master'};
            let c=0;
            const lines = raw.split('\n');
            
            for(let l of lines) {
                let p = l.split(/\t+/); if(p.length<2) p=l.split(/\s+/);
                if(p.length>=2) {
                    let r = map[p[2]] || 'adc';
                    const q = query(collection(db, "noj_users"), where("u", "==", p[0]));
                    const check = await getDocs(q);
                    if(check.empty) {
                        await addDoc(collection(db, "noj_users"), {u:p[0], p:p[1], r:r, boss:p[3]||'', change:true});
                        c++;
                    }
                }
            }
            document.getElementById('import-msg').innerText = `Importados: ${c}`; 
            App.renderAdmin();
        },
        nav: (id) => { document.querySelectorAll('.view-section').forEach(x=>x.classList.remove('active')); document.getElementById('view-'+id).classList.add('active'); }
    };

    // EXPORTAR AL OBJETO WINDOW
    window.App = App;
    window.onload = App.init;
</script>
</body>
</html>
