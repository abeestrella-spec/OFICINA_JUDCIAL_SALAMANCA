<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma FormaciÃ³n Policial - NOJ Salamanca (CLOUD V2)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #0a2e5c; --accent: #d4af37; --bg: #f4f7f9; --text: #333; --danger: #c0392b; --success: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; background: linear-gradient(rgba(10,46,92,0.9), rgba(10,46,92,0.9)), url('jefatura.jpg') no-repeat center center fixed; background-size: cover; display: flex; justify-content: center; align-items: center; }
        .login-card { background: white; padding: 40px; border-radius: 12px; width: 320px; text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.5); }
        .login-card img { width: 100px; margin-bottom: 20px; }
        .login-card input { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing:border-box; font-size: 16px; }
        .btn-enter { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 15px; }
        .btn-enter:disabled { background: #ccc; cursor: not-allowed; }
        
        /* APP LAYOUT */
        #main-app { display: none; height: 100%; flex-direction: column; }
        .app-header { background: white; padding: 10px; text-align: center; border-bottom: 4px solid #d4af37; flex-shrink: 0; }
        .app-header img { height: 80px; width: auto; max-width: 100%; } 
        .top-bar { background: var(--primary); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .btn-logout { background: #c0392b; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        .content-area { flex: 1; display: flex; overflow: hidden; }
        .sidebar { width: 260px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; }
        .sidebar-logo { text-align: center; padding: 20px; border-bottom: 1px solid #eee; background: #fdfdfd; }
        .sidebar-logo img { width: 120px; height: auto; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        
        .menu-item { padding: 15px; cursor: pointer; border-bottom: 1px solid #eee; color: #555; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background: #f0f4f8; color: var(--primary); border-left: 4px solid var(--primary); }
        .menu-item i { width: 25px; text-align: center; margin-right: 10px; }

        .viewport { flex: 1; padding: 30px; overflow-y: auto; background: #f4f7f9; position: relative; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }

        /* TEMARIO */
        .doc-nav { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 20px; }
        .doc-tab { padding: 10px; background: #e0e0e0; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.8rem; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .doc-tab.active { background: var(--primary); color: white; }
        .doc-page { display: none; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); line-height: 1.6; text-align: justify; }
        .doc-page.active { display: block; }
        .doc-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .doc-table th, .doc-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .doc-table th { background: #f1f1f1; }

        /* FLASHCARDS */
        .fc-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .fc-container { perspective: 1000px; height: 320px; width: 100%; max-width: 600px; cursor: pointer; position: relative; z-index: 1; }
        .fc-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .fc-flipped .fc-inner { transform: rotateY(180deg); }
        .fc-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; display: flex; align-items: center; justify-content: center; padding: 20px; text-align: center; border-radius: 15px; font-size: 1.3rem; box-sizing: border-box; background: white; border: 2px solid var(--primary); }
        .fc-front { background: var(--primary); color: white; z-index: 2; transform: rotateY(0deg); }
        .fc-back { transform: rotateY(180deg); color: #333; }
        .fc-controls { display: flex; gap: 20px; z-index: 10; margin-bottom: 50px; }
        .btn-fc { padding: 12px 30px; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; width: 140px; }
        .btn-prev { background: #c0392b; }
        .btn-next { background: #27ae60; }

        /* TEST */
        .quiz-option { padding: 15px; margin: 10px 0; background: white; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; display: flex; align-items: center; position: relative; z-index: 5; }
        .quiz-option:hover { background: #f9f9f9; }
        .quiz-option.selected { background: #e3f2fd; border-color: var(--primary); }
        .quiz-option.correct { background: #d4edda; border-color: green; }
        .quiz-option.wrong { background: #f8d7da; border-color: red; }

        /* ADMIN & UTILS */
        .admin-table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; font-size: 0.9rem; }
        .admin-table th, .admin-table td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        .admin-table th { background: #eee; }
        .import-area { width: 100%; height: 100px; padding: 10px; margin-top: 10px; font-family: monospace; font-size: 11px; }
        .media-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .media-card { background: white; padding: 15px; cursor: pointer; text-align: center; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .media-card:hover { transform: translateY(-5px); border: 2px solid var(--primary); }
        .media-card img { max-width: 100%; height: 180px; object-fit: cover; border-radius: 4px; }
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <img src="poli (2).png" alt="Logo" class="login-card img" onerror="this.style.display='none'">
            <h2>Acceso Restringido</h2>
            <p>NOJ Salamanca (Cloud)</p>
            <input type="text" id="user" placeholder="Usuario">
            <input type="password" id="pass" placeholder="ContraseÃ±a">
            <button class="btn-enter" onclick="window.App.login()" id="btn-login-action">Entrar</button>
            <p id="msg" style="color:red; margin-top:10px;"></p>
            <p id="loading-msg" style="color:blue; margin-top:5px; font-size:0.8rem; display:none;">Conectando a Firebase...</p>
        </div>
    </div>

    <div id="password-screen" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--primary); z-index:5001; display:flex; justify-content:center; align-items:center;">
        <div class="login-card">
            <h2 style="color:var(--danger)">Seguridad</h2>
            <p>Primer acceso. Cambie su contraseÃ±a.</p>
            <input type="password" id="new-p1" placeholder="Nueva ContraseÃ±a">
            <input type="password" id="new-p2" placeholder="Repita ContraseÃ±a">
            <button class="btn-enter" onclick="window.App.changePass()">Guardar y Acceder</button>
            <p id="pass-msg" style="color:red; margin-top:10px;"></p>
        </div>
    </div>

    <div id="main-app">
        <div class="app-header"><img src="pie175PLSA.jpg" alt="Cabecera" onerror="this.style.display='none'"></div>
        <div class="top-bar">
            <span id="user-display"></span>
            <button class="btn-logout" onclick="location.reload()">Salir</button>
        </div>
        <div class="content-area">
            <div class="sidebar">
                <div class="sidebar-logo"><img src="escudoPLSA.jpg" alt="Escudo" onerror="this.style.display='none'"></div>
                <div class="menu-item active" onclick="window.App.nav('temario')"><i class="fas fa-book"></i> Temario</div>
                <div class="menu-item" onclick="window.App.nav('biblio')"><i class="fas fa-folder"></i> DocumentaciÃ³n</div>
                <div class="menu-item" onclick="window.App.nav('media')"><i class="fas fa-image"></i> Multimedia</div>
                <div class="menu-item" onclick="window.App.nav('flashcards')"><i class="fas fa-brain"></i> Tarjetas</div>
                <div class="menu-item" onclick="window.App.nav('test')"><i class="fas fa-check-circle"></i> Test</div>
                <div class="menu-item hidden" id="menu-admin" onclick="window.App.nav('admin')"><i class="fas fa-users-cog"></i> GestiÃ³n</div>
            </div>
            
            <div class="viewport">
                <div id="view-temario" class="view-section active">
                    <h2>GuÃ­a Operativa</h2>
                    <div id="doc-tabs" class="doc-nav"></div>
                    <div id="doc-content"></div>
                </div>

                <div id="view-biblio" class="view-section">
                    <h2>Biblioteca</h2>
                    <ul id="file-tree" style="list-style:none; padding:0;"></ul>
                </div>

                <div id="view-media" class="view-section">
                    <h2>Multimedia</h2>
                    <div id="media-container" class="media-grid"></div>
                    <div style="margin-top:20px; background:white; padding:20px; border-radius:8px;">
                        <h3>Audio Resumen</h3>
                        <audio id="main-audio" controls style="width:100%"></audio>
                    </div>
                </div>

                <div id="view-flashcards" class="view-section">
                    <h2 style="text-align:center">Entrenamiento (30 Aleatorias)</h2>
                    <div class="fc-wrapper">
                        <div id="fc-canvas" class="fc-container"></div>
                        <div class="fc-controls">
                            <button class="btn-fc btn-prev" onclick="window.App.moveFC(-1)">Anterior</button>
                            <span id="fc-count" style="align-self:center; font-weight:bold;"></span>
                            <button class="btn-fc btn-next" onclick="window.App.moveFC(1)">Siguiente</button>
                        </div>
                    </div>
                </div>

                <div id="view-test" class="view-section">
                    <h2>EvaluaciÃ³n (20 Aleatorias)</h2>
                    <div id="test-container"></div>
                    <button class="btn-enter" style="width:auto; margin-top:20px;" onclick="window.App.submitTest()">Corregir Test</button>
                    <div id="test-result" style="margin-top:20px; font-weight:bold; font-size:1.2rem; text-align:center;"></div>
                </div>

                <div id="view-admin" class="view-section">
                    <h2>Panel de GestiÃ³n (CLOUD)</h2>
                    
                    <div id="security-box" style="display:none; background:#ffebeb; padding:15px; border:2px solid #c0392b; border-radius:8px; margin-bottom:20px;">
                        <h3 style="color:#c0392b; margin-top:0;"><i class="fas fa-shield-alt"></i> AuditorÃ­a de Seguridad</h3>
                        <div style="max-height:200px; overflow-y:auto;">
                            <table class="admin-table">
                                <thead><tr><th>Fecha</th><th>Usuario</th><th>AcciÃ³n</th><th>Detalles</th></tr></thead>
                                <tbody id="sec-logs"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="admin-tools">
                        <div style="background:white; padding:20px; border-radius:8px; margin-bottom:20px;">
                            <h3>AÃ±adir Usuario</h3>
                            <input type="text" id="new-u" placeholder="Usuario" style="width:100%; padding:8px; margin-bottom:5px;">
                            <input type="text" id="new-p" placeholder="Clave" style="width:100%; padding:8px; margin-bottom:5px;">
                            <select id="new-r" style="width:100%; padding:8px; margin-bottom:5px;">
                                <optgroup label="Agentes">
                                    <option value="adc">Agente DC</option>
                                    <option value="adt">Agente DT</option>
                                    <option value="aut">Agente UT</option>
                                </optgroup>
                                <optgroup label="Mandos (Jefes de Equipo)">
                                    <option value="mdc">Mando Calle (MDC)</option>
                                    <option value="mdt">Mando Territorial (MDT)</option>
                                    <option value="mut">Mando TÃ©cnico (MUT)</option>
                                </optgroup>
                                <optgroup label="DirecciÃ³n">
                                    <option value="jef">Jefatura (JEF)</option>
                                    <option value="admin">Administrador</option>
                                    <option value="master">MASTER</option>
                                </optgroup>
                            </select>
                            <select id="new-b" style="width:100%; padding:8px; margin-bottom:10px; background:#f0f7ff;">
                                <option value="">-- Asignar Jefe --</option>
                            </select>
                            <button class="btn-enter" onclick="window.App.addUser()">Crear Usuario</button>
                        </div>
                        
                        <div style="background:white; padding:20px; border-radius:8px; margin-bottom:20px;">
                            <h3>Importar Excel</h3>
                            <textarea id="import-data" class="import-area" placeholder="Usuario | Clave | Rol | Jefe"></textarea>
                            <button class="btn-enter" style="background:#27ae60;" onclick="window.App.importUsers()">Importar Masivo</button>
                            <p id="import-msg" style="color:green; font-weight:bold;"></p>
                        </div>
                    </div>

                    <h3>Resultados AcadÃ©micos</h3>
                    <table class="admin-table">
                        <thead><tr><th>Usuario</th><th>Rol</th><th>Fecha</th><th>Nota</th><th>Fallos</th><th>Mando Asignado</th></tr></thead>
                        <tbody id="admin-logs"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, setDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- TUS CLAVES DE FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyAYhB2TFiyT2N0Fob37fwwIzuru_L5fOAA",
      authDomain: "plsa-formacion-c2e68.firebaseapp.com",
      projectId: "plsa-formacion-c2e68",
      storageBucket: "plsa-formacion-c2e68.firebasestorage.app",
      messagingSenderId: "502759440918",
      appId: "1:502759440918:web:7d3269ed04db54b2b2ab37"
    };

    // INICIALIZAR FIREBASE
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- DATOS COMPLETOS (TEXTOS Y PREGUNTAS) ---
    const DB = {
        audio_url: "audio.m4a",
        imagenes: [
            {nombre: "InfografÃ­a Estructura (Clic para ver)", url: "estructura.png"},
            {nombre: "Mapa Mental Protocolo (Clic para ver)", url: "mapa.png"}
        ],
        bibliografia: [
            {nivel: "Normativa", archivos: [{nombre:"OJ-PROTOCOLO-ACTUACION-SALAMANCA-FIRMADO (1).pdf", desc:"Protocolo ActuaciÃ³n"}, {nombre:"Anexo-I-Manual-de-Organizacion-Salamanca-firmado.pdf", desc:"Manual OrganizaciÃ³n"}]},
            {nivel: "Manuales", archivos: [{nombre:"Anexo-II-Manual-del-SCT-Salamanca-firmado.pdf", desc:"Manual SCT"}, {nombre:"Anexo-III-Manual-del-SCG-Salamanca-firmado - copia.pdf", desc:"Manual SCG"}, {nombre:"Anexo-IV-Manual-SCEJ-Salamanca-firmado - copia.pdf", desc:"Manual SCEJ"}]}
        ],
        secciones_temario: [
          { 
            "titulo": "1. IntroducciÃ³n", 
            "contenido": `
                <h3>1. IntroducciÃ³n: La transformaciÃ³n del sistema judicial</h3>
                <p>El presente documento sirve de manual operativo para la PolicÃ­a Local ante la implantaciÃ³n del nuevo modelo de Oficina Judicial (OJ), que entrarÃ¡ en vigor el <strong>31 de diciembre de 2025</strong> (Ley OrgÃ¡nica 1/2025).</p>
                <p>Se abandona el esquema de juzgados aislados para pasar a un sistema centralizado orientado a:</p>
                <ul>
                    <li>Incrementar la agilidad.</li>
                    <li>Garantizar criterios homogÃ©neos.</li>
                    <li>Optimizar recursos.</li>
                    <li>Facilitar la interoperabilidad digital.</li>
                </ul>
                <p><strong>Impacto policial:</strong> VarÃ­an los puntos de entrada, los interlocutores y los circuitos de tramitaciÃ³n. Conocer esto es indispensable para evitar devoluciones de atestados.</p>
            ` 
          },
          { 
            "titulo": "2. Estructura (TI)", 
            "contenido": `
                <h3>2. VisiÃ³n general: El Tribunal de Instancia (TI)</h3>
                <p>Ya no se interactÃºa con un "juzgado concreto", sino con servicios especializados. El eje es el <strong>Tribunal de Instancia (TI)</strong> de Salamanca, que integra todas las plazas judiciales organizadas en Secciones:</p>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:0.9rem;">
                    <div style="background:#fff; padding:5px; border:1px solid #ddd;">â€¢ SecciÃ³n Civil</div>
                    <div style="background:#fff; padding:5px; border:1px solid #ddd;">â€¢ SecciÃ³n de InstrucciÃ³n</div>
                    <div style="background:#fff; padding:5px; border:1px solid #ddd;">â€¢ SecciÃ³n Penal</div>
                    <div style="background:#fff; padding:5px; border:1px solid #ddd;">â€¢ SecciÃ³n Menores</div>
                    <div style="background:#fff; padding:5px; border:1px solid #ddd;">â€¢ SecciÃ³n V. Penitenciaria</div>
                    <div style="background:#fff; padding:5px; border:1px solid #ddd;">â€¢ SecciÃ³n Social/Contencioso</div>
                </div>
                <p>El TI juzga, pero la tramitaciÃ³n la hacen los <strong>Servicios Comunes</strong>.</p>
            ` 
          },
          { 
            "titulo": "3. Servicios Comunes", 
            "contenido": `
                <h3>2.2 Los Servicios Comunes (Columna Vertebral)</h3>
                <p>Prestan apoyo al TI y a la Audiencia Provincial:</p>
                <table class='doc-table'>
                    <tr><th>Servicio</th><th>AcrÃ³nimo</th><th>FunciÃ³n principal</th></tr>
                    <tr><td><strong>Servicio ComÃºn General</strong></td><td>SCG</td><td><strong>Punto Ãºnico de entrada.</strong> RecepciÃ³n, registro, reparto, actos de comunicaciÃ³n (notificaciones) y archivo.</td></tr>
                    <tr><td><strong>Servicio ComÃºn de TramitaciÃ³n</strong></td><td>SCT</td><td>GestiÃ³n integral en fase declarativa (instrucciÃ³n y enjuiciamiento).</td></tr>
                    <tr><td><strong>Servicio ComÃºn de EjecuciÃ³n</strong></td><td>SCEJ</td><td>EjecuciÃ³n de resoluciones firmes (multas, prisiÃ³n, embargos).</td></tr>
                </table>
            ` 
          },
          { 
            "titulo": "4. GuÃ­a Operativa", 
            "contenido": `
                <h3>3. GuÃ­a Operativa (Escala Ejecutiva)</h3>
                <h4>3.1 Inicio: Destino del atestado</h4>
                <p><strong>Principio fundamental:</strong> Todo documento policial tiene un Ãºnico punto de entrada ordinario: el <strong>SCG</strong>.</p>
                <ul>
                    <li><strong>Forma:</strong> Preferentemente telemÃ¡tica.</li>
                    <li><strong>Horario SCG:</strong> Lunes a viernes, 08:30 a 15:00.</li>
                </ul>
                <p><strong>Circuito:</strong> PresentaciÃ³n SCG &rarr; Registro Oficial &rarr; Reparto &rarr; RemisiÃ³n al SCT competente.</p>
                <div style="background:#ffeeba; padding:10px; border-left:4px solid #ffc107; margin-top:10px;">
                    <strong>âš ï¸ Importante:</strong> Un atestado mal dirigido se devuelve al circuito inicial. Los errores generan retrasos en medidas cautelares.
                </div>
            ` 
          },
          { 
            "titulo": "5. Guardia (GU)", 
            "contenido": `
                <h3>3.2 InteracciÃ³n con el Servicio de Guardia (GU)</h3>
                <p>Es la excepciÃ³n al circuito ordinario. Se activa <strong>exclusivamente</strong> para urgencias.</p>
                <h4>DocumentaciÃ³n directa a Guardia:</h4>
                <ul>
                    <li>ğŸš¨ Atestados con <strong>PERSONA DETENIDA</strong>.</li>
                    <li>Atestados con investigado citado ante el juez de guardia.</li>
                    <li><strong>Solicitudes urgentes:</strong> Entradas y registros, intervenciones telefÃ³nicas, medidas cautelares inmediatas.</li>
                </ul>
                <p>El juez de guardia decide en tiempo real. Posteriormente, el asunto pasa al SCT.</p>
            ` 
          },
          { 
            "titulo": "6. PolicÃ­a Judicial", 
            "contenido": `
                <h3>4. Manual Avanzado: SCT Penal</h3>
                <p>El <strong>SCT Penal</strong> gestiona desde el inicio hasta la sentencia firme.</p>
                <h4>Estructura Interna:</h4>
                <ul>
                    <li><strong>Equipos de InstrucciÃ³n:</strong> InvestigaciÃ³n, diligencias, pruebas.</li>
                    <li><strong>Equipos de Enjuiciamiento:</strong> SeÃ±alamientos, vistas orales, sentencias.</li>
                </ul>
                <p>Existen grupos de trabajo diferenciados para Delitos Graves/Menos Graves y para Delitos Leves.</p>
            ` 
          },
          { 
            "titulo": "7. Unidades Espec.", 
            "contenido": `
                <h3>4.2 Unidades Especializadas (S4M)</h3>
                <p><strong>Violencia sobre la Mujer:</strong> Grupo de InstrucciÃ³n nÂº 3. Gestiona instrucciÃ³n penal, delitos leves asociados y Ã³rdenes de protecciÃ³n.</p>
                <p><strong>Menores:</strong> Grupo especÃ­fico del Equipo de Enjuiciamiento. Competencia integral desde FiscalÃ­a hasta ejecuciÃ³n.</p>
                <p><strong>Familia y Capacidad (Civil):</strong> Internamientos no voluntarios, custodias y protecciÃ³n a vulnerables.</p>
            ` 
          },
          { 
            "titulo": "8. EjecuciÃ³n (SCEJ)", 
            "contenido": `
                <h3>4.3 Fase de EjecuciÃ³n (SCEJ Penal)</h3>
                <p>Una vez la sentencia es firme, actÃºa el SCEJ. Es el interlocutor para:</p>
                <ul>
                    <li>Mandamientos de prisiÃ³n y libertad.</li>
                    <li>Ã“rdenes de bÃºsqueda y captura.</li>
                    <li>EjecuciÃ³n de multas e indemnizaciones.</li>
                    <li>Embargos y averiguaciones patrimoniales.</li>
                </ul>
                <p><strong>GestiÃ³n Digital:</strong> La calidad del expediente depende del primer envÃ­o policial (datos completos y normalizados).</p>
            ` 
          },
          { 
            "titulo": "9. Mandos y CoordinaciÃ³n", 
            "contenido": `
                <h3>5. Pautas para Escala TÃ©cnica</h3>
                <h4>5.1 Estructura de Mando</h4>
                <ul>
                    <li><strong>Director/a (LAJ):</strong> MÃ¡xima autoridad funcional.</li>
                    <li><strong>Jefatura de Ãrea:</strong> CoordinaciÃ³n por materias.</li>
                    <li><strong>Jefatura de Equipo:</strong> GestiÃ³n operativa directa.</li>
                </ul>
                <h4>5.3 GestiÃ³n de Incidencias</h4>
                <table class="doc-table">
                    <tr><td>Reparto incorrecto</td><td>DevoluciÃ³n al equipo de inicio.</td></tr>
                    <tr><td>Errores en datos</td><td>CorrecciÃ³n por Jefatura de Equipo.</td></tr>
                    <tr><td>Documento sin registro</td><td>RemisiÃ³n inmediata al SCG.</td></tr>
                </table>
            ` 
          },
          { 
            "titulo": "10. Flujos y Resumen", 
            "contenido": `
                <h3>7. Flujos Operativos y Resumen</h3>
                <p><strong>7.1 Atestado NO Urgente:</strong><br>PolicÃ­a &rarr; SCG &rarr; SCT (InstrucciÃ³n).</p>
                <p><strong>7.2 Urgente / Detenido:</strong><br>PolicÃ­a &rarr; GUARDIA &rarr; ResoluciÃ³n &rarr; SCT.</p>
                <p><strong>7.3 EjecuciÃ³n:</strong><br>Sentencia Firme &rarr; SCEJ &rarr; Mandamiento a PolicÃ­a.</p>
                <hr>
                <h4>RESUMEN DE BOLSILLO (PATRULLA)</h4>
                <ul>
                    <li>Â¿Tengo un atestado <strong>NO urgente</strong>? &rarr; <strong>SCG</strong>.</li>
                    <li>Â¿Hay <strong>Detenido</strong> o es Urgente? &rarr; <strong>GUARDIA</strong>.</li>
                    <li>Â¿Es ejecuciÃ³n de sentencia? &rarr; <strong>SCEJ</strong>.</li>
                    <li><strong>NUNCA</strong> enviar directamente a un juzgado.</li>
                </ul>
            ` 
          }
        ],
        // ... (resto de flashcards y test se mantienen igual, no los borres) ...
        flashcards: [
            { "front": "Â¿Fecha de entrada en vigor de la Nueva OJ?", "back": "31 de diciembre de 2025" },
            { "front": "Â¿Ley que impulsa la transformaciÃ³n?", "back": "Ley OrgÃ¡nica 1/2025" },
            { "front": "Â¿QuÃ© Ã³rgano sustituye a los juzgados individuales?", "back": "El Tribunal de Instancia (TI)" },
            { "front": "Â¿CuÃ¡l es el punto Ãºnico de entrada de documentos ordinarios?", "back": "El Servicio ComÃºn General (SCG)" },
            { "front": "Â¿Horario de recepciÃ³n del SCG?", "back": "Lunes a viernes laborables, 08:30 a 15:00" },
            { "front": "Â¿DÃ³nde se entregan atestados con DETENIDO?", "back": "Directamente al Servicio de Guardia (GU)" },
            { "front": "Â¿DÃ³nde van las solicitudes urgentes de entradas y registros?", "back": "Al Servicio de Guardia (GU)" },
            { "front": "Â¿QuÃ© servicio gestiona la fase de InstrucciÃ³n?", "back": "SCT (Servicio ComÃºn de TramitaciÃ³n) - Ãrea Penal" },
            { "front": "Â¿QuÃ© servicio gestiona la ejecuciÃ³n de sentencias firmes?", "back": "SCEJ (Servicio ComÃºn de EjecuciÃ³n)" },
            { "front": "Â¿QuiÃ©n dirige un Servicio ComÃºn (MÃ¡xima autoridad)?", "back": "El Director/a del Servicio (LAJ)" },
            { "front": "Â¿QuiÃ©n resuelve un error de datos en un escrito?", "back": "La Jefatura de Equipo de la unidad tramitadora" },
            { "front": "Â¿QuiÃ©n resuelve una devoluciÃ³n por reparto incorrecto?", "back": "La Jefatura de Equipo (se devuelve al equipo de inicio)" },
            { "front": "Â¿QuÃ© hacer con un documento no registrado?", "back": "Remitirlo al equipo de inicio para su registro oficial" },
            { "front": "Â¿QuÃ© unidad gestiona Violencia sobre la Mujer?", "back": "Grupo de Trabajo InstrucciÃ³n nÂº 3" },
            { "front": "Â¿QuÃ© unidad gestiona Menores (enjuiciamiento y ejecuciÃ³n)?", "back": "SCT - Equipo de Enjuiciamiento (SecciÃ³n Menores)" },
            { "front": "Â¿QuiÃ©n gestiona internamientos no voluntarios?", "back": "SCT Civil - Negociado de familia" },
            { "front": "Â¿QuÃ© servicio tramita una orden de busca y captura POST-sentencia?", "back": "SCEJ (EjecuciÃ³n)" },
            { "front": "Â¿QuÃ© servicio realiza la averiguaciÃ³n patrimonial?", "back": "SCEJ (EjecuciÃ³n)" },
            { "front": "Â¿Principal Ã³rgano estratÃ©gico de la OJ?", "back": "ComitÃ© de DirecciÃ³n" },
            { "front": "Â¿QuiÃ©n compone el ComitÃ© de DirecciÃ³n?", "back": "DirecciÃ³n, Jefaturas de Ãrea y Jefaturas de Equipo" },
            { "front": "Â¿Plataforma de comunicaciÃ³n con operadores?", "back": "LexNet" },
            { "front": "Â¿Sistema de gestiÃ³n procesal interno?", "back": "Atenea" },
            { "front": "Â¿Forma preferente de presentaciÃ³n de atestados?", "back": "TelemÃ¡tica" },
            { "front": "Â¿QuiÃ©n gestiona los juicios por delitos leves?", "back": "Grupos de Trabajo de Delitos Leves (SCT)" },
            { "front": "Â¿QuiÃ©n coordina un Ãrea dentro de un servicio?", "back": "Jefatura de Ãrea (LAJ o GPA)" },
            { "front": "Â¿FunciÃ³n principal del SCG?", "back": "Registro, reparto, actos de comunicaciÃ³n, archivo y depÃ³sito" },
            { "front": "Â¿QuÃ© equipo del SCG realiza notificaciones en calle?", "back": "Equipo 2: Servicios Transversales (Actos de ComunicaciÃ³n)" },
            { "front": "Â¿QuiÃ©n gestiona el DepÃ³sito de Efectos Judiciales?", "back": "SCG - Equipo 2" },
            { "front": "Â¿QuÃ© grupo gestiona el Apud-Acta?", "back": "Grupo de Trabajo de Apud-Actas (Equipo 1 SCG)" },
            { "front": "Â¿QuÃ© significa SCT?", "back": "Servicio ComÃºn de TramitaciÃ³n" },
            { "front": "Â¿El SCT de la Audiencia Provincial es independiente?", "back": "SÃ­, existe un SCT para el TI y otro para la AP" },
            { "front": "Â¿QuÃ© significa SCEJ?", "back": "Servicio ComÃºn de EjecuciÃ³n" },
            { "front": "Â¿QuiÃ©n tramita las subastas judiciales?", "back": "SCEJ" },
            { "front": "Â¿QuiÃ©n gestiona la Cuenta de DepÃ³sitos y Consignaciones?", "back": "SCEJ" },
            { "front": "Â¿QuÃ© significa OJM?", "back": "Oficinas de Justicia en el Municipio (Sustituyen Juzgados Paz)" },
            { "front": "Â¿DÃ³nde se publicita el protocolo?", "back": "Punto de Acceso General de la AdministraciÃ³n de Justicia (PAGAJ)" },
            { "front": "Â¿QuiÃ©n cuida la aplicaciÃ³n de protecciÃ³n de datos?", "back": "El titular de la DirecciÃ³n de cada servicio comÃºn" },
            { "front": "Â¿Normativa de protecciÃ³n de datos aplicable?", "back": "LOPJ, Reglamento (UE) 2016/679 y LO 3/2018" },
            { "front": "Â¿CarÃ¡cter del protocolo?", "back": "Normativo, flexible y dinÃ¡mico" },
            { "front": "Â¿Sistema para videoconferencias?", "back": "EVID" },
            { "front": "Â¿Frecuencia control cuentas consignaciÃ³n?", "back": "Trimestral" },
            { "front": "Â¿QuiÃ©n propone el rÃ©gimen de sustituciones en SCT?", "back": "La Jefatura de Ãrea" },
            { "front": "Â¿Horario atenciÃ³n al pÃºblico general?", "back": "09:00 a 14:00 (Verificar protocolo especÃ­fico)" },
            { "front": "Â¿A quiÃ©n se comunica la entrada en vigor?", "back": "Sala Gobierno TSJ, FiscalÃ­a, Colegios, Gerencia, etc." },
            { "front": "Â¿Nivel 4 de organizaciÃ³n interna?", "back": "Unidades Funcionales" },
            { "front": "Â¿Nivel 1 de organizaciÃ³n interna?", "back": "Equipos" },
            { "front": "Â¿QuiÃ©n firma el protocolo?", "back": "Secretario Coordinador Provincial y Secretario de Gobierno TSJ" },
            { "front": "Â¿UbicaciÃ³n personal funcionario?", "back": "Puestos de trabajo prÃ³ximos por equipos" },
            { "front": "Â¿QuiÃ©n gestiona el Archivo Judicial de GestiÃ³n?", "back": "SCG - Equipo 2" },
            { "front": "Â¿Registro electrÃ³nico habilitado?", "back": "Registro SIR" },
            { "front": "Â¿Objetivo de las OJM?", "back": "Acercar la justicia al ciudadano en municipios sin sede TI" },
            { "front": "Â¿QuiÃ©n dirige tÃ©cnico-procesalmente la oficina?", "back": "El Letrado de la Admon. de Justicia (LAJ)" },
            { "front": "Â¿QuÃ© es la UPAD?", "back": "Unidad Procesal de Apoyo Directo al Juez" },
            { "front": "Â¿QuÃ© es un SCP?", "back": "Servicio ComÃºn Procesal (Transversal)" },
            { "front": "Â¿Plazo detenciÃ³n policial mÃ¡xima?", "back": "72 horas (ConstituciÃ³n)" },
            { "front": "Â¿Plazo Habeas Corpus?", "back": "ResoluciÃ³n en 24 horas" },
            { "front": "Â¿QuiÃ©n instruye causas con aforados?", "back": "Tribunales Superiores (TSJ / Supremo)" },
            { "front": "Â¿QuÃ© es el PNJ?", "back": "Punto Neutro Judicial (Base de datos)" },
            { "front": "Â¿QuiÃ©n autoriza el levantamiento de cadÃ¡ver?", "back": "Juez de Guardia (con MÃ©dico Forense)" },
            { "front": "Â¿DÃ³nde se notifican resoluciones a la PolicÃ­a?", "back": "A travÃ©s de la unidad de enlace / GestiÃ³n" },
            { "front": "Â¿QuÃ© es un exhorto?", "back": "ComunicaciÃ³n entre Ã³rganos judiciales" },
            { "front": "Â¿QuÃ© es un mandamiento?", "back": "Orden judicial a registrador, funcionario o policÃ­a" },
            { "front": "Â¿QuÃ© es una providencia?", "back": "ResoluciÃ³n judicial de trÃ¡mite (Juez)" },
            { "front": "Â¿QuÃ© es una diligencia de ordenaciÃ³n?", "back": "ResoluciÃ³n de impulso procesal (LAJ)" },
            { "front": "Â¿QuÃ© es un Decreto?", "back": "ResoluciÃ³n finalizadora o de admisiÃ³n del LAJ" },
            { "front": "Â¿Recurso contra Providencia?", "back": "Recurso de Reforma" },
            { "front": "Â¿QuiÃ©n hace la tasaciÃ³n de costas?", "back": "El LAJ" },
            { "front": "Â¿QuÃ© es el turno de oficio?", "back": "Justicia Gratuita (Abogados designados)" },
            { "front": "Â¿QuiÃ©n custodia los expedientes activos?", "back": "El servicio tramitador (SCT/SCEJ)" },
            { "front": "Â¿QuiÃ©n custodia los expedientes archivados?", "back": "El Archivo (SCG)" },
            { "front": "Â¿QuÃ© es el SIRAJ?", "back": "Sistema de Registros Administrativos de Apoyo a la Admon. Justicia" },
            { "front": "Â¿QuÃ© se inscribe en el Registro Central de Penados?", "back": "Sentencias firmes condenatorias" },
            { "front": "Â¿QuiÃ©n expide la orden de alejamiento?", "back": "El Juez (Auto de medidas cautelares)" },
            { "front": "Â¿QuÃ© es un juicio 'in voce'?", "back": "Sentencia dictada oralmente en el acto" },
            { "front": "Â¿Plazo para recurrir en apelaciÃ³n (general penal)?", "back": "10 dÃ­as" },
            { "front": "Â¿QuÃ© es la conformidad?", "back": "Acusado reconoce hechos y acepta pena reducida" },
            { "front": "Â¿QuiÃ©n asiste al levantamiento de cadÃ¡ver si no va el Juez?", "back": "El LAJ (por delegaciÃ³n) y el Forense" },
            { "front": "Â¿QuÃ© es el 'reparto'?", "back": "DistribuciÃ³n de asuntos entre juzgados (SCG)" },
            { "front": "Â¿QuÃ© es una pieza separada?", "back": "Expediente paralelo para un tema concreto (ej. situaciÃ³n personal)" },
            { "front": "Â¿QuÃ© es el 'secreto de sumario'?", "back": "RestricciÃ³n de acceso a las partes (no al Fiscal)" },
            { "front": "Â¿QuiÃ©n solicita la prisiÃ³n provisional?", "back": "Fiscal o AcusaciÃ³n Particular (nunca el Juez de oficio)" },
            { "front": "Â¿MÃ¡ximo prisiÃ³n provisional (regla general)?", "back": "1 aÃ±o (delitos < 9 aÃ±os) o 2 aÃ±os (delitos > 9 aÃ±os)" },
            { "front": "Â¿QuÃ© es la fianza 'pudendo'?", "back": "Fianza para asegurar la libertad provisional" },
            { "front": "Â¿QuÃ© es la responsabilidad civil?", "back": "IndemnizaciÃ³n econÃ³mica por el delito" },
            { "front": "Â¿QuiÃ©n ejecuta la pena de trabajos en beneficio comunidad?", "back": "Servicios de GestiÃ³n de Penas (Instituciones Penitenciarias)" },
            { "front": "Â¿QuÃ© es el 'expurgo'?", "back": "DestrucciÃ³n de expedientes antiguos sin valor" },
            { "front": "Â¿QuÃ© es un 'lanzamiento'?", "back": "Desahucio forzoso de un inmueble" },
            { "front": "Â¿QuiÃ©n acompaÃ±a a la ComisiÃ³n Judicial?", "back": "Agentes de la autoridad (si se solicita auxilio)" },
            { "front": "Â¿QuÃ© es la 'averiguaciÃ³n patrimonial'?", "back": "BÃºsqueda de bienes del condenado (PNJ)" },
            { "front": "Â¿QuÃ© es una requisitoria?", "back": "Orden de busca y captura" },
            { "front": "Â¿QuÃ© es la rebeldÃ­a procesal?", "back": "Ausencia injustificada del acusado" },
            { "front": "Â¿CuÃ¡ndo prescribe una falta (delito leve)?", "back": "Al aÃ±o" },
            { "front": "Â¿CuÃ¡ndo prescribe un delito grave (general)?", "back": "A los 20 aÃ±os (si pena > 15 aÃ±os)" },
            { "front": "Â¿QuÃ© es el 'habeas corpus'?", "back": "Procedimiento por detenciÃ³n ilegal" },
            { "front": "Â¿Ante quiÃ©n se pide el habeas corpus?", "back": "Juez de InstrucciÃ³n del lugar" },
            { "front": "Â¿Es obligatorio abogado en habeas corpus?", "back": "No" },
            { "front": "Â¿QuÃ© es la LECrim?", "back": "Ley de Enjuiciamiento Criminal" },
            { "front": "Â¿QuÃ© es la LOPJ?", "back": "Ley OrgÃ¡nica del Poder Judicial" },
            { "front": "Â¿QuÃ© es el EVID?", "back": "Sistema de GrabaciÃ³n de Vistas" },
            { "front": "Â¿QuÃ© es la firma digital?", "back": "AutenticaciÃ³n electrÃ³nica de documentos" },
            { "front": "Â¿QuiÃ©n nombra a los peritos judiciales?", "back": "El Ã³rgano judicial (por listas o sorteo)" },
            { "front": "Â¿Se pueden usar USB en equipos judiciales?", "back": "No, estÃ¡ prohibido por seguridad informÃ¡tica" }
        ],
        test: [
            { "pregunta": "Â¿CuÃ¡l es la 'puerta Ãºnica' de entrada para documentaciÃ³n ordinaria?", "respuestas": ["Decanato", "SCG (Servicio ComÃºn General)", "SCT Penal"], "correcta": 1 },
            { "pregunta": "Â¿Hasta quÃ© hora se pueden presentar atestados en el SCG?", "respuestas": ["14:00", "15:00", "24 horas"], "correcta": 1 },
            { "pregunta": "Â¿DÃ³nde se entrega un atestado con DETENIDO?", "respuestas": ["SCG", "Servicio de Guardia (GU)", "SCT"], "correcta": 1 },
            { "pregunta": "Â¿QuÃ© servicio gestiona la fase de instrucciÃ³n?", "respuestas": ["SCT (TramitaciÃ³n)", "SCEJ (EjecuciÃ³n)", "SCG"], "correcta": 0 },
            { "pregunta": "Â¿QuÃ© servicio ejecuta una sentencia firme de prisiÃ³n?", "respuestas": ["SCT", "SCEJ (EjecuciÃ³n)", "Servicio de Guardia"], "correcta": 1 },
            { "pregunta": "Â¿QuiÃ©n es la mÃ¡xima autoridad funcional de un Servicio ComÃºn?", "respuestas": ["El Juez Decano", "El Director/a del Servicio (LAJ)", "El Gestor Procesal"], "correcta": 1 },
            { "pregunta": "Â¿QuÃ© unidad lleva los casos de Violencia de GÃ©nero?", "respuestas": ["Grupo InstrucciÃ³n nÂº 3", "SecciÃ³n de Menores", "SCG"], "correcta": 0 },
            { "pregunta": "Â¿QuiÃ©n resuelve un error en el DNI de un atestado?", "respuestas": ["Se devuelve a comisarÃ­a", "Jefatura de Equipo de la unidad tramitadora", "El Decanato"], "correcta": 1 },
            { "pregunta": "Â¿QuÃ© ocurre si presentas un documento sin registrar?", "respuestas": ["Se archiva", "Se devuelve al equipo de inicio para registro", "Se procesa igual"], "correcta": 1 },
            { "pregunta": "Â¿QuiÃ©n realiza las notificaciones en la calle?", "respuestas": ["PolicÃ­a Local", "SCG (Actos de ComunicaciÃ³n)", "SCT"], "correcta": 1 },
            { "pregunta": "Â¿DÃ³nde se tramitan los delitos leves?", "respuestas": ["Grupos de Trabajo de Delitos Leves (SCT)", "SCEJ", "Juzgados de Paz"], "correcta": 0 },
            { "pregunta": "Â¿QuiÃ©n gestiona la averiguaciÃ³n patrimonial para embargos?", "respuestas": ["SCT", "SCEJ", "SCG"], "correcta": 1 },
            { "pregunta": "Â¿QuÃ© Ã³rgano decide las estrategias de la OJ?", "respuestas": ["ComitÃ© de DirecciÃ³n", "Junta de Personal", "Sindicatos"], "correcta": 0 },
            { "pregunta": "Â¿QuÃ© ley regula la NOJ de Salamanca?", "respuestas": ["LO 1/2025", "LECrim", "Ley de Enjuiciamiento Civil"], "correcta": 0 },
            { "pregunta": "Â¿Las solicitudes de entrada y registro urgentes van a...?", "respuestas": ["SCG", "Servicio de Guardia", "SCT"], "correcta": 1 },
            { "pregunta": "Â¿QuiÃ©n gestiona el DepÃ³sito de Efectos Judiciales?", "respuestas": ["SCG", "SCT", "PolicÃ­a CientÃ­fica"], "correcta": 0 },
            { "pregunta": "Â¿QuÃ© sustituye a los Juzgados de Paz?", "respuestas": ["OJM (Oficinas de Justicia en el Municipio)", "Ayuntamientos", "Registros Civiles"], "correcta": 0 },
            { "pregunta": "Â¿CuÃ¡ndo entra en vigor el modelo?", "respuestas": ["31/12/2025", "01/01/2026", "Inmediatamente"], "correcta": 0 },
            { "pregunta": "Â¿El Tribunal de Instancia sustituye a...?", "respuestas": ["La Audiencia Provincial", "Los juzgados unipersonales", "El Tribunal Supremo"], "correcta": 1 },
            { "pregunta": "Â¿CÃ³mo se llama el sistema de gestiÃ³n procesal?", "respuestas": ["Atenea", "LexNet", "Siraj"], "correcta": 0 },
            { "pregunta": "Â¿QuiÃ©n realiza el reparto de asuntos?", "respuestas": ["El Juez Decano", "El SCG", "El SCT"], "correcta": 1 },
            { "pregunta": "Â¿QuÃ© servicio tramita un divorcio contencioso?", "respuestas": ["SCT Civil", "SCEJ", "SCG"], "correcta": 0 },
            { "pregunta": "Â¿QuiÃ©n coordina a los equipos de un servicio?", "respuestas": ["Jefatura de Ãrea", "Jefatura de Equipo", "DirecciÃ³n"], "correcta": 0 },
            { "pregunta": "Â¿DÃ³nde se ubica la SecciÃ³n de Menores?", "respuestas": ["SCT Penal - Enjuiciamiento", "SCT Civil", "SCEJ"], "correcta": 0 },
            { "pregunta": "Â¿QuiÃ©n firma los mandamientos de prisiÃ³n?", "respuestas": ["El Juez/Magistrado", "El LAJ", "El Gestor"], "correcta": 0 },
            { "pregunta": "Â¿QuÃ© es el PAGAJ?", "respuestas": ["Punto de Acceso General de la Admon. Justicia", "Un sindicato", "Un juzgado"], "correcta": 0 },
            { "pregunta": "Â¿QuiÃ©n asume las competencias de los antiguos Secretarios Judiciales?", "respuestas": ["LAJ (Letrados de la Admon. Justicia)", "Jueces", "Fiscales"], "correcta": 0 },
            { "pregunta": "Â¿El Servicio de Guardia funciona las 24h?", "respuestas": ["SÃ­", "No, solo maÃ±anas", "Solo fines de semana"], "correcta": 0 },
            { "pregunta": "Â¿QuiÃ©n gestiona la agenda de seÃ±alamientos?", "respuestas": ["SCT", "SCG", "SCEJ"], "correcta": 0 },
            { "pregunta": "Â¿QuÃ© pasa si un atestado va al SCT sin pasar por SCG?", "respuestas": ["Se devuelve a SCG para registro", "Se tramita igual", "Se archiva"], "correcta": 0 },
            { "pregunta": "Â¿QuiÃ©n custodia las grabaciones de los juicios?", "respuestas": ["LAJ", "PolicÃ­a", "Juez"], "correcta": 0 },
            { "pregunta": "Â¿QuÃ© servicio lleva la ejecuciÃ³n de penas de multa?", "respuestas": ["SCEJ", "SCT", "Hacienda"], "correcta": 0 },
            { "pregunta": "Â¿QuÃ© es la fase declarativa?", "respuestas": ["Desde inicio hasta sentencia firme", "Solo el juicio", "La ejecuciÃ³n"], "correcta": 0 },
            { "pregunta": "Â¿QuiÃ©n resuelve dudas sobre protecciÃ³n de datos?", "respuestas": ["Director del Servicio ComÃºn", "Jefe de PolicÃ­a", "Delegado del Gobierno"], "correcta": 0 },
            { "pregunta": "Â¿Las OJM dependen funcionalmente de...?", "respuestas": ["La Oficina Judicial", "El Ayuntamiento", "La Comunidad AutÃ³noma"], "correcta": 0 },
            { "pregunta": "Â¿QuiÃ©n dirige al personal funcionario en el dÃ­a a dÃ­a?", "respuestas": ["Jefatura de Equipo", "Juez", "Fiscal"], "correcta": 0 },
            { "pregunta": "Â¿DÃ³nde se solicitan los antecedentes penales?", "respuestas": ["Gerencia Territorial / SCG", "ComisarÃ­a", "Ayuntamiento"], "correcta": 0 },
            { "pregunta": "Â¿QuiÃ©n realiza el expurgo de expedientes?", "respuestas": ["Junta de Expurgo / SCG Archivo", "Empresa de limpieza", "PolicÃ­a"], "correcta": 0 },
            { "pregunta": "Â¿QuÃ© es SIR?", "respuestas": ["Sistema de InterconexiÃ³n de Registros", "Sistema Interno RÃ¡pido", "Servicio Integral"], "correcta": 0 },
            { "pregunta": "Â¿El TI tiene presidente?", "respuestas": ["SÃ­", "No", "Depende del tamaÃ±o"], "correcta": 0 },
            { "pregunta": "Â¿QuiÃ©n gestiona la caja de depÃ³sitos?", "respuestas": ["SCEJ", "Banco Santander", "SCG"], "correcta": 0 },
            { "pregunta": "Â¿QuÃ© ley modifica la planta judicial?", "respuestas": ["LO 1/2025", "ConstituciÃ³n", "Estatuto AutonomÃ­a"], "correcta": 0 },
            { "pregunta": "Â¿QuiÃ©n asiste a la ComisiÃ³n Judicial en lanzamientos?", "respuestas": ["SCG - Actos de ComunicaciÃ³n", "SCT", "SCEJ"], "correcta": 0 },
            { "pregunta": "Â¿QuiÃ©n gestiona las videoconferencias con prisiones?", "respuestas": ["SCG / SCT segÃºn fase", "PolicÃ­a", "Director PrisiÃ³n"], "correcta": 0 },
            { "pregunta": "Â¿Es obligatorio el uso de medios telemÃ¡ticos para PolicÃ­a?", "respuestas": ["SÃ­", "No", "Solo para delitos graves"], "correcta": 0 },
            { "pregunta": "Â¿QuiÃ©n controla el cumplimiento de penas de trabajos en beneficio de la comunidad?", "respuestas": ["SCEJ / Servicios Sociales Penitenciarios", "SCT", "PolicÃ­a Local"], "correcta": 0 },
            { "pregunta": "Â¿QuÃ© pasa con los Juzgados de Paz?", "respuestas": ["Se transforman en OJM", "Desaparecen sin mÃ¡s", "Se mantienen igual"], "correcta": 0 },
            { "pregunta": "Â¿QuiÃ©n coordina a los mÃ©dicos forenses?", "respuestas": ["Director IML", "Juez Decano", "Comisario"], "correcta": 0 },
            { "pregunta": "Â¿DÃ³nde se presentan las denuncias por particulares?", "respuestas": ["SCG o ComisarÃ­a", "SCT", "SCEJ"], "correcta": 0 },
            { "pregunta": "Â¿CuÃ¡l es el objetivo principal de la NOJ?", "respuestas": ["Agilidad y eficiencia", "Ahorrar papel", "Contratar mÃ¡s gente"], "correcta": 0 },
            { "pregunta": "Â¿QuÃ© principio rige la actuaciÃ³n de los Servicios Comunes Procesales?", "respuestas": ["Independencia absoluta", "JerarquÃ­a y unidad de actuaciÃ³n", "AutonomÃ­a de cada funcionario"], "correcta": 1 },
            { "pregunta": "Â¿QuiÃ©n es el responsable de la direcciÃ³n tÃ©cnico-procesal del SCT?", "respuestas": ["El Juez Decano", "El LAJ Director", "El Fiscal Jefe"], "correcta": 1 },
            { "pregunta": "Â¿A quÃ© servicio corresponde la expediciÃ³n de certificaciones sobre asuntos archivados?", "respuestas": ["SCG", "SCT", "Decanato"], "correcta": 0 },
            { "pregunta": "Â¿CÃ³mo se denominan las unidades que prestan soporte a varios Ã³rganos judiciales?", "respuestas": ["Unidades Procesales de Apoyo Directo (UPAD)", "Servicios Comunes Procesales (SCP)", "Juzgados Bis"], "correcta": 1 },
            { "pregunta": "Â¿QuiÃ©n autoriza la entrada y registro en un domicilio en fase de instrucciÃ³n?", "respuestas": ["El LAJ", "El Juez de InstrucciÃ³n / Guardia", "El Comisario"], "correcta": 1 },
            { "pregunta": "Â¿QuÃ© ocurre con las piezas de convicciÃ³n tÃ³xicas o peligrosas?", "respuestas": ["Se guardan en el despacho del Juez", "Se sigue un protocolo especial de destrucciÃ³n/custodia", "Se entregan al denunciante"], "correcta": 1 },
            { "pregunta": "Â¿El Servicio ComÃºn de EjecuciÃ³n (SCEJ) puede realizar lanzamientos?", "respuestas": ["No, eso es del SCG", "SÃ­, a travÃ©s de sus funcionarios o comisiÃ³n", "Solo si va el Juez"], "correcta": 1 },
            { "pregunta": "Â¿DÃ³nde se presentan los escritos de mero trÃ¡mite?", "respuestas": ["Directamente al Juez", "En el SCG (Registro)", "En ComisarÃ­a"], "correcta": 1 },
            { "pregunta": "Â¿QuÃ© sistema se utiliza para el embargo telemÃ¡tico de cuentas?", "respuestas": ["Punto Neutro Judicial", "Google Pay", "Agencia Tributaria Directa"], "correcta": 0 },
            { "pregunta": "Â¿QuiÃ©n es el superior jerÃ¡rquico del Cuerpo de Auxilio Judicial en la OJ?", "respuestas": ["El Gestor Procesal", "El LAJ Director del Servicio", "El PolicÃ­a de la puerta"], "correcta": 1 },
            { "pregunta": "Â¿QuÃ© servicio gestiona las Salas de Vistas?", "respuestas": ["SCT / SCG (segÃºn protocolo)", "El servicio de limpieza", "Los abogados"], "correcta": 0 },
            { "pregunta": "Â¿QuiÃ©n notifica la sentencia al penado?", "respuestas": ["El Juez oralmente", "El SCG (Actos de ComunicaciÃ³n)", "El abogado siempre"], "correcta": 1 },
            { "pregunta": "Â¿CuÃ¡l es el plazo para detener a una persona sin ponerla a disposiciÃ³n judicial?", "respuestas": ["72 horas mÃ¡ximo", "24 horas", "48 horas"], "correcta": 0 },
            { "pregunta": "Â¿Las citaciones a policÃ­as para juicios se hacen a travÃ©s de...?", "respuestas": ["TelÃ©fono personal", "Conducto reglamentario / GestiÃ³n Policial", "Correo postal ordinario"], "correcta": 1 },
            { "pregunta": "Â¿QuÃ© es la Oficina de AtenciÃ³n al Ciudadano/VÃ­ctima?", "respuestas": ["Un servicio externo", "Una unidad dentro de la OJ/FiscalÃ­a", "Una ONG"], "correcta": 1 },
            { "pregunta": "Â¿QuiÃ©n decreta el secreto de sumario?", "respuestas": ["El LAJ", "El Juez de InstrucciÃ³n", "La PolicÃ­a Judicial"], "correcta": 1 },
            { "pregunta": "Â¿A quiÃ©n corresponde la tasaciÃ³n de costas?", "respuestas": ["Al Colegio de Abogados", "Al LAJ del servicio correspondiente", "Al Juez"], "correcta": 1 },
            { "pregunta": "Â¿QuÃ© documento inicia el procedimiento de Habeas Corpus?", "respuestas": ["Una querella", "Una solicitud/escrito del detenido o tercero", "Un atestado ordinario"], "correcta": 1 },
            { "pregunta": "Â¿DÃ³nde se ubica fÃ­sicamente el SCG de Salamanca?", "respuestas": ["En la ComisarÃ­a Provincial", "En la sede principal de los Juzgados (Plaza ColÃ³n/Gran VÃ­a)", "En el Ayuntamiento"], "correcta": 1 },
            { "pregunta": "Â¿QuiÃ©n gestiona el turno de oficio?", "respuestas": ["El Colegio de Abogados", "El Juez Decano", "El SCG"], "correcta": 0 }
        ]
    };

    // --- LÃ“GICA DE LA APP (CLOUD + SEGURIDAD MEJORADA) ---
   const App = {
        data: DB,
        user: null,
        userDocId: null,

        // 1. INICIALIZACIÃ“N Y CREACIÃ“N DE JERARQUÃA (JEFES Y AGENTES)
        init: async () => {
            document.addEventListener('keyup', (e) => {
                if(e.key === 'Enter' && !document.getElementById('login-screen').classList.contains('hidden')) App.login();
            });

            // COMPROBAR SI LA BASE DE DATOS ESTÃ VACÃA Y CREAR LA ESTRUCTURA
            try {
                const q = query(collection(db, "noj_users"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    console.log("Inicializando jerarquÃ­a completa...");
                    const defs = [
                        // Nivel Superior
                        { u:'master', p:'master', r:'master', boss:'', change:true },
                        { u:'admin', p:'admin', r:'admin', boss:'', change:true },
                        { u:'jefatura', p:'jefatura', r:'jef', boss:'', change:true },
                        // Mandos Intermedios
                        { u:'mandodc', p:'1234', r:'mdc', boss:'', change:true },
                        { u:'mandodt', p:'1234', r:'mdt', boss:'', change:true },
                        { u:'mandout', p:'1234', r:'mut', boss:'', change:true },
                        // Agentes (Asignados a un Mando)
                        { u:'agentedc', p:'1234', r:'adc', boss:'mandodc', change:true }
                    ];
                    
                    // Crear uno a uno en la nube
                    for(let u of defs) {
                        await addDoc(collection(db, "noj_users"), u);
                    }
                    console.log("Usuarios y relaciones creados.");
                    App.logSec('SYSTEM', 'InicializaciÃ³n JerarquÃ­a V75');
                }
            } catch (e) { 
                console.error("Error conectando:", e); 
            }

            // Cargar datos aleatorios
            if(App.data.flashcards) App.sessionCards = App.shuffle([...App.data.flashcards]).slice(0, 30);
            if(App.data.test) App.sessionTest = App.shuffle([...App.data.test]).slice(0, 20);

            // Renderizar vistas
            App.renderTemario();
            App.renderBiblio();
            App.renderMedia();
            App.renderFC();
            App.renderTest();
            if(document.getElementById('main-audio')) document.getElementById('main-audio').src = App.data.audio_url;
        },

        shuffle: (a) => { for(let i=a.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; },

        // 2. LOGS DE SEGURIDAD
        logSec: async (action, details) => {
            try {
                await addDoc(collection(db, "noj_sec"), {
                    u: App.user ? App.user.u : 'SYSTEM',
                    a: action,
                    t: details,
                    d: new Date().toLocaleString(),
                    timestamp: Date.now()
                });
            } catch(e) { console.error("Error logSec", e); }
        },

        // 3. LOGIN
        login: async () => {
            const u = document.getElementById('user').value.trim();
            const p = document.getElementById('pass').value.trim();
            const btn = document.getElementById('btn-login-action');
            const load = document.getElementById('loading-msg');
            
            if(!u || !p) return;
            btn.disabled = true;
            load.style.display = 'block';

            try {
                const q = query(collection(db, "noj_users"), where("u", "==", u), where("p", "==", p));
                const snap = await getDocs(q);

                if (!snap.empty) {
                    const docSnap = snap.docs[0];
                    App.user = docSnap.data();
                    App.userDocId = docSnap.id;
                    
                    App.logSec('LOGIN', `Acceso: ${u}`);

                    if (App.user.change) {
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('password-screen').classList.remove('hidden');
                        return;
                    }
                    App.enterApp();
                } else {
                    document.getElementById('msg').innerText = "Credenciales incorrectas";
                }
            } catch (e) {
                console.error(e);
                document.getElementById('msg').innerText = "Error de conexiÃ³n";
            } finally {
                btn.disabled = false;
                load.style.display = 'none';
            }
        },

        changePass: async () => {
            const p1 = document.getElementById('new-p1').value;
            const p2 = document.getElementById('new-p2').value;
            if(p1.length<4 || p1!==p2) return document.getElementById('pass-msg').innerText = "Error: MÃ­nimo 4 caracteres y deben coincidir";
            
            try {
                const userRef = doc(db, "noj_users", App.userDocId);
                await updateDoc(userRef, { p: p1, change: false });
                App.user.p = p1;
                document.getElementById('password-screen').classList.add('hidden');
                App.enterApp();
            } catch(e) { console.error(e); }
        },

        enterApp: () => {
            document.getElementById('login-screen').style.display='none';
            document.getElementById('main-app').style.display='flex';
            document.getElementById('user-display').innerText = App.user.u.toUpperCase();
            
            // Mostrar menÃº de gestiÃ³n segÃºn rol
            if(['admin','master','jef','mdc','mdt','mut'].includes(App.user.r)) { 
                document.getElementById('menu-admin').classList.remove('hidden'); 
                App.renderAdmin(); 
            }
        },

        // 4. PANEL DE GESTIÃ“N (AQUÃ ESTÃ LA CLAVE DE LAS RELACIONES)
        renderAdmin: async () => {
            const global = ['admin','master'].includes(App.user.r); 
            const jefatura = App.user.r === 'jef';
            // Si NO es global, es solo lectura (Mandos no pueden crear usuarios, solo ver)
            const readonly = !global; 
            
            // Traer todos los datos frescos de la nube
            let users = [];
            const uSnap = await getDocs(collection(db, "noj_users"));
            uSnap.forEach(d => users.push(d.data()));

            let logs = [];
            const lSnap = await getDocs(query(collection(db, "noj_logs"), orderBy("timestamp", "desc"), limit(50)));
            lSnap.forEach(d => logs.push(d.data()));

            // A. SEGURIDAD (Solo Master/Admin)
            const secBox = document.getElementById('security-box');
            if(global) {
                secBox.style.display = 'block';
                const st = document.getElementById('sec-logs'); st.innerHTML = '';
                const sSnap = await getDocs(query(collection(db, "noj_sec"), orderBy("timestamp", "desc"), limit(20)));
                sSnap.forEach(doc => {
                    const s = doc.data();
                    st.innerHTML += `<tr><td>${s.d}</td><td>${s.u}</td><td>${s.a}</td><td>${s.t || ''}</td></tr>`;
                });
            } else {
                secBox.style.display = 'none';
            }

            // B. HERRAMIENTAS DE CREACIÃ“N (Solo Global)
            if(readonly) {
                document.getElementById('admin-tools').style.display='none';
            } else {
                document.getElementById('admin-tools').style.display='block';
                // Rellenar selector de jefes con TODOS los que tengan rango de mando
                const bs = document.getElementById('new-b'); 
                bs.innerHTML = '<option value="">-- Sin Jefe Asignado --</option>';
                users.filter(u => ['mdc','mdt','mut','jef','admin','master'].includes(u.r)).forEach(b => { 
                    bs.innerHTML += `<option value="${b.u}">${b.u} (${b.r.toUpperCase()})</option>`; 
                });
            }

            // C. TABLA DE RESULTADOS (FILTRO DE RELACIONES)
            const t = document.getElementById('admin-logs'); t.innerHTML='';
            logs.forEach(l => {
                let show = false; 
                // Buscamos quiÃ©n es el jefe de este usuario que ha hecho el examen
                const uData = users.find(x => x.u === l.u); 
                const boss = uData ? uData.boss : '';
                
                // REGLAS DE VISIBILIDAD:
                // 1. Admin, Master y Jefatura ven TODO.
                if(global || jefatura) show = true; 
                // 2. Un Mando solo ve si el usuario le tiene asignado como jefe ('boss').
                else if(boss === App.user.u) show = true; 

                if(show) {
                    t.innerHTML += `<tr>
                        <td>${l.u}</td>
                        <td>${uData?uData.r.toUpperCase():'?'}</td>
                        <td>${l.d}</td>
                        <td style="color:${l.s>10?'green':'red'}"><b>${l.s}</b></td>
                        <td>${l.f}</td>
                        <td>${boss || '-'}</td>
                    </tr>`;
                }
            });
        },

        addUser: async () => {
            const u = document.getElementById('new-u').value; const p = document.getElementById('new-p').value; const r = document.getElementById('new-r').value; const b = document.getElementById('new-b').value;
            if(!u || !p) return alert("Rellena usuario y clave");

            const q = query(collection(db, "noj_users"), where("u", "==", u));
            const check = await getDocs(q);
            if(!check.empty) return alert("Usuario ya existe");

            await addDoc(collection(db, "noj_users"), {u,p,r,boss:b, change:true});
            App.logSec('CREATE_USER', `Creado: ${u} [${r}]`);
            App.renderAdmin(); 
            alert("Usuario creado");
        },

        importUsers: async () => {
            const raw = document.getElementById('import-data').value;
            const map = {'AGENTE (DC)':'adc','AGENTE (DT)':'adt','AGENTE (UT)':'aut','MANDO (DC)':'mdc','MANDO (DT)':'mdt','MANDO (UT)':'mut','JEFATURA':'jef','ADMIN':'admin','MASTER':'master'};
            let c=0;
            const lines = raw.split('\n');
            
            for(let l of lines) {
                let p = l.split(/\t+/); if(p.length<2) p=l.split(/\s+/);
                if(p.length>=2) {
                    let r = map[p[2]] || 'adc';
                    const q = query(collection(db, "noj_users"), where("u", "==", p[0]));
                    const check = await getDocs(q);
                    if(check.empty) {
                        await addDoc(collection(db, "noj_users"), {u:p[0], p:p[1], r:r, boss:p[3]||'', change:true});
                        c++;
                    }
                }
            }
            document.getElementById('import-msg').innerText = `+${c}`; 
            App.logSec('IMPORT', `Importados ${c}`);
            App.renderAdmin();
        },
        
        // --- RESTO DE FUNCIONES DE RENDERIZADO (NO CAMBIAN) ---
        renderTemario: () => {
            const t = document.getElementById('doc-tabs'), c = document.getElementById('doc-content'); t.innerHTML=''; c.innerHTML='';
            App.data.secciones_temario.forEach((s,i) => {
                t.innerHTML += `<button class="doc-tab ${i===0?'active':''}" onclick="window.App.tab(${i})">${s.titulo}</button>`;
                c.innerHTML += `<div id="p${i}" class="doc-page ${i===0?'active':''}">${s.contenido}</div>`;
            });
        },
        tab: (i) => {
            document.querySelectorAll('.doc-tab').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('.doc-page').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('.doc-tab')[i].classList.add('active');
            document.getElementById('p'+i).classList.add('active');
        },
        renderBiblio: () => { 
            const t = document.getElementById('file-tree'); t.innerHTML = ''; 
            App.data.bibliografia.forEach(c => { 
                let l = c.archivos.map(f => `<li style="margin-bottom:5px;"><a href="${f.nombre}" target="_blank" style="text-decoration:none; color:#0a2e5c;">ğŸ“„ ${f.desc}</a></li>`).join(''); 
                t.innerHTML += `<li style="margin-bottom:15px;"><strong>${c.nivel}</strong><ul style="list-style:none; padding-left:10px;">${l}</ul></li>`; 
            }); 
        },
        renderMedia: () => {
            const c = document.getElementById('media-container'); c.innerHTML='';
            App.data.imagenes.forEach(i => c.innerHTML += `<div class="media-card" onclick="window.open('${i.url}','_blank')"><img src="${i.url}" onerror="this.src='//via.placeholder.com/300'"><p>${i.nombre}</p></div>`);
        },
        renderFC: () => { App.fcI=0; App.drawFC(); },
        drawFC: () => {
            if(!App.sessionCards || !App.sessionCards.length) return;
            const c = App.sessionCards[App.fcI];
            document.getElementById('fc-canvas').innerHTML = `<div class="fc-inner"><div class="fc-face fc-front"><div><i class="fas fa-question-circle fa-2x"></i><br><br>${c.front}</div></div><div class="fc-face fc-back"><div>${c.back}</div></div></div>`;
            document.getElementById('fc-canvas').onclick = function() { this.classList.toggle('fc-flipped'); };
            document.getElementById('fc-count').innerText = `${App.fcI+1} / ${App.sessionCards.length}`;
        },
        moveFC: (d) => {
            if(!App.sessionCards) return;
            App.fcI += d; 
            if(App.fcI < 0) App.fcI = App.sessionCards.length - 1;
            if(App.fcI >= App.sessionCards.length) App.fcI = 0;
            document.getElementById('fc-canvas').classList.remove('fc-flipped'); 
            setTimeout(() => App.drawFC(), 200);
        },
        renderTest: () => {
            if(!App.sessionTest) return;
            document.getElementById('test-container').innerHTML = App.sessionTest.map((q,i) => `<div class="q-block" data-c="${q.correcta}"><p><b>${i+1}. ${q.pregunta}</b></p>${q.respuestas.map(r => `<div class="quiz-option" onclick="window.App.selOpt(this)">${r}</div>`).join('')}</div>`).join('');
        },
        selOpt: (el) => {
            el.parentElement.querySelectorAll('.quiz-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
        },
        submitTest: async () => {
            let s = 0; 
            const blocks = document.querySelectorAll('.q-block');
            blocks.forEach(b => {
                const sel = b.querySelector('.selected'); const c = parseInt(b.dataset.c); const opts = b.querySelectorAll('.quiz-option');
                opts.forEach(o => o.classList.remove('correct','wrong'));
                if(sel) { if(Array.from(opts).indexOf(sel)===c) { sel.classList.add('correct'); s++; } else { sel.classList.add('wrong'); opts[c].classList.add('correct'); } }
            });
            document.getElementById('test-result').innerText = `Resultado: ${s} / ${blocks.length} Aciertos`;
            
            try {
                await addDoc(collection(db, "noj_logs"), {
                    u: App.user.u,
                    d: new Date().toLocaleString(),
                    s: s,
                    f: blocks.length - s,
                    timestamp: Date.now()
                });
            } catch(e) { console.error(e); }

            if(['admin','master','jef'].includes(App.user.r)) App.renderAdmin();
        },
        nav: (id) => { document.querySelectorAll('.view-section').forEach(x=>x.classList.remove('active')); document.getElementById('view-'+id).classList.add('active'); }
    };

    // EXPORTAR AL OBJETO WINDOW
    window.App = App;
    window.onload = App.init;
</script>
</body>
</html>
