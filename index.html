<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma FormaciÃ³n Policial - NOJ Salamanca (CLOUD)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #0a2e5c; --accent: #d4af37; --bg: #f4f7f9; --text: #333; --danger: #c0392b; --success: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; background: linear-gradient(rgba(10,46,92,0.9), rgba(10,46,92,0.9)), url('jefatura.jpg') center/cover; display: flex; justify-content: center; align-items: center; }
        .login-card { background: white; padding: 40px; border-radius: 12px; width: 320px; text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.5); }
        .login-card img { width: 100px; margin-bottom: 20px; }
        .login-card input { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        .btn-enter { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 15px; }
        .btn-enter:disabled { background: #ccc; cursor: not-allowed; }

        /* APP */
        #main-app { display: none; height: 100%; flex-direction: column; }
        .app-header { background: white; padding: 10px; text-align: center; border-bottom: 4px solid var(--accent); flex-shrink: 0; }
        .app-header img { height: 80px; }
        .top-bar { background: var(--primary); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .btn-logout { background: #c0392b; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .content-area { flex: 1; display: flex; overflow: hidden; }
        .sidebar { width: 260px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; }
        .sidebar-logo { text-align: center; padding: 20px; border-bottom: 1px solid #eee; }
        .sidebar-logo img { width: 100px; }
        .menu-item { padding: 15px; cursor: pointer; border-bottom: 1px solid #eee; color: #555; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background: #f0f4f8; color: var(--primary); border-left: 4px solid var(--primary); }
        .menu-item i { width: 25px; margin-right: 10px; }
        .viewport { flex: 1; padding: 30px; overflow-y: auto; background: #f4f7f9; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        
        /* TEMARIO */
        .doc-nav { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 20px; }
        .doc-tab { padding: 10px; background: #e0e0e0; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .doc-tab.active { background: var(--primary); color: white; }
        .doc-page { display: none; background: white; padding: 40px; border-radius: 8px; line-height: 1.6; text-align: justify; }
        .doc-page.active { display: block; }
        .doc-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .doc-table th, .doc-table td { border: 1px solid #ddd; padding: 10px; }

        /* TARJETAS */
        .fc-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .fc-container { perspective: 1000px; height: 320px; width: 100%; max-width: 600px; cursor: pointer; }
        .fc-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .fc-flipped .fc-inner { transform: rotateY(180deg); }
        .fc-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; display: flex; align-items: center; justify-content: center; padding: 30px; text-align: center; border-radius: 15px; font-size: 1.3rem; background: white; border: 3px solid var(--primary); box-sizing: border-box; }
        .fc-front { background: var(--primary); color: white; z-index: 2; transform: rotateY(0deg); }
        .fc-back { transform: rotateY(180deg); color: #333; }
        .fc-controls { display: flex; gap: 20px; margin-bottom: 30px; }
        .btn-fc { padding: 12px 30px; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; width: 140px; }
        
        /* MEDIA */
        .media-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .media-card { background: white; padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .media-card:hover { transform: translateY(-5px); }
        .media-card img { max-width: 100%; height: 180px; object-fit: cover; }

        /* TEST */
        .quiz-option { padding: 15px; margin: 10px 0; background: white; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
        .quiz-option:hover { background: #f9f9f9; }
        .quiz-option.selected { background: #e3f2fd; border-color: var(--primary); }
        .quiz-option.correct { background: #d4edda; border-color: green; }
        .quiz-option.wrong { background: #f8d7da; border-color: red; }

        /* ADMIN */
        .admin-table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; font-size: 0.9rem; }
        .admin-table th, .admin-table td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        .import-area { width: 100%; height: 100px; padding: 10px; margin-top: 10px; font-family: monospace; font-size: 11px; }
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <img src="poli (2).png" alt="Logo" onerror="this.style.display='none'">
        <h2>Acceso Restringido</h2>
        <p>NOJ Salamanca (En la Nube)</p>
        <input type="text" id="user" placeholder="Usuario">
        <input type="password" id="pass" placeholder="ContraseÃ±a">
        <button class="btn-enter" onclick="window.App.login()" id="btn-login-action">Entrar</button>
        <p id="msg" style="color:red; margin-top:10px;"></p>
        <p id="loading-msg" style="color:blue; margin-top:5px; font-size:0.8rem; display:none;">Conectando a la nube...</p>
    </div>
</div>

<div id="password-screen" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--primary); z-index:6000; display:flex; justify-content:center; align-items:center;">
    <div class="login-card">
        <h2 style="color:#c0392b">Seguridad</h2>
        <p>Cambie su contraseÃ±a inicial.</p>
        <input type="password" id="new-p1" placeholder="Nueva ContraseÃ±a">
        <input type="password" id="new-p2" placeholder="Repita ContraseÃ±a">
        <button class="btn-enter" onclick="window.App.changePass()">Guardar</button>
        <p id="pass-msg" style="color:red"></p>
    </div>
</div>

<div id="main-app">
    <div class="app-header"><img src="pie175PLSA.jpg" alt="Cabecera" onerror="this.style.display='none'"></div>
    <div class="top-bar">
        <span id="display-user"></span>
        <button class="btn-logout" onclick="location.reload()">Salir</button>
    </div>
    
    <div class="content-area">
        <div class="sidebar">
            <div class="sidebar-logo"><img src="escudoPLSA.jpg" onerror="this.style.display='none'"></div>
            <div class="menu-item active" onclick="window.App.nav('temario')"><i class="fas fa-book"></i> Temario</div>
            <div class="menu-item" onclick="window.App.nav('biblio')"><i class="fas fa-folder"></i> DocumentaciÃ³n</div>
            <div class="menu-item" onclick="window.App.nav('media')"><i class="fas fa-image"></i> Multimedia</div>
            <div class="menu-item" onclick="window.App.nav('flashcards')"><i class="fas fa-brain"></i> Tarjetas</div>
            <div class="menu-item" onclick="window.App.nav('test')"><i class="fas fa-check-circle"></i> Test</div>
            <div class="menu-item hidden" id="menu-admin" onclick="window.App.nav('admin')"><i class="fas fa-users-cog"></i> GestiÃ³n</div>
        </div>

        <div class="viewport">
            <div id="view-temario" class="view-section active">
                <h2>GuÃ­a Operativa</h2>
                <div id="doc-tabs" class="doc-nav"></div>
                <div id="doc-content"></div>
            </div>

            <div id="view-biblio" class="view-section">
                <h2>Biblioteca Digital</h2>
                <ul id="file-tree" style="list-style:none; padding:0;"></ul>
            </div>

            <div id="view-media" class="view-section">
                <h2>Recursos Multimedia</h2>
                <div class="media-grid" id="media-container"></div>
                <div style="margin-top:20px; background:white; padding:20px; border-radius:8px;">
                    <h3>Audio Resumen</h3>
                    <audio id="main-audio" controls style="width:100%"></audio>
                </div>
            </div>

            <div id="view-flashcards" class="view-section">
                <h2 style="text-align:center">Entrenamiento (30 Aleatorias)</h2>
                <div class="fc-wrapper">
                    <div id="fc-canvas" class="fc-container"></div>
                    <div class="fc-controls">
                        <button class="btn-fc" style="background:#c0392b" onclick="window.App.moveFC(-1)">Anterior</button>
                        <span id="fc-count" style="align-self:center; font-weight:bold;"></span>
                        <button class="btn-fc" style="background:#27ae60" onclick="window.App.moveFC(1)">Siguiente</button>
                    </div>
                </div>
            </div>

            <div id="view-test" class="view-section">
                <h2>EvaluaciÃ³n (20 Aleatorias)</h2>
                <div id="test-container"></div>
                <button class="btn-enter" style="width:auto; margin-top:20px;" onclick="window.App.submitTest()">Corregir</button>
                <div id="test-result" style="margin-top:20px; font-weight:bold; font-size:1.2rem; text-align:center;"></div>
            </div>

            <div id="view-admin" class="view-section">
                <h2>Panel de GestiÃ³n (NUBE)</h2>
                <div id="admin-tools">
                    <div style="background:white; padding:20px; border-radius:8px; margin-bottom:20px;">
                        <h3>AÃ±adir Usuario</h3>
                        <input type="text" id="new-u" placeholder="Usuario" style="width:100%; padding:8px; margin-bottom:5px;">
                        <input type="text" id="new-p" placeholder="Clave" style="width:100%; padding:8px; margin-bottom:5px;">
                        <select id="new-r" style="width:100%; padding:8px; margin-bottom:5px;">
                            <optgroup label="Agentes"><option value="adc">Agente DC</option><option value="adt">Agente DT</option><option value="aut">Agente UT</option></optgroup>
                            <optgroup label="Mandos"><option value="mdc">Mando Calle</option><option value="mdt">Mando Territorial</option><option value="mut">Mando TÃ©cnico</option></optgroup>
                            <optgroup label="DirecciÃ³n"><option value="jef">Jefatura</option><option value="admin">Admin</option><option value="master">MASTER</option></optgroup>
                        </select>
                        <select id="new-b" style="width:100%; padding:8px; margin-bottom:10px; background:#f0f7ff;"><option value="">-- Asignar Mando --</option></select>
                        <button class="btn-enter" onclick="window.App.addUser()">Crear Usuario</button>
                    </div>
                    <div style="background:white; padding:20px; border-radius:8px; margin-bottom:20px;">
                        <h3>Importar Excel</h3>
                        <textarea id="import-data" class="import-area" placeholder="Usuario | Clave | Rol | Jefe"></textarea>
                        <button class="btn-enter" style="background:#27ae60;" onclick="window.App.importUsers()">Importar Masivo</button>
                        <p id="import-msg" style="color:green; font-weight:bold;"></p>
                    </div>
                </div>
                <h3>Resultados (Tiempo Real)</h3>
                <table class="admin-table"><thead><tr><th>Usuario</th><th>Rol</th><th>Fecha</th><th>Nota</th><th>Fallos</th><th>Mando Asignado</th></tr></thead><tbody id="admin-logs"></tbody></table>
                <div id="security-box" style="margin-top:30px; display:none;">
                    <h3 style="color:#c0392b">AuditorÃ­a Seguridad</h3>
                    <div style="max-height:150px; overflow:auto; border:1px solid #ccc;"><table class="admin-table"><thead><tr><th>Fecha</th><th>User</th><th>AcciÃ³n</th></tr></thead><tbody id="sec-logs"></tbody></table></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, setDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIGURACIÃ“N PARA CLOUDFLARE/FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyDcaIU7mHPVOdOu6YgfBb87PbpipWJ7nQM",
      authDomain: "formacion-plsa.firebaseapp.com",
      projectId: "formacion-plsa",
      storageBucket: "formacion-plsa.firebasestorage.app",
      messagingSenderId: "138483849268",
      appId: "1:138483849268:web:42e1997d4662b9b2f11261"
    };

    // INICIALIZAR FIREBASE
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DATOS ESTÃTICOS
    const DB = {
        audio_url: "audio.m4a",
        imagenes: [
            {nombre: "InfografÃ­a Estructura (Clic para ver)", url: "estructura.png"},
            {nombre: "Mapa Mental Protocolo (Clic para ver)", url: "mapa.png"}
        ],
        bibliografia: [
            {nivel: "Normativa", archivos: [{nombre:"OJ-PROTOCOLO-ACTUACION-SALAMANCA-FIRMADO (1).pdf", desc:"Protocolo de ActuaciÃ³n"}, {nombre:"Anexo-I-Manual-de-Organizacion-Salamanca-firmado.pdf", desc:"Manual de OrganizaciÃ³n"}]},
            {nivel: "Manuales Operativos", archivos: [{nombre:"Anexo-II-Manual-del-SCT-Salamanca-firmado.pdf", desc:"Manual SCT (TramitaciÃ³n)"}, {nombre:"Anexo-III-Manual-del-SCG-Salamanca-firmado - copia.pdf", desc:"Manual SCG (General)"}, {nombre:"Anexo-IV-Manual-SCEJ-Salamanca-firmado - copia.pdf", desc:"Manual SCEJ (EjecuciÃ³n)"}]},
            {nivel: "Recursos GrÃ¡ficos", archivos: [{nombre: "estructura.png", desc: "InfografÃ­a Estructura (Imagen)"}, {nombre: "mapa.png", desc: "Mapa Mental Protocolo (Imagen)"}]}
        ],
        secciones_temario: [
          { "titulo": "1. IntroducciÃ³n", "contenido": "<h3>1. IntroducciÃ³n: La transformaciÃ³n del sistema judicial</h3><p>El presente documento tiene como finalidad servir de manual operativo... Este modelo, que entrarÃ¡ en vigor el 31 de diciembre de 2025...</p>" },
          { "titulo": "2. VisiÃ³n General", "contenido": "<h3>2. VisiÃ³n general de la nueva Oficina Judicial (OJ)</h3><p>La nueva OJ redefine completamente la relaciÃ³n funcional...</p><h4>2.1 El Tribunal de Instancia (TI)</h4><p>Integra en una Ãºnica estructura todas las anteriores plazas judiciales...</p>" },
          { "titulo": "3. Servicios Comunes", "contenido": "<h3>2.2 Los Servicios Comunes</h3><p>La Oficina Judicial se estructura en tres Servicios Comunes...</p><table class='doc-table'><tr><th>Servicio</th><th>AcrÃ³nimo</th><th>FunciÃ³n principal</th></tr><tr><td>Servicio ComÃºn General</td><td>SCG</td><td>Punto Ãºnico de entrada...</td></tr><tr><td>Servicio ComÃºn de TramitaciÃ³n</td><td>SCT</td><td>GestiÃ³n integral...</td></tr><tr><td>Servicio ComÃºn de EjecuciÃ³n</td><td>SCEJ</td><td>EjecuciÃ³n...</td></tr></table>" },
          { "titulo": "4. GuÃ­a Operativa", "contenido": "<h3>3. GuÃ­a operativa</h3><h4>3.1 Inicio del procedimiento</h4><p>Principio fundamental: Todo documento policial tiene un Ãºnico punto de entrada ordinario: el <strong>Servicio ComÃºn General (SCG)</strong>.</p>" },
          { "titulo": "5. Guardia (Urgencias)", "contenido": "<h4>3.2 InteracciÃ³n con el Servicio de Guardia (GU)</h4><p>El Servicio de Guardia constituye una excepciÃ³n... Atestados con persona detenida, Solicitudes urgentes...</p>" },
          { "titulo": "6. PolicÃ­a Judicial", "contenido": "<h3>4. Manual avanzado para agentes</h3><h4>4.1 Servicio ComÃºn de TramitaciÃ³n (SCT) â€“ Ãrea Penal</h4><p>Gestiona desde el inicio hasta la firmeza. Estructura: Equipos de InstrucciÃ³n, Equipos de Enjuiciamiento...</p>" },
          { "titulo": "7. Unidades Espec.", "contenido": "<h4>4.2 Unidades especializadas (S4M)</h4><ul><li>Violencia sobre la Mujer</li><li>Menores</li><li>Familia, Infancia y Capacidad</li></ul>" },
          { "titulo": "8. EjecuciÃ³n (SCEJ)", "contenido": "<h4>4.3 Fase de ejecuciÃ³n</h4><p>Una vez firme la sentencia, la competencia pasa al SCEJ...</p>" },
          { "titulo": "9. Mandos", "contenido": "<h3>5. Pautas para la escala tÃ©cnica</h3><h4>5.1 Estructura de mando</h4><p>Director/a (LAJ), Jefatura de Ãrea, Jefatura de Equipo...</p>" },
          { "titulo": "10. Protocolos", "contenido": "<h3>6. InstrucciÃ³n interna</h3><p>Obligatoria y vinculante. Entrada en vigor 31/12/2025...</p>" }
        ],
        flashcards: Array.from({length:100}, (_,i) => {
            const data = [
                ["Â¿Fecha entrada vigor?", "31 Diciembre 2025"], ["Â¿Ley reguladora?", "LO 1/2025"], ["Â¿Sustituto Juzgados?", "Tribunal de Instancia"],
                ["Â¿Punto entrada Ãºnico?", "SCG"], ["Â¿Horario SCG?", "L-V 08:30-15:00"], ["Â¿Atestado con detenido?", "Guardia"],
                ["Â¿GestiÃ³n instrucciÃ³n?", "SCT Penal"], ["Â¿EjecuciÃ³n sentencias?", "SCEJ"], ["Â¿MÃ¡xima autoridad?", "Director LAJ"],
                ["Â¿Error datos?", "Jefatura Equipo"], ["Â¿Sin registrar?", "Remitir a SCG"], ["Â¿Violencia Mujer?", "Grupo InstrucciÃ³n 3"],
                ["Â¿Menores?", "SCT Enjuiciamiento"], ["Â¿Internamientos?", "SCT Civil"], ["Â¿Busca y captura?", "SCEJ"],
                ["Â¿Atenea?", "GestiÃ³n procesal"], ["Â¿LexNet?", "Comunicaciones"], ["Â¿Delitos Leves?", "Grupos Trabajo SCT"],
                ["Â¿Notificaciones calle?", "SCG"], ["Â¿DepÃ³sito Efectos?", "SCG"], ["Â¿Significado SCT?", "SC TramitaciÃ³n"],
                ["Â¿Significado SCEJ?", "SC EjecuciÃ³n"], ["Â¿Significado OJM?", "Oficinas Justicia Municipio"], ["Â¿Sustituto Paz?", "OJM"],
                ["Â¿Firma protocolo?", "Secretarios Coordinador/Gobierno"], ["Â¿Subastas?", "SCEJ"], ["Â¿Caja DepÃ³sitos?", "SCEJ"],
                ["Â¿Control cuentas?", "Trimestral"], ["Â¿Videoconferencias?", "EVID"], ["Â¿Sustituciones?", "Jefatura Ãrea"],
                ["Â¿AtenciÃ³n pÃºblico?", "09-14h"], ["Â¿Nivel bÃ¡sico?", "Equipos"], ["Â¿Publicidad?", "PAGAJ"], ["Â¿Archivo?", "SCG"],
                ["Â¿Registro electrÃ³nico?", "SIR"], ["Â¿Objetivo OJM?", "Acercar justicia"], ["Â¿Lanzamientos?", "PolicÃ­a a requerimiento"],
                ["Â¿Urgencias E/R?", "Guardia"], ["Â¿Investigado citado?", "Guardia"], ["Â¿Juicios rÃ¡pidos?", "Guardia -> SCT"],
                ["Â¿Retirada carnet?", "SCEJ"], ["Â¿Denuncias admin?", "SCG"], ["Â¿Suspensiones?", "SCEJ"], ["Â¿Libertad?", "SCEJ"],
                ["Â¿Fallo LexNet?", "FÃ­sico justificado"], ["Â¿Jefe Equipo?", "Gestor/Tramitador"], ["Â¿Jefe Ãrea?", "LAJ/Gestor"],
                ["Â¿ComitÃ© DirecciÃ³n?", "EstratÃ©gico"], ["Â¿ComitÃ© CoordinaciÃ³n?", "Operativo"], ["Â¿Reparto error?", "Devolver inicio"],
                ["Â¿Sede SCG?", "ColÃ³n/Gran VÃ­a"], ["Â¿Turno oficio?", "Colegio Abogados"], ["Â¿Recurso Diligencia?", "ReposiciÃ³n"],
                ["Â¿Acceso Atenea?", "Pasarelas"], ["Â¿Preside Junta?", "Decano"], ["Â¿Forense Guardia?", "Urgencias/Detenidos"],
                ["Â¿Agosto hÃ¡bil?", "Causas urgentes"], ["Â¿JurisdicciÃ³n Voluntaria?", "SCT Civil"], ["Â¿Fe pÃºblica?", "LAJ"],
                ["Â¿Exhorto?", "Auxilio judicial"], ["Â¿Desahucios?", "ComisiÃ³n Judicial"], ["Â¿Decomisos?", "DestrucciÃ³n/RealizaciÃ³n"],
                ["Â¿Rebelde?", "Busca y captura"], ["Â¿Libertad condicional?", "Vigilancia Penitenciaria"], ["Â¿Homicidio?", "Jurado/Audiencia"],
                ["Â¿NotificaciÃ³n detenido?", "Lectura derechos"], ["Â¿Fallo EVID?", "Acta escrita"], ["Â¿Incapacidades?", "SCT Familia"],
                ["Â¿DaciÃ³n cuenta?", "Informar estado"], ["Â¿Orden protecciÃ³n?", "VÃ­ctima/Fiscal/Oficio"], ["Â¿Archivo definitivo?", "SCG"],
                ["Â¿Acceso sede?", "Guardia Civil"], ["Â¿Apud Acta?", "Apoderamiento"], ["Â¿Caducidad requisitoria?", "PrescripciÃ³n"],
                ["Â¿Dirige investigaciÃ³n?", "Juez InstrucciÃ³n"], ["Â¿Juicio RÃ¡pido?", "Diligencias Urgentes"], ["Â¿Menor detenido?", "FiscalÃ­a"],
                ["Â¿Diligencia constancia?", "LAJ"], ["Â¿Valor atestado?", "Denuncia"], ["Â¿Conflictos competencia?", "Audiencia"],
                ["Â¿Subasta bienes?", "Portal BOE"], ["Â¿Escritos 24h?", "LexNet"], ["Â¿DetenciÃ³n mÃ¡xima?", "72h"],
                ["Â¿Habeas Corpus?", "24h"], ["Â¿Aforados?", "TSJ/Supremo"], ["Â¿PNJ?", "Punto Neutro"], ["Â¿Levantamiento cadÃ¡ver?", "Guardia"],
                ["Â¿NotificaciÃ³n policÃ­a?", "Enlace"], ["Â¿Mandamiento?", "Orden"], ["Â¿Providencia?", "Juez"], ["Â¿Decreto?", "LAJ"],
                ["Â¿TasaciÃ³n costas?", "LAJ"], ["Â¿Custodia activos?", "SCT/SCEJ"], ["Â¿Custodia archivo?", "SCG"],
                ["Â¿SIRAJ?", "Registros Admin"], ["Â¿Registro Penados?", "Sentencias firmes"], ["Â¿Alejamiento?", "Auto Juez"],
                ["Â¿Juicio in voce?", "Oral"], ["Â¿ApelaciÃ³n plazo?", "10 dÃ­as"], ["Â¿Conformidad?", "Reconoce hechos"]
            ];
            return i < data.length ? { front: data[i][0], back: data[i][1] } : { front: "Pregunta " + i, back: "Respuesta " + i };
        }),
        test: Array.from({length:70}, (_,i) => {
            const qs = [
                {p:"Â¿Puerta Ãºnica entrada?", r:["Decanato","SCG","SCT"], c:1}, {p:"Â¿Horario SCG?", r:["09-14","08:30-15:00","24h"], c:1},
                {p:"Â¿Atestado DETENIDO?", r:["SCG","Guardia","SCT"], c:1}, {p:"Â¿InstrucciÃ³n?", r:["SCT","SCEJ","SCG"], c:0},
                {p:"Â¿EjecuciÃ³n?", r:["SCT","SCEJ","Guardia"], c:1}, {p:"Â¿Autoridad funcional?", r:["Decano","LAJ","Gestor"], c:1},
                {p:"Â¿Violencia Mujer?", r:["Grupo 3","Menores","SCG"], c:0}, {p:"Â¿Error DNI?", r:["ComisarÃ­a","Jefe Equipo","Decano"], c:1},
                {p:"Â¿Sin registrar?", r:["Archivar","Devolver SCG","Procesar"], c:1}, {p:"Â¿Notif. calle?", r:["PolicÃ­a","SCG","SCT"], c:1},
                {p:"Â¿Delitos leves?", r:["SCT","SCEJ","Paz"], c:0}, {p:"Â¿Embargos?", r:["SCT","SCEJ","SCG"], c:1},
                {p:"Â¿Estrategia?", r:["ComitÃ© DirecciÃ³n","Sindicato","Junta"], c:0}, {p:"Â¿Ley?", r:["LO 1/2025","LECrim","Civil"], c:0},
                {p:"Â¿E/R Urgente?", r:["SCG","Guardia","SCT"], c:1}, {p:"Â¿DepÃ³sito?", r:["SCG","SCT","CientÃ­fica"], c:0},
                {p:"Â¿Juzgados Paz?", r:["OJM","Ayto","Registro"], c:0}, {p:"Â¿Vigor?", r:["31/12/25","01/01/26","Ya"], c:0},
                {p:"Â¿TI sustituye?", r:["Audiencia","Unipersonales","Supremo"], c:1}, {p:"Â¿GestiÃ³n?", r:["Atenea","LexNet","Siraj"], c:0},
                {p:"Â¿Reparto?", r:["Decano","SCG","SCT"], c:1}, {p:"Â¿Divorcio?", r:["SCT Civil","SCEJ","SCG"], c:0},
                {p:"Â¿Coord. Equipo?", r:["Jefe Ãrea","Jefe Equipo","DirecciÃ³n"], c:0}, {p:"Â¿Menores?", r:["SCT Enjuicia","Civil","SCEJ"], c:0},
                {p:"Â¿Firma prisiÃ³n?", r:["Juez","LAJ","Gestor"], c:0}, {p:"Â¿PAGAJ?", r:["Punto Acceso","Sindicato","Juzgado"], c:0},
                {p:"Â¿Guardia 24h?", r:["SÃ­, urgencias","No","Fines semana"], c:0}, {p:"Â¿Atestado directo?", r:["Devolver SCG","Tramitar","Perder"], c:0},
                {p:"Â¿Ejecuta multas?", r:["SCEJ","SCT","Hacienda"], c:0}, {p:"Â¿Fase declarativa?", r:["InstrucciÃ³n","EjecuciÃ³n","Recurso"], c:0},
                {p:"Â¿DirecciÃ³n diaria?", r:["Jefe Equipo","Juez","Fiscal"], c:0}, {p:"Â¿Antecedentes?", r:["Gerencia","ComisarÃ­a","Ayto"], c:0},
                {p:"Â¿Expurgo?", r:["Junta","Limpieza","PolicÃ­a"], c:0}, {p:"Â¿Presidente TI?", r:["SÃ­","No","A veces"], c:0},
                {p:"Â¿Caja depÃ³sitos?", r:["SCEJ","Banco","SCG"], c:0}, {p:"Â¿Lanzamientos?", r:["SCG","SCT","SCEJ"], c:0},
                {p:"Â¿Videoconf?", r:["SCG/SCT","PolicÃ­a","PrisiÃ³n"], c:0}, {p:"Â¿TelemÃ¡tico?", r:["Obligatorio","Opcional","Graves"], c:0},
                {p:"Â¿Trabajos benef?", r:["SCEJ","SCT","PolicÃ­a"], c:0}, {p:"Â¿Objetivo NOJ?", r:["Agilidad","Ahorro","Personal"], c:0},
                {p:"Â¿Principio SCP?", r:["Independencia","JerarquÃ­a","AutonomÃ­a"], c:1}, {p:"Â¿DirecciÃ³n TÃ©c?", r:["Decano","LAJ","Fiscal"], c:1},
                {p:"Â¿Certific. Archivo?", r:["SCG","SCT","Decanato"], c:0}, {p:"Â¿Soporte varios?", r:["UPAD","SCP","Juzgados"], c:1},
                {p:"Â¿Autoriza E/R?", r:["LAJ","Juez","Comisario"], c:1}, {p:"Â¿Piezas tÃ³xicas?", r:["Despacho","Protocolo","Devolver"], c:1},
                {p:"Â¿Lanzamientos SCEJ?", r:["No","SÃ­","Solo Juez"], c:1}, {p:"Â¿Escritos trÃ¡mite?", r:["Juez","SCG","ComisarÃ­a"], c:1},
                {p:"Â¿Embargo cuentas?", r:["PNJ","Google","Agencia"], c:0}, {p:"Â¿Jefe Auxilio?", r:["Gestor","LAJ","PolicÃ­a"], c:1},
                {p:"Â¿Salas Vistas?", r:["SCT/SCG","Limpieza","Abogados"], c:0}, {p:"Â¿Notif. sentencia?", r:["Juez","SCG","Abogado"], c:1},
                {p:"Â¿Plazo detenciÃ³n?", r:["72h","24h","48h"], c:0}, {p:"Â¿CitaciÃ³n policÃ­a?", r:["TelÃ©fono","Conducto","Correo"], c:1},
                {p:"Â¿Att. Ciudadano?", r:["Externo","OJ","ONG"], c:1}, {p:"Â¿Secreto sumario?", r:["LAJ","Juez","PolicÃ­a"], c:1},
                {p:"Â¿TasaciÃ³n?", r:["Colegio","LAJ","Juez"], c:1}, {p:"Â¿Habeas Corpus?", r:["Querella","Solicitud","Atestado"], c:1},
                {p:"Â¿UbicaciÃ³n SCG?", r:["ComisarÃ­a","Juzgados","Ayto"], c:1}, {p:"Â¿Turno oficio?", r:["Colegio","Decano","SCG"], c:0},
                {p:"Â¿Recurso Diligencia?", r:["ReposiciÃ³n","Amparo","Nada"], c:0}, {p:"Â¿Acceso Atenea?", r:["SÃ­","Pasarela","Cualquiera"], c:1},
                {p:"Â¿Preside Junta?", r:["Decano","Audiencia","LAJ"], c:0}, {p:"Â¿Forense Guardia?", r:["Urgencias","Detenidos","Sustituto"], c:1},
                {p:"Â¿Agosto?", r:["Nunca","Urgentes","MaÃ±anas"], c:1}, {p:"Â¿Juris. Voluntaria?", r:["SCT Civil","SCEJ","Registro"], c:0},
                {p:"Â¿Fe pÃºblica?", r:["Juez","LAJ","PolicÃ­a"], c:1}, {p:"Â¿Exhorto?", r:["Multa","Auxilio","Sentencia"], c:1},
                {p:"Â¿Ejecuta desahucio?", r:["ComisiÃ³n","Propietario","Ayto"], c:0}, {p:"Â¿Decomiso lÃ­cito?", r:["PolicÃ­a","RealizaciÃ³n","Basura"], c:1}
            ];
            return i < qs.length ? { pregunta: qs[i].p, respuestas: qs[i].r, correcta: qs[i].c } : { pregunta: "Pregunta " + i, respuestas: ["A","B","C"], correcta: 0 };
        })
    };

    // LOGICA DE LA APLICACIÃ“N
    const App = {
        data: DB,
        user: null,
        userDocId: null,

        init: async () => {
            document.addEventListener('keyup', (e) => {
                if(e.key === 'Enter' && !document.getElementById('login-screen').classList.contains('hidden')) App.login();
            });

            // COMPROBAR SI LA BBDD ESTÃ VACÃA Y CREAR USUARIOS POR DEFECTO
            try {
                const q = query(collection(db, "noj_users"), where("u", "==", "master"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    console.log("Creando usuarios por defecto en la nube...");
                    const defs = [
                        { u:'master', p:'master', r:'master', boss:'', change:true },
                        { u:'admin', p:'admin', r:'admin', boss:'', change:true },
                        { u:'jefatura', p:'jefatura', r:'jef', boss:'', change:true },
                        { u:'mandodc', p:'1234', r:'mdc', boss:'', change:true },
                        { u:'mandodt', p:'1234', r:'mdt', boss:'', change:true },
                        { u:'mandout', p:'1234', r:'mut', boss:'', change:true },
                        { u:'agentedc', p:'1234', r:'adc', boss:'mandodc', change:true }
                    ];
                    for (const u of defs) {
                        await addDoc(collection(db, "noj_users"), u);
                    }
                }
            } catch (e) { console.error("Error inicializando:", e); }

            // BARAJAR Y CORTAR
            if(App.data.flashcards) App.sessionCards = App.shuffle([...App.data.flashcards]).slice(0, 30);
            if(App.data.test) App.sessionTest = App.shuffle([...App.data.test]).slice(0, 20);

            App.renderTemario();
            App.renderBiblio();
            App.renderMedia();
            App.renderFC();
            App.renderTest();
            if(document.getElementById('main-audio')) document.getElementById('main-audio').src = App.data.audio_url;
        },

        shuffle: (a) => { for(let i=a.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; },

        // LOG EN NUBE
        logSec: async (a, d) => {
            try {
                await addDoc(collection(db, "noj_sec_logs"), {
                    d: new Date().toLocaleString(),
                    u: App.user ? App.user.u : 'GUEST',
                    a: a,
                    t: d,
                    timestamp: Date.now()
                });
            } catch(e) { console.error(e); }
        },

        login: async () => {
            const u = document.getElementById('user').value.trim();
            const p = document.getElementById('pass').value.trim();
            const btn = document.getElementById('btn-login-action');
            const load = document.getElementById('loading-msg');
            
            btn.disabled = true;
            load.style.display = 'block';

            try {
                const q = query(collection(db, "noj_users"), where("u", "==", u), where("p", "==", p));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const docSnap = querySnapshot.docs[0];
                    App.user = docSnap.data();
                    App.userDocId = docSnap.id;

                    if (App.user.change) {
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('password-screen').classList.remove('hidden');
                        return;
                    }
                    App.enterApp();
                } else {
                    document.getElementById('msg').innerText = "Credenciales incorrectas";
                    App.logSec('LOGIN_FAIL', u);
                }
            } catch (e) {
                console.error(e);
                document.getElementById('msg').innerText = "Error de conexiÃ³n (Verifica permisos en Firebase)";
            } finally {
                btn.disabled = false;
                load.style.display = 'none';
            }
        },

        changePass: async () => {
            const p1 = document.getElementById('new-p1').value;
            const p2 = document.getElementById('new-p2').value;
            if(p1.length<4 || p1!==p2) return document.getElementById('pass-msg').innerText = "Error contraseÃ±a";
            
            try {
                const userRef = doc(db, "noj_users", App.userDocId);
                await updateDoc(userRef, { p: p1, change: false });
                App.user.p = p1;
                App.logSec('PASS_CHANGE', App.user.u);
                document.getElementById('password-screen').classList.add('hidden');
                App.enterApp();
            } catch(e) { console.error(e); }
        },

        enterApp: () => {
            document.getElementById('login-screen').style.display='none';
            document.getElementById('main-app').style.display='flex';
            document.getElementById('display-user').innerText = App.user.u.toUpperCase();
            App.logSec('LOGIN_OK', App.user.u);
            if(['admin','master','jef','mdc','mdt','mut'].includes(App.user.r)) { document.getElementById('menu-admin').classList.remove('hidden'); App.renderAdmin(); }
        },

        renderTemario: () => {
            const t = document.getElementById('doc-tabs'), c = document.getElementById('doc-content'); t.innerHTML=''; c.innerHTML='';
            App.data.secciones_temario.forEach((s,i) => {
                t.innerHTML += `<button class="doc-tab ${i===0?'active':''}" onclick="window.App.tab(${i})">${s.titulo}</button>`;
                c.innerHTML += `<div id="p${i}" class="doc-page ${i===0?'active':''}">${s.contenido}</div>`;
            });
        },
        tab: (i) => {
            document.querySelectorAll('.doc-tab').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('.doc-page').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('.doc-tab')[i].classList.add('active');
            document.getElementById('p'+i).classList.add('active');
        },

        renderBiblio: () => { 
            document.getElementById('file-tree').innerHTML = ''; 
            App.data.bibliografia.forEach(c => { 
                let l = c.archivos.map(f => `<li style="margin-bottom:5px;"><a href="${f.nombre}" target="_blank" style="text-decoration:none; color:#0a2e5c;">ğŸ“„ ${f.desc}</a></li>`).join(''); 
                document.getElementById('file-tree').innerHTML += `<li style="margin-bottom:15px;"><strong>${c.nivel}</strong><ul style="list-style:none; padding-left:10px;">${l}</ul></li>`; 
            }); 
        },

        renderMedia: () => {
            const c = document.getElementById('media-container'); c.innerHTML='';
            App.data.imagenes.forEach(i => c.innerHTML += `<div class="media-card" onclick="window.open('${i.url}','_blank')"><img src="${i.url}" onerror="this.src='//via.placeholder.com/300'"><p>${i.nombre}</p></div>`);
        },

        renderFC: () => { App.fcI=0; App.drawFC(); },
        drawFC: () => {
            if(!App.sessionCards)
