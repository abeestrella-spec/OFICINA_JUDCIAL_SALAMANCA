<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma Formaci칩n Policial - NOJ Salamanca</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #0a2e5c; --accent: #d4af37; --bg: #f4f7f9; --text: #333; --danger: #c0392b; --success: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; background: linear-gradient(rgba(10,46,92,0.9), rgba(10,46,92,0.9)), url('jefatura.jpg') center/cover; display: flex; justify-content: center; align-items: center; }
        .login-card { background: white; padding: 40px; border-radius: 12px; width: 320px; text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.5); }
        .login-card img { width: 100px; margin-bottom: 20px; }
        .login-card input { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        .btn-enter { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 15px; }

        /* APP */
        #main-app { display: none; height: 100%; flex-direction: column; }
        .app-header { background: white; padding: 10px; text-align: center; border-bottom: 4px solid var(--accent); flex-shrink: 0; }
        .app-header img { height: 80px; }
        .top-bar { background: var(--primary); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .btn-logout { background: #c0392b; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .content-area { flex: 1; display: flex; overflow: hidden; }
        .sidebar { width: 260px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; }
        .sidebar-logo { text-align: center; padding: 20px; border-bottom: 1px solid #eee; }
        .sidebar-logo img { width: 100px; }
        .menu-item { padding: 15px; cursor: pointer; border-bottom: 1px solid #eee; color: #555; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background: #f0f4f8; color: var(--primary); border-left: 4px solid var(--primary); }
        .menu-item i { width: 25px; margin-right: 10px; }
        .viewport { flex: 1; padding: 30px; overflow-y: auto; background: #f4f7f9; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        
        /* TEMARIO */
        .doc-nav { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 20px; }
        .doc-tab { padding: 10px; background: #e0e0e0; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .doc-tab.active { background: var(--primary); color: white; }
        .doc-page { display: none; background: white; padding: 40px; border-radius: 8px; line-height: 1.6; }
        .doc-page.active { display: block; }
        .doc-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .doc-table th, .doc-table td { border: 1px solid #ddd; padding: 10px; }

        /* TARJETAS */
        .fc-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .fc-container { perspective: 1000px; height: 320px; width: 100%; max-width: 600px; cursor: pointer; }
        .fc-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .fc-flipped .fc-inner { transform: rotateY(180deg); }
        .fc-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; padding: 30px; text-align: center; border-radius: 15px; font-size: 1.3rem; background: white; border: 3px solid var(--primary); box-sizing: border-box; }
        .fc-front { background: var(--primary); color: white; z-index: 2; transform: rotateY(0deg); }
        .fc-back { transform: rotateY(180deg); color: #333; }
        .fc-controls { display: flex; gap: 20px; margin-bottom: 30px; }
        .btn-fc { padding: 12px 30px; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; width: 140px; }
        
        /* MEDIA */
        .media-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .media-card { background: white; padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .media-card:hover { transform: translateY(-5px); }
        .media-card img { max-width: 100%; height: 180px; object-fit: cover; }

        /* TEST */
        .quiz-option { padding: 15px; margin: 10px 0; background: white; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
        .quiz-option:hover { background: #f9f9f9; }
        .quiz-option.selected { background: #e3f2fd; border-color: var(--primary); }
        .quiz-option.correct { background: #d4edda; border-color: green; }
        .quiz-option.wrong { background: #f8d7da; border-color: red; }

        /* ADMIN */
        .admin-table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; font-size: 0.9rem; }
        .admin-table th, .admin-table td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        .import-area { width: 100%; height: 100px; padding: 10px; margin-top: 10px; font-family: monospace; font-size: 11px; }
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <img src="poli (2).png" alt="Logo">
        <h2>Acceso Restringido</h2>
        <p>NOJ Salamanca</p>
        <input type="text" id="user" placeholder="Usuario">
        <input type="password" id="pass" placeholder="Contrase침a">
        <button class="btn-enter" onclick="App.login()">Entrar</button>
        <p id="msg" style="color:red; margin-top:10px;"></p>
    </div>
</div>

<div id="password-screen" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--primary); z-index:6000; display:flex; justify-content:center; align-items:center;">
    <div class="login-card">
        <h2 style="color:#c0392b">Seguridad</h2>
        <p>Cambie su contrase침a inicial.</p>
        <input type="password" id="new-p1" placeholder="Nueva Contrase침a">
        <input type="password" id="new-p2" placeholder="Repita Contrase침a">
        <button class="btn-enter" onclick="App.changePass()">Guardar</button>
    </div>
</div>

<div id="main-app">
    <div class="app-header"><img src="pie175PLSA.jpg" alt="Cabecera"></div>
    <div class="top-bar">
        <span id="display-user"></span>
        <button class="btn-logout" onclick="location.reload()">Salir</button>
    </div>
    
    <div class="content-area">
        <div class="sidebar">
            <div class="sidebar-logo"><img src="escudoPLSA.jpg"></div>
            <div class="menu-item active" onclick="App.nav('temario')"><i class="fas fa-book"></i> Temario</div>
            <div class="menu-item" onclick="App.nav('biblio')"><i class="fas fa-folder"></i> Documentaci칩n</div>
            <div class="menu-item" onclick="App.nav('media')"><i class="fas fa-image"></i> Multimedia</div>
            <div class="menu-item" onclick="App.nav('flashcards')"><i class="fas fa-brain"></i> Tarjetas</div>
            <div class="menu-item" onclick="App.nav('test')"><i class="fas fa-check-circle"></i> Test</div>
            <div class="menu-item hidden" id="menu-admin" onclick="App.nav('admin')"><i class="fas fa-users-cog"></i> Gesti칩n</div>
        </div>

        <div class="viewport">
            <div id="view-temario" class="view-section active">
                <h2>Gu칤a Operativa</h2>
                <div id="doc-tabs" class="doc-nav"></div>
                <div id="doc-content"></div>
            </div>

            <div id="view-biblio" class="view-section">
                <h2>Biblioteca Digital</h2>
                <ul id="file-tree" style="list-style:none; padding:0;"></ul>
            </div>

            <div id="view-media" class="view-section">
                <h2>Recursos Multimedia</h2>
                <div class="media-grid" id="media-container"></div>
                <div style="margin-top:20px; background:white; padding:20px; border-radius:8px;">
                    <h3>Audio Resumen</h3>
                    <audio id="main-audio" controls style="width:100%"></audio>
                </div>
            </div>

            <div id="view-flashcards" class="view-section">
                <h2 style="text-align:center">Entrenamiento (30 Aleatorias)</h2>
                <div class="fc-wrapper">
                    <div id="fc-canvas" class="fc-container"></div>
                    <div class="fc-controls">
                        <button class="btn-fc" style="background:#c0392b" onclick="App.moveFC(-1)">Anterior</button>
                        <span id="fc-count" style="align-self:center; font-weight:bold;"></span>
                        <button class="btn-fc" style="background:#27ae60" onclick="App.moveFC(1)">Siguiente</button>
                    </div>
                </div>
            </div>

            <div id="view-test" class="view-section">
                <h2>Evaluaci칩n (20 Aleatorias)</h2>
                <div id="test-container"></div>
                <button class="btn-enter" style="width:auto; margin-top:20px;" onclick="App.submitTest()">Corregir</button>
                <div id="test-result" style="margin-top:20px; font-weight:bold; font-size:1.2rem; text-align:center;"></div>
            </div>

            <div id="view-admin" class="view-section">
                <h2>Panel de Gesti칩n</h2>
                <div id="admin-tools">
                    <div style="background:white; padding:20px; border-radius:8px; margin-bottom:20px;">
                        <h3>A침adir Usuario</h3>
                        <input type="text" id="new-u" placeholder="Usuario" style="width:100%; padding:8px; margin-bottom:5px;">
                        <input type="text" id="new-p" placeholder="Clave" style="width:100%; padding:8px; margin-bottom:5px;">
                        <select id="new-r" style="width:100%; padding:8px; margin-bottom:5px;">
                            <optgroup label="Agentes"><option value="adc">Agente DC</option><option value="adt">Agente DT</option><option value="aut">Agente UT</option></optgroup>
                            <optgroup label="Mandos"><option value="mdc">Mando Calle</option><option value="mdt">Mando Territorial</option><option value="mut">Mando T칠cnico</option></optgroup>
                            <optgroup label="Direcci칩n"><option value="jef">Jefatura</option><option value="admin">Admin</option><option value="master">MASTER</option></optgroup>
                        </select>
                        <select id="new-b" style="width:100%; padding:8px; margin-bottom:10px; background:#f0f7ff;"><option value="">-- Asignar Mando --</option></select>
                        <button class="btn-enter" onclick="App.addUser()">Crear Usuario</button>
                    </div>
                    <div style="background:white; padding:20px; border-radius:8px; margin-bottom:20px;">
                        <h3>Importar Excel</h3>
                        <textarea id="import-data" class="import-area" placeholder="Usuario | Clave | Rol | Jefe"></textarea>
                        <button class="btn-enter" style="background:#27ae60;" onclick="App.importUsers()">Importar Masivo</button>
                        <p id="import-msg" style="color:green; font-weight:bold;"></p>
                    </div>
                </div>
                <h3>Resultados Acad칠micos</h3>
                <table class="admin-table"><thead><tr><th>Usuario</th><th>Rol</th><th>Fecha</th><th>Nota</th><th>Fallos</th><th>Mando Asignado</th></tr></thead><tbody id="admin-logs"></tbody></table>
                <div id="security-box" style="margin-top:30px; display:none;">
                    <h3 style="color:#c0392b"><i class="fas fa-shield-alt"></i> Auditor칤a de Seguridad</h3>
                    <div style="max-height:200px; overflow-y:auto; border:1px solid #ccc;">
                        <table class="admin-table" style="margin:0;"><thead><tr><th>Fecha</th><th>Usuario</th><th>Acci칩n</th><th>Detalle</th></tr></thead><tbody id="sec-logs"></tbody></table>
                    </div>
                </div>
                <button class="btn-enter" style="background:#c0392b; width:auto; margin-top:20px;" onclick="App.clearLogs()">Borrar Historial</button>
            </div>
        </div>
    </div>
</div>

<script>
const DB = {
    audio_url: "audio.m4a",
    imagenes: [
        {nombre: "Infograf칤a Estructura (Clic para ver)", url: "estructura.png"},
        {nombre: "Mapa Mental Protocolo (Clic para ver)", url: "mapa.png"}
    ],
    bibliografia: [
        {nivel: "Normativa", archivos: [{nombre:"OJ-PROTOCOLO-ACTUACION-SALAMANCA-FIRMADO (1).pdf", desc:"Protocolo Actuaci칩n"}, {nombre:"Anexo-I-Manual-de-Organizacion-Salamanca-firmado.pdf", desc:"Manual Organizaci칩n"}]},
        {nivel: "Manuales", archivos: [{nombre:"Anexo-II-Manual-del-SCT-Salamanca-firmado.pdf", desc:"Manual SCT"}, {nombre:"Anexo-III-Manual-del-SCG-Salamanca-firmado - copia.pdf", desc:"Manual SCG"}, {nombre:"Anexo-IV-Manual-SCEJ-Salamanca-firmado - copia.pdf", desc:"Manual SCEJ"}]},
        {nivel: "Recursos Gr치ficos", archivos: [{nombre: "estructura.png", desc: "Infograf칤a Estructura (Imagen)"}, {nombre: "mapa.png", desc: "Mapa Mental Protocolo (Imagen)"}]}
    ],
    secciones_temario: [
      { "titulo": "1. Introducci칩n", "contenido": "<h3>1. Introducci칩n</h3><p>Transformaci칩n del sistema judicial en Salamanca. Entrada en vigor: 31 diciembre 2025 (Ley Org치nica 1/2025). Objetivo: Agilidad, criterios homog칠neos, optimizaci칩n, interoperabilidad. Fin de los juzgados aislados.</p>" },
      { "titulo": "2. Visi칩n General", "contenido": "<h3>2. Visi칩n General</h3><p>Nueva relaci칩n funcional con servicios especializados.</p><h4>2.1 Tribunal de Instancia (TI)</h4><p>N칰cleo jurisdiccional. Integra todas las plazas anteriores. Secciones: Civil, Instrucci칩n, Familia, Penal, Menores, VP, Contencioso, Social.</p>" },
      { "titulo": "3. Servicios Comunes", "contenido": "<h3>2.2 Los Servicios Comunes</h3><p>Estructura de apoyo al TI y Audiencia Provincial.</p><ul><li><strong>SCG:</strong> Entrada 칰nica, registro, reparto, actos comunicaci칩n.</li><li><strong>SCT:</strong> Tramitaci칩n (Instrucci칩n y Enjuiciamiento).</li><li><strong>SCEJ:</strong> Ejecuci칩n de sentencias firmes.</li></ul>" },
      { "titulo": "4. Gu칤a Operativa", "contenido": "<h3>3. Gu칤a Operativa</h3><h4>3.1 Inicio Procedimiento</h4><p>Punto 칰nico entrada ordinaria: <strong>SCG</strong> (08:30-15:00). Registro y reparto a SCT Penal.</p><h4>3.2 Guardia</h4><p>Solo urgencias: Detenidos, citados ante juez guardia, E/R urgentes, Intervenciones telef칩nicas.</p>" },
      { "titulo": "5. Polic칤a Judicial", "contenido": "<h3>4. Manual Polic칤a Judicial</h3><h4>4.1 SCT Penal</h4><p>Gestiona fase declarativa. Equipos de Instrucci칩n y Enjuiciamiento.</p><h4>4.2 Unidades Especializadas</h4><p>Violencia Mujer (Grupo Instr. 3), Menores (SCT Enjuiciamiento), Familia (Internamientos).</p>" },
      { "titulo": "6. Ejecuci칩n", "contenido": "<h3>4.3 Fase Ejecuci칩n (SCEJ)</h3><p>Una vez firme la sentencia. Actuaciones: Mandamientos prisi칩n, busca y captura, libertad, multas, embargos.</p>" },
      { "titulo": "7. Digitalizaci칩n", "contenido": "<h3>4.4 Gesti칩n Digital</h3><p>Uso obligatorio canales telem치ticos (LexNet). Datos completos y normalizados. Evitar duplicidades.</p>" },
      { "titulo": "8. Mandos", "contenido": "<h3>5. Pautas Mandos</h3><p>Estructura: Director (LAJ) > Jefe 츼rea > Jefe Equipo. Coordinaci칩n: Comit칠 de Direcci칩n (Estrat칠gico) y Coordinaci칩n (Operativo).</p>" },
      { "titulo": "9. Protocolos", "contenido": "<h3>6. Instrucci칩n Jefatura</h3><p>Obligatoria. Vigor 31/12/2025.</p><ul><li>No urgente -> SCG</li><li>Urgente/Detenido -> Guardia</li><li>Ejecuci칩n -> SCEJ</li></ul>" },
      { "titulo": "10. Flujos", "contenido": "<h3>7. Flujos Operativos</h3><p><strong>Atestado:</strong> Polic칤a -> SCG -> SCT.</p><p><strong>Urgente:</strong> Polic칤a -> Guardia -> SCT.</p><p><strong>Ejecuci칩n:</strong> Sentencia -> SCEJ -> Polic칤a -> SCEJ.</p>" }
    ],
    // 100 TARJETAS REALES
    flashcards: [
        {f:"쮽echa entrada vigor?", b:"31 de diciembre de 2025"}, {f:"쯃ey reguladora?", b:"Ley Org치nica 1/2025"},
        {f:"칍rgano que sustituye juzgados?", b:"Tribunal de Instancia (TI)"}, {f:"쯇unto 칰nico entrada ordinaria?", b:"Servicio Com칰n General (SCG)"},
        {f:"쮿orario SCG?", b:"Lunes a Viernes 08:30 a 15:00"}, {f:"쮻칩nde entregar detenidos?", b:"Servicio de Guardia"},
        {f:"쯈ui칠n tramita la instrucci칩n?", b:"SCT (Servicio Com칰n Tramitaci칩n)"}, {f:"쯈ui칠n ejecuta sentencias?", b:"SCEJ (Servicio Com칰n Ejecuci칩n)"},
        {f:"쯄치xima autoridad funcional?", b:"Director del Servicio (LAJ)"}, {f:"쯈ui칠n resuelve errores de datos?", b:"Jefatura de Equipo tramitador"},
        {f:"쮻ocumento sin registrar?", b:"Remitir al SCG inmediatamente"}, {f:"쯋nidad Violencia Mujer?", b:"Grupo de Instrucci칩n n췈 3"},
        {f:"쮻칩nde est치 la Secci칩n Menores?", b:"SCT - Equipo de Enjuiciamiento"}, {f:"쯀nternamientos no voluntarios?", b:"SCT Civil (Familia)"},
        {f:"쯈ui칠n tramita busca y captura?", b:"SCEJ (Ejecuci칩n)"}, {f:"쮸veriguaci칩n patrimonial?", b:"SCEJ"},
        {f:"칍rgano estrat칠gico OJ?", b:"Comit칠 de Direcci칩n"}, {f:"쯇lataforma comunicaciones?", b:"LexNet"},
        {f:"쯉istema gesti칩n interna?", b:"Atenea"}, {f:"쮼nv칤o preferente?", b:"Telem치tico"},
        {f:"쮻elitos Leves?", b:"Grupos de Trabajo (SCT)"}, {f:"쮺oordinador de 츼rea?", b:"Jefatura de 츼rea (LAJ/GPA)"},
        {f:"쮽unciones SCG?", b:"Registro, Reparto, Actos Comunicaci칩n, Archivo"}, {f:"쯅otificaciones en calle?", b:"SCG - Equipo Actos Comunicaci칩n"},
        {f:"쮻ep칩sito de Efectos?", b:"SCG - Equipo 2"}, {f:"쮸pud-Acta?", b:"SCG - Equipo 1"},
        {f:"쯉ignificado SCT?", b:"Servicio Com칰n de Tramitaci칩n"}, {f:"쯉CT Audiencia Provincial?", b:"Independiente del TI"},
        {f:"쯉ignificado SCEJ?", b:"Servicio Com칰n de Ejecuci칩n"}, {f:"쯉ubastas judiciales?", b:"SCEJ"},
        {f:"쮺uenta Consignaciones?", b:"SCEJ"}, {f:"쯉ignificado OJM?", b:"Oficinas Justicia en el Municipio"},
        {f:"쯉ustituto Juzgado Paz?", b:"OJM"}, {f:"쯇ublicidad protocolo?", b:"Punto Acceso General (PAGAJ)"},
        {f:"Responsable Protecci칩n Datos?", b:"Director del Servicio Com칰n"}, {f:"쯅ormativa Datos?", b:"LOPJ, RGPD, LO 3/2018"},
        {f:"쮺ar치cter protocolo?", b:"Normativo, flexible, din치mico"}, {f:"쯌ideoconferencias?", b:"Sistema EVID"},
        {f:"쮺ontrol cuentas?", b:"Trimestral"}, {f:"쯉ustituciones SCT?", b:"Propone Jefatura de 츼rea"},
        {f:"쮸tenci칩n p칰blico?", b:"09:00 a 14:00"}, {f:"쮺omunicaci칩n entrada vigor?", b:"Sala Gobierno TSJ, Fiscal칤a, Gerencia"},
        {f:"쯅ivel 4 organizaci칩n?", b:"Unidades Funcionales"}, {f:"쯅ivel 1 organizaci칩n?", b:"Equipos"},
        {f:"쯈ui칠n firma protocolo?", b:"Secretario Coordinador y Secretario Gobierno"}, {f:"쯋bicaci칩n funcionarios?", b:"Por equipos de trabajo"},
        {f:"쮸rchivo Judicial Gesti칩n?", b:"SCG - Equipo 2"}, {f:"Registro electr칩nico?", b:"SIR"},
        {f:"쯆bjetivo OJM?", b:"Acercar justicia sin sede TI"}, {f:"쮻irecci칩n t칠cnico-procesal?", b:"Letrado Admon. Justicia (LAJ)"},
        {f:"쯈u칠 es UPAD?", b:"Unidad Procesal Apoyo Directo"}, {f:"쯈u칠 es SCP?", b:"Servicio Com칰n Procesal"},
        {f:"쯇lazo detenci칩n?", b:"72 horas m치ximo"}, {f:"쯇lazo Habeas Corpus?", b:"Resoluci칩n en 24h"},
        {f:"쮺ausas aforados?", b:"TSJ o Supremo"}, {f:"쯈u칠 es PNJ?", b:"Punto Neutro Judicial"},
        {f:"쯃evantamiento cad치ver?", b:"Juez Guardia + Forense"}, {f:"쯅otificaci칩n a Polic칤a?", b:"Unidad de Enlace/Gesti칩n"},
        {f:"쯈u칠 es un exhorto?", b:"Comunicaci칩n entre 칩rganos judiciales"}, {f:"쯈u칠 es un mandamiento?", b:"Orden a funcionario/polic칤a"},
        {f:"쯈u칠 es providencia?", b:"Resoluci칩n de tr치mite (Juez)"}, {f:"쮻iligencia ordenaci칩n?", b:"Impulso procesal (LAJ)"},
        {f:"쯈u칠 es Decreto?", b:"Resoluci칩n finalizadora (LAJ)"}, {f:"Recurso a Providencia?", b:"Reforma"},
        {f:"쯊asaci칩n costas?", b:"LAJ"}, {f:"쯊urno de oficio?", b:"Justicia Gratuita"},
        {f:"쮺ustodia expedientes vivos?", b:"SCT / SCEJ"}, {f:"쮺ustodia archivo?", b:"SCG"},
        {f:"쯈u칠 es SIRAJ?", b:"Sistema Registros Administrativos"}, {f:"Registro Penados?", b:"Sentencias firmes"},
        {f:"쯆rden alejamiento?", b:"Auto (Juez)"}, {f:"쯁uicio in voce?", b:"Sentencia oral en el acto"},
        {f:"쯇lazo apelaci칩n?", b:"10 d칤as"}, {f:"쮺onformidad?", b:"Reconoce hechos, reduce pena"},
        {f:"쮸siste levantamiento si no va Juez?", b:"LAJ (delegado) + Forense"}, {f:"쯈u칠 es reparto?", b:"Distribuci칩n asuntos (SCG)"},
        {f:"쯇ieza separada?", b:"Expediente paralelo"}, {f:"쯉ecreto sumario?", b:"Restricci칩n partes (no Fiscal)"},
        {f:"쯇ide prisi칩n provisional?", b:"Fiscal o Acusaci칩n"}, {f:"쯄치ximo prisi칩n prov.?", b:"2 a침os (delitos graves)"},
        {f:"쮽ianza pudendo?", b:"Libertad provisional"}, {f:"Responsabilidad civil?", b:"Indemnizaci칩n econ칩mica"},
        {f:"쮼jecuta trabajos beneficio?", b:"Inst. Penitenciarias / SCEJ"}, {f:"쮼xpurgo?", b:"Destrucci칩n expedientes"},
        {f:"쯃anzamiento?", b:"Desahucio forzoso"}, {f:"쮸compa침a Comisi칩n Judicial?", b:"Polic칤a (Auxilio)"},
        {f:"쮸veriguaci칩n patrimonial?", b:"B칰squeda bienes (PNJ)"}, {f:"Requisitoria?", b:"Busca y captura"},
        {f:"Rebeld칤a procesal?", b:"Ausencia injustificada"}, {f:"쯇rescribe delito leve?", b:"1 a침o"},
        {f:"쯇rescribe delito grave?", b:"20 a침os (>15 pena)"}, {f:"쮿abeas corpus ante qui칠n?", b:"Juez Instrucci칩n lugar"},
        {f:"쮸bogado en Habeas Corpus?", b:"No es obligatorio"}, {f:"쯃ECrim?", b:"Ley Enjuiciamiento Criminal"},
        {f:"쯃OPJ?", b:"Ley Org치nica Poder Judicial"}, {f:"쮼VID?", b:"Grabaci칩n Vistas"},
        {f:"쮽irma digital?", b:"Autenticaci칩n"}, {f:"쯅ombra peritos?", b:"칍rgano judicial"},
        {f:"쯋SB en juzgado?", b:"Prohibido (Seguridad)"}
    ],
    // 70 PREGUNTAS TEST REALES
    test: [
        {p:"쯇uerta 칰nica entrada ordinaria?", r:["Decanato","SCG","SCT"], c:1},
        {p:"쮿orario presentaci칩n SCG?", r:["09-14h","08:30-15:00","24h"], c:1},
        {p:"쮸testado con DETENIDO?", r:["SCG","Servicio Guardia","SCT"], c:1},
        {p:"쯈ui칠n gestiona la instrucci칩n?", r:["SCT Penal","SCEJ","SCG"], c:0},
        {p:"쯈ui칠n ejecuta una sentencia firme?", r:["SCT","SCEJ","Guardia"], c:1},
        {p:"쯄치xima autoridad funcional servicio?", r:["Decano","Director (LAJ)","Gestor"], c:1},
        {p:"쯋nidad Violencia G칠nero?", r:["Grupo Instr. 3","Menores","SCG"], c:0},
        {p:"쮼rror en DNI atestado?", r:["Devolver Comisar칤a","Jefe Equipo Tramitador","Decano"], c:1},
        {p:"쮻ocumento sin registrar?", r:["Archivar","Devolver a SCG","Procesar"], c:1},
        {p:"쯅otificaciones en calle?", r:["Polic칤a","SCG (Actos Com.)","SCT"], c:1},
        {p:"쮻칩nde se tramitan delitos leves?", r:["SCT (Grupos Trabajo)","SCEJ","Juzgado Paz"], c:0},
        {p:"쯈ui칠n gestiona embargos?", r:["SCT","SCEJ","SCG"], c:1},
        {p:"칍rgano estrat칠gico?", r:["Comit칠 Direcci칩n","Junta Personal","Sindicatos"], c:0},
        {p:"쯃ey reguladora NOJ?", r:["LO 1/2025","LECrim","Civil"], c:0},
        {p:"쯉olicitud E/R Urgente?", r:["SCG","Guardia","SCT"], c:1},
        {p:"쮻ep칩sito Efectos?", r:["SCG","SCT","Cient칤fica"], c:0},
        {p:"쯉ustituye Juzgados Paz?", r:["OJM","Ayuntamientos","Registro"], c:0},
        {p:"쮼ntrada en vigor?", r:["31/12/2025","01/01/2026","Inmediata"], c:0},
        {p:"쯊I sustituye a...?", r:["Audiencia","Juzgados Unipersonales","Supremo"], c:1},
        {p:"쯉istema gesti칩n procesal?", r:["Atenea","LexNet","Siraj"], c:0},
        {p:"쯈ui칠n hace el reparto?", r:["Decano","SCG","SCT"], c:1},
        {p:"쮻ivorcio contencioso?", r:["SCT Civil","SCEJ","SCG"], c:0},
        {p:"쮺oordinador de Equipo?", r:["Jefe 츼rea","Jefe Equipo","Direcci칩n"], c:1},
        {p:"쯉ecci칩n Menores?", r:["SCT Enjuiciamiento","Civil","SCEJ"], c:0},
        {p:"쮽irma mandamiento prisi칩n?", r:["Juez","LAJ","Gestor"], c:0},
        {p:"쯇AGAJ?", r:["Punto Acceso General","Sindicato","Juzgado"], c:0},
        {p:"쮾uardia 24h?", r:["S칤","No","Solo fines semana"], c:0},
        {p:"쮸testado directo a SCT?", r:["Devolver a SCG","Tramitar","Perder"], c:0},
        {p:"쮼jecuci칩n multas?", r:["SCEJ","SCT","Hacienda"], c:0},
        {p:"쮽ase declarativa?", r:["Instrucci칩n/Juicio","Ejecuci칩n","Recurso"], c:0},
        {p:"쮻irecci칩n personal diaria?", r:["Jefe Equipo","Juez","Fiscal"], c:0},
        {p:"쮸ntecedentes penales?", r:["Gerencia/SCG","Comisar칤a","Ayto"], c:0},
        {p:"쮼xpurgo?", r:["Junta/SCG","Limpieza","Polic칤a"], c:0},
        {p:"쯇residente TI?", r:["S칤","No","A veces"], c:0},
        {p:"쮺aja Dep칩sitos?", r:["SCEJ","Banco","SCG"], c:0},
        {p:"쯃anzamientos?", r:["SCG (Actos Com.)","SCT","SCEJ"], c:0},
        {p:"쯌ideoconferencias?", r:["SCG/SCT","Polic칤a","Prisi칩n"], c:0},
        {p:"쯄edios telem치ticos?", r:["Obligatorio","Opcional","Solo graves"], c:0},
        {p:"쯊rabajos beneficio?", r:["SCEJ","SCT","Polic칤a"], c:0},
        {p:"쯆bjetivo NOJ?", r:["Agilidad","Ahorro","Personal"], c:0},
        {p:"쯇rincipio actuaci칩n SCP?", r:["Independencia","Jerarqu칤a","Autonom칤a"], c:1},
        {p:"쮻irecci칩n t칠cnico-procesal?", r:["Decano","LAJ Director","Fiscal"], c:1},
        {p:"쮺ertificaci칩n archivo?", r:["SCG","SCT","Decanato"], c:0},
        {p:"쯉oporte varios 칩rganos?", r:["UPAD","SCP","Juzgados"], c:1},
        {p:"쮸utoriza E/R Instrucci칩n?", r:["LAJ","Juez","Comisario"], c:1},
        {p:"쯇iezas t칩xicas?", r:["Despacho Juez","Protocolo destrucci칩n","Devolver"], c:1},
        {p:"쯃anzamientos SCEJ?", r:["No","S칤","Solo Juez"], c:1},
        {p:"쮼scritos tr치mite?", r:["Juez","SCG","Comisar칤a"], c:1},
        {p:"쮼mbargo cuentas?", r:["PNJ","Google","Agencia"], c:0},
        {p:"쯁efe Auxilio Judicial?", r:["Gestor","LAJ Director","Polic칤a"], c:1},
        {p:"쯉alas Vistas?", r:["SCT/SCG","Limpieza","Abogados"], c:0},
        {p:"쯅otifica sentencia?", r:["Juez","SCG","Abogado"], c:1},
        {p:"쯇lazo detenci칩n?", r:["72h","24h","48h"], c:0},
        {p:"쮺itaci칩n polic칤a juicio?", r:["Tel칠fono","Conducto/Gesti칩n","Correo"], c:1},
        {p:"쮸tt. Ciudadano?", r:["Externo","Unidad OJ","ONG"], c:1},
        {p:"쯉ecreto sumario?", r:["LAJ","Juez","Polic칤a"], c:1},
        {p:"쯊asaci칩n costas?", r:["Colegio","LAJ","Juez"], c:1},
        {p:"쯀nicio Habeas Corpus?", r:["Querella","Solicitud","Atestado"], c:1},
        {p:"쯋bicaci칩n SCG?", r:["Comisar칤a","Sede Juzgados","Ayto"], c:1},
        {p:"쯊urno oficio?", r:["Colegio","Decano","SCG"], c:0},
        {p:"Recurso Diligencia?", r:["Reposici칩n","Amparo","Nada"], c:0},
        {p:"쮸cceso Atenea Polic칤a?", r:["S칤 total","Pasarelas","Cualquiera"], c:1},
        {p:"쯇reside Junta Jueces?", r:["Decano","Audiencia","LAJ"], c:0},
        {p:"쮽orense Guardia?", r:["Urgencias","Detenidos/Levantamientos","Sustituto"], c:1},
        {p:"쮸gosto h치bil?", r:["Nunca","Causas urgentes","Ma침anas"], c:1},
        {p:"쯁urisdicci칩n Voluntaria?", r:["SCT Civil","SCEJ","Registro"], c:0},
        {p:"쮽e p칰blica?", r:["Juez","LAJ","Polic칤a"], c:1},
        {p:"쮼xhorto?", r:["Multa","Auxilio Judicial","Sentencia"], c:1},
        {p:"쮼jecuta desahucio?", r:["Comisi칩n Judicial","Propietario","Ayto"], c:0},
        {p:"쮻ecomiso l칤cito?", r:["Polic칤a","Realizaci칩n/Destrucci칩n","Basura"], c:1}
    ]
};

const App = {
    data: DB,
    user: null,
    dbUsers: 'noj_users_vFINAL_70', dbLogs: 'noj_logs_vFINAL_70', dbSec: 'noj_sec_vFINAL_70',

    init: async () => {
        document.addEventListener('keyup', (e) => {
            if(e.key === 'Enter' && !document.getElementById('login-screen').classList.contains('hidden')) App.login();
        });

        // 1. INICIALIZAR USUARIOS (SI NO EXISTEN)
        if(!localStorage.getItem(App.dbUsers)) {
            const defs = [
                { u:'master', p:'master', r:'master', boss:'', change:true },
                { u:'admin', p:'admin', r:'admin', boss:'', change:true },
                { u:'jefatura', p:'jefatura', r:'jef', boss:'', change:true },
                { u:'mandodc', p:'1234', r:'mdc', boss:'', change:true },
                { u:'mandodt', p:'1234', r:'mdt', boss:'', change:true },
                { u:'mandout', p:'1234', r:'mut', boss:'', change:true },
                { u:'agentedc', p:'1234', r:'adc', boss:'mandodc', change:true }
            ];
            localStorage.setItem(App.dbUsers, JSON.stringify(defs));
            App.logSec('SYSTEM', 'Init Final v70');
        }

        // 2. ALEATORIEDAD REAL (Shuffle & Slice cada vez que carga)
        if(App.data.flashcards) App.sessionCards = App.shuffle([...App.data.flashcards]).slice(0, 30);
        if(App.data.test) App.sessionTest = App.shuffle([...App.data.test]).slice(0, 20);

        // 3. RENDERIZADO
        App.renderTemario();
        App.renderBiblio(); 
        App.renderMedia(); 
        App.renderFC(); 
        App.renderTest();
        
        // 4. AUDIO
        if(document.getElementById('main-audio')) document.getElementById('main-audio').src = App.data.audio_url;
    },

    shuffle: (a) => { for(let i=a.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; },

    logSec: (a, d) => {
        const l = JSON.parse(localStorage.getItem(App.dbSec)||'[]');
        l.unshift({d:new Date().toLocaleString(), u:App.user?App.user.u:'GUEST', a:a, t:d});
        if(l.length>100) l.pop(); localStorage.setItem(App.dbSec, JSON.stringify(l));
    },

    login: () => {
        const u = document.getElementById('user').value.trim();
        const p = document.getElementById('pass').value.trim();
        const users = JSON.parse(localStorage.getItem(App.dbUsers));
        const found = users.find(x => x.u === u && x.p === p);
        if(found) {
            App.user = found;
            if(found.change) { document.getElementById('login-screen').style.display='none'; document.getElementById('password-screen').classList.remove('hidden'); return; }
            App.enterApp();
        } else { document.getElementById('msg').innerText = "Credenciales incorrectas"; App.logSec('LOGIN_FAIL', u); }
    },

    changePass: () => {
        const p1 = document.getElementById('new-p1').value; const p2 = document.getElementById('new-p2').value;
        if(p1.length<4 || p1!==p2) return document.getElementById('pass-msg').innerText = "Error contrase침a";
        const users = JSON.parse(localStorage.getItem(App.dbUsers));
        const idx = users.findIndex(x => x.u === App.user.u);
        users[idx].p = p1; users[idx].change = false;
        localStorage.setItem(App.dbUsers, JSON.stringify(users)); App.user.p = p1;
        App.logSec('PASS_CHANGE', App.user.u); document.getElementById('password-screen').classList.add('hidden'); App.enterApp();
    },

    enterApp: () => {
        document.getElementById('login-screen').style.display='none';
        document.getElementById('main-app').style.display='flex';
        document.getElementById('display-user').innerText = App.user.u.toUpperCase();
        App.logSec('LOGIN_OK', App.user.u);
        if(['admin','master','jef','mdc','mdt','mut'].includes(App.user.r)) { document.getElementById('menu-admin').classList.remove('hidden'); App.renderAdmin(); }
    },

    renderTemario: () => {
        const t = document.getElementById('doc-tabs'), c = document.getElementById('doc-content'); t.innerHTML=''; c.innerHTML='';
        App.data.secciones_temario.forEach((s,i) => {
            t.innerHTML += `<button class="doc-tab ${i===0?'active':''}" onclick="App.tab(${i})">${s.titulo}</button>`;
            c.innerHTML += `<div id="p${i}" class="doc-page ${i===0?'active':''}">${s.contenido}</div>`;
        });
    },
    tab: (i) => {
        document.querySelectorAll('.doc-tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.doc-page').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.doc-tab')[i].classList.add('active');
        document.getElementById('p'+i).classList.add('active');
    },

    renderBiblio: () => { 
        document.getElementById('file-tree').innerHTML = ''; 
        App.data.bibliografia.forEach(c => { 
            let l = c.archivos.map(f => `<li style="margin-bottom:5px;"><a href="${f.nombre}" target="_blank" style="text-decoration:none; color:#0a2e5c;">游늯 ${f.desc}</a></li>`).join(''); 
            document.getElementById('file-tree').innerHTML += `<li style="margin-bottom:15px;"><strong>${c.nivel}</strong><ul style="list-style:none; padding-left:10px;">${l}</ul></li>`; 
        }); 
    },

    renderMedia: () => {
        const c = document.getElementById('media-container'); c.innerHTML='';
        // IM츼GENES -> CLICK -> NUEVA PESTA칌A (SOLUCI칍N DEFINITIVA DE ZOOM)
        App.data.imagenes.forEach(i => c.innerHTML += `<div class="media-card" onclick="window.open('${i.url}','_blank')"><img src="${i.url}" onerror="this.src='//via.placeholder.com/300'"><p>${i.nombre}</p></div>`);
    },

    renderFC: () => { App.fcI=0; App.drawFC(); },
    drawFC: () => {
        if(!App.sessionCards) return;
        const c = App.sessionCards[App.fcI];
        document.getElementById('fc-canvas').innerHTML = `<div class="fc-inner"><div class="fc-face fc-front"><div><i class="fas fa-question-circle fa-2x"></i><br><br>${c.front}</div></div><div class="fc-face fc-back"><div>${c.back}</div></div></div>`;
        document.getElementById('fc-canvas').onclick = function() { this.classList.toggle('fc-flipped'); };
        document.getElementById('fc-count').innerText = `${App.fcI+1} / ${App.sessionCards.length}`;
    },
    moveFC: (d) => {
        App.fcI += d; 
        if(App.fcI < 0) App.fcI = App.sessionCards.length - 1;
        if(App.fcI >= App.sessionCards.length) App.fcI = 0;
        document.getElementById('fc-canvas').classList.remove('fc-flipped'); 
        setTimeout(() => App.drawFC(), 200);
    },

    renderTest: () => {
        document.getElementById('test-container').innerHTML = App.sessionTest.map((q,i) => `<div class="q-block" data-c="${q.correcta}"><p><b>${i+1}. ${q.pregunta}</b></p>${q.respuestas.map(r => `<div class="quiz-option" onclick="App.selOpt(this)">${r}</div>`).join('')}</div>`).join('');
    },
    selOpt: (el) => {
        el.parentElement.querySelectorAll('.quiz-option').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
    },
    submitTest: () => {
        let s = 0; document.querySelectorAll('.q-block').forEach(b => {
            const sel = b.querySelector('.selected'); const c = parseInt(b.dataset.c); const opts = b.querySelectorAll('.quiz-option');
            opts.forEach(o => o.classList.remove('correct','wrong'));
            if(sel) { if(Array.from(opts).indexOf(sel)===c) { sel.classList.add('correct'); s++; } else { sel.classList.add('wrong'); opts[c].classList.add('correct'); } }
        });
        document.getElementById('test-result').innerText = `Resultado: ${s} / 20 Aciertos`;
        const logs = JSON.parse(localStorage.getItem(App.dbLogs)||'[]');
        logs.push({u:App.user.u, d:new Date().toLocaleDateString(), s:s, f:20-s});
        localStorage.setItem(App.dbLogs, JSON.stringify(logs));
        if(['admin','master'].includes(App.user.r)) App.renderAdmin();
    },

    renderAdmin: () => {
        const global = ['admin','master'].includes(App.user.r); const jefatura = App.user.r === 'jef';
        const logs = JSON.parse(localStorage.getItem(App.dbLogs)||'[]'); const users = JSON.parse(localStorage.getItem(App.dbUsers));
        const t = document.getElementById('admin-logs'); t.innerHTML='';

        if(!global) document.getElementById('admin-tools').style.display='none';
        else {
            const bs = document.getElementById('new-b'); bs.innerHTML = '<option value="">-- Asignar Jefe --</option>';
            users.filter(u => ['mdc','mdt','mut','jef'].includes(u.r)).forEach(b => { bs.innerHTML += `<option value="${b.u}">${b.u} (${b.r})</option>`; });
        }

        // AUDITOR칈A SOLO VISIBLE PARA MASTER/ADMIN
        if(global) {
            document.getElementById('security-box').style.display='block';
            const sl = JSON.parse(localStorage.getItem(App.dbSec)||'[]'); const st = document.getElementById('sec-logs'); st.innerHTML='';
            sl.forEach(s => st.innerHTML += `<tr><td>${s.d}</td><td>${s.u}</td><td>${s.a}</td><td>${s.t || ''}</td></tr>`);
        } else { document.getElementById('security-box').style.display='none'; }

        logs.forEach(l => {
            let show = false; const uData = users.find(x => x.u === l.u); const boss = uData ? uData.boss : '';
            if(global || jefatura) show = true; else if(boss === App.user.u) show = true;
            if(show) t.innerHTML += `<tr><td>${l.u}</td><td>${uData?uData.r:'?'}</td><td>${l.d}</td><td>${l.s}</td><td>${boss}</td></tr>`;
        });
    },

    addUser: () => {
        const u = document.getElementById('new-u').value; const p = document.getElementById('new-p').value; const r = document.getElementById('new-r').value; const b = document.getElementById('new-b').value;
        const users = JSON.parse(localStorage.getItem(App.dbUsers));
        if(users.find(x=>x.u===u)) return alert("Existe");
        users.push({u,p,r,boss:b, change:true}); localStorage.setItem(App.dbUsers, JSON.stringify(users));
        App.logSec('CREATE', u); App.renderAdmin(); alert("Ok");
    },
    importUsers: () => {
        const raw = document.getElementById('import-data').value; const users = JSON.parse(localStorage.getItem(App.dbUsers));
        const map = {'AGENTE (DC)':'adc','AGENTE (DT)':'adt','AGENTE (UT)':'aut','MANDO (DC)':'mdc','MANDO (DT)':'mdt','MANDO (UT)':'mut','JEFATURA':'jef','ADMIN':'admin','MASTER':'master'};
        let c=0;
        raw.split('\n').forEach(l => {
            let p = l.split(/\t+/); if(p.length<2) p=l.split(/\s+/);
            if(p.length>=2) {
                let r = map[p[2]] || 'adc';
                if(!users.find(x=>x.u===p[0])) { users.push({u:p[0], p:p[1], r:r, boss:p[3]||'', change:true}); c++; }
            }
        });
        localStorage.setItem(App.dbUsers, JSON.stringify(users)); document.getElementById('import-msg').innerText = `+${c}`; App.logSec('IMPORT', c); App.renderAdmin();
    },
    clearLogs: () => { if(confirm("쮹orrar?")) { localStorage.removeItem(App.dbLogs); App.renderAdmin(); }},
    nav: (id) => { document.querySelectorAll('.view-section').forEach(x=>x.classList.remove('active')); document.getElementById('view-'+id).classList.add('active'); }
};
window.onload = App.init;
</script>
</body>
</html>
