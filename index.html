<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma Formaci√≥n Policial - NOJ Salamanca</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #0a2e5c; --accent: #d4af37; --bg: #f4f7f9; --text: #333; --danger: #c0392b; --success: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* --- ESTILOS DE LOGIN --- */
        #login-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000;
            background: linear-gradient(rgba(10,46,92,0.9), rgba(10,46,92,0.9)), url('jefatura.jpg') no-repeat center center fixed;
            background-size: cover;
            display: flex; justify-content: center; align-items: center;
        }
        .login-card { background: white; padding: 40px; border-radius: 12px; width: 350px; text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.5); }
        .login-card img { width: 100px; margin-bottom: 20px; }
        .login-card input { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        .btn-enter { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 15px; }

        /* --- LAYOUT APP --- */
        #main-app { display: none; height: 100%; flex-direction: column; }
        .app-header { background: white; padding: 10px; text-align: center; border-bottom: 4px solid var(--accent); flex-shrink: 0; }
        .app-header img { height: 80px; width: auto; max-width: 100%; } 
        
        .top-bar { background: var(--primary); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .btn-logout { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        .content-area { flex: 1; display: flex; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 260px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; }
        .sidebar-logo { text-align: center; padding: 20px; border-bottom: 1px solid #eee; }
        .sidebar-logo img { width: 120px; }
        .menu-item { padding: 15px; cursor: pointer; border-bottom: 1px solid #eee; color: #555; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background: #f0f4f8; color: var(--primary); border-left: 4px solid var(--primary); }
        .menu-item i { width: 25px; text-align: center; margin-right: 10px; }

        .viewport { flex: 1; padding: 30px; overflow-y: auto; background: #f4f7f9; position: relative; }
        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }

        /* --- TEMARIO --- */
        .doc-nav { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 20px; }
        .doc-tab { 
            padding: 10px; background: #e0e0e0; border: none; border-radius: 5px; 
            cursor: pointer; font-weight: bold; font-size: 0.8rem; text-align: center; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        .doc-tab.active { background: var(--primary); color: white; }
        .doc-page { display: none; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); line-height: 1.6; text-align: justify; }
        .doc-page.active { display: block; }
        .doc-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .doc-table th, .doc-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .doc-table th { background: #f1f1f1; }

        /* --- FLASHCARDS --- */
        .fc-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .fc-container { perspective: 1000px; height: 320px; width: 100%; max-width: 600px; cursor: pointer; position: relative; z-index: 1; }
        .fc-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .fc-flipped .fc-inner { transform: rotateY(180deg); }
        .fc-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; padding: 30px; text-align: center; border-radius: 15px; font-size: 1.3rem; box-sizing: border-box; background: white; border: 3px solid var(--primary); }
        .fc-front { background: var(--primary); color: white; z-index: 2; transform: rotateY(0deg); }
        .fc-back { transform: rotateY(180deg); color: #333; }
        .fc-controls { display: flex; gap: 20px; z-index: 10; margin-bottom: 50px; }
        .btn-fc { padding: 12px 30px; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; width: 140px; }
        .btn-prev { background: #c0392b; }
        .btn-next { background: #27ae60; }

        /* --- TEST --- */
        .quiz-option { padding: 15px; margin: 10px 0; background: white; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; display: flex; align-items: center; position: relative; z-index: 5; }
        .quiz-option:hover { background: #f9f9f9; }
        .quiz-option.selected { background: #e3f2fd; border-color: var(--primary); }
        .quiz-option.correct { background: #d4edda; border-color: green; }
        .quiz-option.wrong { background: #f8d7da; border-color: red; }

        /* --- VISOR MULTIMEDIA CORREGIDO --- */
        #lightbox { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.98); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; 
        }
        #lightbox-container { 
            width: 90%; height: 80%; background: #222; border: 1px solid #555; 
            overflow: auto; /* ESTO PERMITE EL SCROLL */
            display: block; /* IMPORTANTE: Block para que funcione el scroll */
            text-align: center;
        }
        #lightbox-img { 
            width: 100%; height: auto; max-width: none !important; 
            transition: width 0.2s ease; transform-origin: top center; display: inline-block;
        }
        #lightbox-controls { margin-top: 15px; display: flex; gap: 15px; align-items: center; background: rgba(255,255,255,0.2); padding: 10px 25px; border-radius: 50px; }
        #lightbox-close { position: absolute; top: 20px; right: 30px; color: white; font-size: 4rem; cursor: pointer; z-index: 10001; }
        input[type=range] { width: 250px; cursor: pointer; }

        /* ADMIN & UTILS */
        .admin-table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; font-size: 0.9rem; }
        .admin-table th, .admin-table td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        .admin-table th { background: #eee; }
        .media-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .media-card { background: white; padding: 15px; cursor: pointer; text-align: center; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .media-card img { max-width: 100%; height: 180px; object-fit: cover; border-radius: 4px; }
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="lightbox">
        <span id="lightbox-close" onclick="App.closeLightbox()">&times;</span>
        <div id="lightbox-container"><img id="lightbox-img" src=""></div>
        <div id="lightbox-controls">
            <span style="color:white"><i class="fas fa-search-minus"></i></span>
            <input type="range" min="1" max="4" step="0.1" value="1" oninput="App.zoom(this.value)">
            <span style="color:white"><i class="fas fa-search-plus"></i></span>
        </div>
        <div id="lightbox-caption" style="color:white; margin-top:10px;"></div>
    </div>

    <div id="login-screen">
        <div class="login-card">
            <img src="poli (2).png" alt="Logo">
            <h2>Acceso Restringido</h2>
            <p>NOJ Salamanca</p>
            <input type="text" id="user" placeholder="Usuario">
            <input type="password" id="pass" placeholder="Contrase√±a">
            <button class="btn-enter" onclick="App.login()">Entrar</button>
            <p id="msg" style="color:red; margin-top:10px;"></p>
        </div>
    </div>

    <div id="password-screen" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--primary); z-index:6000; display:flex; justify-content:center; align-items:center;">
        <div class="login-card">
            <h2 style="color:#c0392b">Seguridad</h2>
            <p>Cambie su contrase√±a inicial.</p>
            <input type="password" id="new-p1" placeholder="Nueva Contrase√±a">
            <input type="password" id="new-p2" placeholder="Repita Contrase√±a">
            <button class="btn-enter" onclick="App.changePass()">Guardar</button>
        </div>
    </div>

    <div id="main-app">
        <div class="app-header"><img src="pie175PLSA.jpg" alt="Cabecera"></div>
        <div class="top-bar">
            <span id="user-display"></span>
            <button class="btn-logout" onclick="App.logout()">Salir</button>
        </div>
        
        <div class="content-area">
            <div class="sidebar">
                <div class="sidebar-logo"><img src="escudoPLSA.jpg"></div>
                <div class="menu-item active" onclick="App.nav('temario')"><i class="fas fa-book"></i> Temario</div>
                <div class="menu-item" onclick="App.nav('biblio')"><i class="fas fa-folder"></i> Documentaci√≥n</div>
                <div class="menu-item" onclick="App.nav('media')"><i class="fas fa-image"></i> Multimedia</div>
                <div class="menu-item" onclick="App.nav('flashcards')"><i class="fas fa-brain"></i> Tarjetas</div>
                <div class="menu-item" onclick="App.nav('test')"><i class="fas fa-check-circle"></i> Test</div>
                <div class="menu-item hidden" id="menu-admin" onclick="App.nav('admin')"><i class="fas fa-users-cog"></i> Gesti√≥n</div>
            </div>

            <div class="viewport">
                <div id="view-temario" class="view-section active">
                    <h2>Gu√≠a Operativa</h2>
                    <div id="doc-tabs" class="doc-nav"></div>
                    <div id="doc-content"></div>
                </div>

                <div id="view-biblio" class="view-section">
                    <h2>Biblioteca Digital</h2>
                    <ul id="file-tree" style="list-style:none; padding:0;"></ul>
                </div>

                <div id="view-media" class="view-section">
                    <h2>Recursos Multimedia</h2>
                    <div id="media-container" class="media-grid"></div>
                    <div style="margin-top:20px; background:white; padding:20px; border-radius:8px;">
                        <h3>Audio Resumen</h3>
                        <audio id="main-audio" controls style="width:100%"></audio>
                    </div>
                </div>

                <div id="view-flashcards" class="view-section">
                    <h2 style="text-align:center">Entrenamiento (30 Aleatorias)</h2>
                    <div class="fc-wrapper">
                        <div id="fc-canvas" class="fc-container"></div>
                        <div class="fc-controls">
                            <button class="btn-fc" style="background:#c0392b" onclick="App.moveFC(-1)">Anterior</button>
                            <span id="fc-count" style="align-self:center; font-weight:bold;"></span>
                            <button class="btn-fc" style="background:#27ae60" onclick="App.moveFC(1)">Siguiente</button>
                        </div>
                    </div>
                </div>

                <div id="view-test" class="view-section">
                    <h2>Evaluaci√≥n (20 Aleatorias)</h2>
                    <div id="test-container"></div>
                    <button class="btn-enter" style="width:auto; margin-top:20px;" onclick="App.submitTest()">Corregir</button>
                    <div id="test-result" style="margin-top:20px; font-weight:bold; font-size:1.2rem; text-align:center;"></div>
                </div>

                <div id="view-admin" class="view-section">
                    <h2 id="admin-title">Panel de Gesti√≥n</h2>
                    
                    <div id="admin-tools" style="background:white; padding:20px; border-radius:8px; margin-bottom:20px;">
                        <h3>A√±adir Usuario</h3>
                        <input type="text" id="new-u" placeholder="Usuario" style="width:100%; padding:8px; margin-bottom:5px;">
                        <input type="text" id="new-p" placeholder="Clave" style="width:100%; padding:8px; margin-bottom:5px;">
                        <select id="new-r" style="width:100%; padding:8px; margin-bottom:5px;">
                            <optgroup label="Agentes">
                                <option value="adc">Agente DC</option>
                                <option value="adt">Agente DT</option>
                                <option value="aut">Agente UT</option>
                            </optgroup>
                            <optgroup label="Mandos">
                                <option value="mdc">Mando Calle (MDC)</option>
                                <option value="mdt">Mando Territorial (MDT)</option>
                                <option value="mut">Mando T√©cnico (MUT)</option>
                            </optgroup>
                            <optgroup label="Direcci√≥n">
                                <option value="jef">Jefatura (JEF)</option>
                                <option value="admin">Administrador</option>
                                <option value="master">MASTER</option>
                            </optgroup>
                        </select>
                        <select id="new-b" style="width:100%; padding:8px; margin-bottom:10px; background:#f0f7ff;">
                            <option value="">-- Asignar Jefe --</option>
                        </select>
                        <button class="btn-enter" onclick="App.addUser()">Crear</button>
                        
                        <hr style="margin: 20px 0;">
                        <h3>Importar Excel</h3>
                        <p style="font-size:0.8rem;">Pegar columnas: <b>Usuario | Clave | Rol | Jefe</b></p>
                        <textarea id="import-data" style="width:100%; height:80px; padding:10px;" placeholder="agente1   1234   adc   mando1"></textarea>
                        <button class="btn-enter" style="background:#27ae60;" onclick="App.importUsers()">Importar Masivo</button>
                        <p id="import-msg" style="color:green; font-weight:bold;"></p>
                    </div>

                    <h3 id="logs-title">Resultados</h3>
                    <table class="admin-table">
                        <thead><tr><th>Usuario</th><th>Rol</th><th>Fecha</th><th>Nota</th><th>Fallos</th><th>Jefe</th></tr></thead>
                        <tbody id="admin-logs"></tbody>
                    </table>
                    
                    <div id="security-box" style="margin-top:30px; display:none;">
                        <h3 style="color:#c0392b"><i class="fas fa-shield-alt"></i> Auditor√≠a de Seguridad</h3>
                        <div style="max-height:200px; overflow-y:auto; border:1px solid #ccc;">
                            <table class="admin-table" style="margin:0;"><thead><tr><th>Fecha</th><th>Usuario</th><th>Acci√≥n</th><th>Detalle</th></tr></thead><tbody id="sec-logs"></tbody></table>
                        </div>
                    </div>
                    
                    <button class="btn-enter" style="background:#c0392b; width:auto; margin-top:20px;" onclick="App.clearLogs()">Borrar Historial</button>
                </div>
            </div>
        </div>
    </div>

<script>
// --- DATOS INCRUSTADOS PARA EVITAR ERRORES DE CARGA ---
const DB = {
    audio_url: "audio.m4a",
    imagenes: [
        {nombre: "Infograf√≠a Estructura (Clic para ver)", url: "estructura.png"},
        {nombre: "Mapa Mental Protocolo (Clic para ver)", url: "mapa.png"}
    ],
    bibliografia: [
        {nivel: "Normativa", archivos: [{nombre:"OJ-PROTOCOLO-ACTUACION-SALAMANCA-FIRMADO (1).pdf", desc:"Protocolo"}, {nombre:"Anexo-I-Manual-de-Organizacion-Salamanca-firmado.pdf", desc:"Manual Org"}]},
        {nivel: "Manuales", archivos: [{nombre:"Anexo-II-Manual-del-SCT-Salamanca-firmado.pdf", desc:"Manual SCT"}, {nombre:"Anexo-III-Manual-del-SCG-Salamanca-firmado - copia.pdf", desc:"Manual SCG"}, {nombre:"Anexo-IV-Manual-SCEJ-Salamanca-firmado - copia.pdf", desc:"Manual SCEJ"}]},
        {nivel: "Recursos Gr√°ficos", archivos: [{nombre: "estructura.png", desc: "Infograf√≠a Estructura (Imagen)"}, {nombre: "mapa.png", desc: "Mapa Mental Protocolo (Imagen)"}]}
    ],
    secciones_temario: [
        { "titulo": "1. Introducci√≥n", "contenido": "<h3>1. Introducci√≥n: La transformaci√≥n del sistema judicial en Salamanca</h3><p>El presente documento tiene como finalidad servir de manual operativo y de referencia permanente para todos los miembros de la Polic√≠a Local de Salamanca, con independencia de su escala o destino funcional, ante la implantaci√≥n del nuevo modelo de Oficina Judicial (OJ).</p><p>Este modelo, que entrar√° en vigor el <strong>31 de diciembre de 2025</strong>, deriva de la Ley Org√°nica 1/2025, y supone una modificaci√≥n estructural profunda del funcionamiento de la Administraci√≥n de Justicia. Se abandona definitivamente el esquema tradicional de juzgados individuales y aislados para pasar a un sistema integrado, centralizado y especializado de servicios comunes, orientado a:</p><ul><li>Incrementar la agilidad en la tramitaci√≥n de los procedimientos.</li><li>Garantizar criterios homog√©neos de actuaci√≥n.</li><li>Optimizar los recursos humanos y materiales.</li><li>Facilitar la interoperabilidad digital entre operadores jur√≠dicos.</li></ul><p>Para la Polic√≠a Local, este cambio tiene una repercusi√≥n directa y diaria: var√≠an los puntos de entrada de la documentaci√≥n, los interlocutores, los circuitos de tramitaci√≥n y los responsables de cada fase del procedimiento. Un conocimiento preciso de esta arquitectura es indispensable para evitar errores, retrasos, devoluciones de atestados y disfunciones operativas.</p>" },
        { "titulo": "2. Visi√≥n General", "contenido": "<h3>2. Visi√≥n general de la nueva Oficina Judicial (OJ)</h3><p>La nueva OJ redefine completamente la relaci√≥n funcional entre la Polic√≠a Local y la Administraci√≥n de Justicia. Ya no se interact√∫a con ‚Äúun juzgado concreto‚Äù, sino con servicios especializados que asumen funciones bien delimitadas.</p><p>Conocer este mapa organizativo permite:</p><ul><li>Dirigir correctamente cada actuaci√≥n policial.</li><li>Identificar con rapidez el √≥rgano competente.</li><li>Reducir tiempos muertos y reiteraciones documentales.</li><li>Mejorar la coordinaci√≥n en actuaciones urgentes y complejas.</li></ul><h4>2.1 El Tribunal de Instancia (TI): eje del nuevo sistema judicial</h4><p>El Tribunal de Instancia (TI) de Salamanca constituye el n√∫cleo jurisdiccional del nuevo modelo. Integra en una √∫nica estructura todas las anteriores plazas judiciales del partido judicial, organizadas internamente en secciones por materias, lo que favorece la especializaci√≥n y la coherencia en la respuesta judicial.</p><p><strong>Secciones del Tribunal de Instancia de Salamanca:</strong></p><ul><li>Secci√≥n Civil</li><li>Secci√≥n de Instrucci√≥n</li><li>Secci√≥n de Familia, Infancia y Capacidad</li><li>Secci√≥n de lo Penal</li><li>Secci√≥n de Menores</li><li>Secci√≥n de Vigilancia Penitenciaria</li><li>Secci√≥n de lo Contencioso-Administrativo</li><li>Secci√≥n de lo Social</li></ul><p>Cada secci√≥n ejerce la funci√≥n jurisdiccional (juzgar y resolver), mientras que la tramitaci√≥n material de los procedimientos se encomienda a los Servicios Comunes.</p>" },
        { "titulo": "3. Servicios Comunes", "contenido": "<h3>2.2 Los Servicios Comunes: columna vertebral de la Oficina Judicial</h3><p>La Oficina Judicial se estructura en tres Servicios Comunes, que prestan apoyo tanto al Tribunal de Instancia como a la Audiencia Provincial. Cada uno tiene competencias exclusivas y claramente delimitadas.</p><table class='doc-table'><tr><th>Servicio Com√∫n</th><th>Acr√≥nimo</th><th>Funci√≥n principal</th></tr><tr><td>Servicio Com√∫n General</td><td><strong>SCG</strong></td><td>Punto √∫nico de entrada: recepci√≥n, registro, reparto, actos de comunicaci√≥n y archivo</td></tr><tr><td>Servicio Com√∫n de Tramitaci√≥n</td><td><strong>SCT</strong></td><td>Gesti√≥n integral de los procedimientos en fase declarativa (instrucci√≥n y enjuiciamiento)</td></tr><tr><td>Servicio Com√∫n de Ejecuci√≥n</td><td><strong>SCEJ</strong></td><td>Ejecuci√≥n de resoluciones judiciales firmes</td></tr></table><p>Este modelo elimina duplicidades y asegura que cada documento policial siga un circuito previsible y trazable.</p>" },
        { "titulo": "4. Gu√≠a Operativa", "contenido": "<h3>3. Gu√≠a operativa para la escala ejecutiva de la Polic√≠a Local</h3><p>Esta secci√≥n est√° orientada al personal operativo y de patrulla, que constituye el primer eslab√≥n del procedimiento judicial. Se centra en las actuaciones m√°s frecuentes y cr√≠ticas.</p><h4>3.1 Inicio del procedimiento: destino correcto del atestado o informe policial</h4><p><strong>Principio fundamental:</strong> Todo documento policial tiene un √∫nico punto de entrada ordinario: el <strong>Servicio Com√∫n General (SCG)</strong>.</p><p><strong>Circuito ordinario del atestado:</strong></p><ul><li><strong>Presentaci√≥n en el SCG:</strong> Preferentemente por v√≠a telem√°tica. El formato f√≠sico solo se utilizar√° cuando est√© expresamente autorizado. <strong>Horario:</strong> lunes a viernes laborables, de 08:30 a 15:00 horas.</li><li><strong>Registro oficial:</strong> El SCG registra el documento en el sistema de gesti√≥n procesal. Se garantiza la trazabilidad y la validez procesal del atestado.</li><li><strong>Reparto competencial:</strong> El SCG asigna el asunto a la secci√≥n judicial competente.</li><li><strong>Remisi√≥n al SCT correspondiente:</strong> En materia penal, el atestado se remite al Servicio Com√∫n de Tramitaci√≥n ‚Äì √Årea Penal, que asume la instrucci√≥n.</li></ul><p><strong>Importancia operativa:</strong> Un atestado mal dirigido no se corrige en destino: se devuelve al circuito inicial. Los errores en el punto de entrada generan retrasos que afectan a medidas cautelares, citaciones y se√±alamientos.</p>" },
        { "titulo": "5. Guardia (Urgencias)", "contenido": "<h4>3.2 Interacci√≥n con el Servicio de Guardia (GU)</h4><p>El Servicio de Guardia constituye una excepci√≥n al circuito ordinario y se activa exclusivamente para actuaciones urgentes e inaplazables.</p><p><strong>Documentaci√≥n que debe remitirse directamente a Guardia:</strong></p><ul><li>Atestados con persona detenida.</li><li>Atestados con investigado citado para comparecer ante el juez de guardia.</li><li>Solicitudes urgentes: Entradas y registros, Intervenciones telef√≥nicas, Medidas cautelares inmediatas.</li></ul><p><strong>Funcionamiento:</strong> El personal de guardia recepciona, registra y da curso inmediato a la actuaci√≥n. El juez de guardia adopta decisiones en tiempo real. Posteriormente, el procedimiento se integra en el circuito ordinario del SCT.</p>" },
        { "titulo": "6. Polic√≠a Judicial", "contenido": "<h3>4. Manual avanzado para agentes de Polic√≠a Judicial</h3><p>Dirigido a unidades de investigaci√≥n y polic√≠a judicial, este apartado detalla la estructura interna con la que se trabajar√° de forma continuada.</p><h4>4.1 Servicio Com√∫n de Tramitaci√≥n (SCT) ‚Äì √Årea Penal</h4><p>El SCT Penal gestiona los procedimientos penales desde el inicio hasta la firmeza de la resoluci√≥n.</p><p><strong>Estructura interna:</strong></p><ul><li><strong>Equipos de Instrucci√≥n:</strong> Investigaci√≥n penal. Diligencias, pruebas, medidas cautelares.</li><li><strong>Equipos de Enjuiciamiento:</strong> Apertura de juicio oral. Se√±alamientos y celebraci√≥n de vistas. Sentencias.</li><li><strong>Grupos de trabajo:</strong> Delitos graves y menos graves. Delitos leves (tramitaci√≥n y enjuiciamiento).</li></ul>" },
        { "titulo": "7. Unidades Espec.", "contenido": "<h4>4.2 Unidades especializadas (S4M)</h4><ul><li><strong>Violencia sobre la Mujer:</strong> Grupo de Instrucci√≥n n¬∫ 3. Competencias: Instrucci√≥n penal, Delitos leves asociados, √ìrdenes de protecci√≥n y medidas cautelares.</li><li><strong>Menores:</strong> Grupo espec√≠fico del Equipo de Enjuiciamiento. Competencia integral: Desde Fiscal√≠a de Menores hasta ejecuci√≥n de medidas.</li><li><strong>Familia, Infancia y Capacidad (√Årea Civil):</strong> Internamientos no voluntarios. Custodias y reg√≠menes de visitas. Medidas de protecci√≥n a personas vulnerables. Intervenci√≥n policial bajo mandato del LAJ.</li></ul>" },
        { "titulo": "8. Ejecuci√≥n (SCEJ)", "contenido": "<h4>4.3 Fase de ejecuci√≥n: Servicio Com√∫n de Ejecuci√≥n (SCEJ) ‚Äì √Årea Penal</h4><p>Una vez firme la sentencia, la competencia pasa al SCEJ.</p><p><strong>Actuaciones con impacto policial:</strong></p><ul><li>Mandamientos de prisi√≥n.</li><li>√ìrdenes de b√∫squeda, captura e ingreso.</li><li>Mandamientos de libertad.</li><li>Ejecuci√≥n de multas e indemnizaciones.</li><li>Embargos y averiguaciones patrimoniales.</li><li>Suspensi√≥n de penas y acumulaciones.</li></ul><h4>4.4 Gesti√≥n digital y comunicaciones</h4><p>La Oficina Judicial es √≠ntegramente digital. La calidad del expediente depende del primer env√≠o policial. <strong>Principios clave:</strong> Uso obligatorio de canales telem√°ticos. Datos completos, correctos y normalizados. Evitar duplicidades y anexos mal identificados.</p>" },
        { "titulo": "9. Mandos", "contenido": "<h3>5. Pautas para la escala t√©cnica y superior</h3><p>Este apartado se dirige a jefaturas y mandos, responsables de la coordinaci√≥n estrat√©gica.</p><h4>5.1 Estructura de mando de la Oficina Judicial</h4><ul><li><strong>Director/a del Servicio Com√∫n (LAJ):</strong> m√°xima autoridad funcional.</li><li><strong>Jefatura de √Årea (LAJ o GPA):</strong> coordinaci√≥n por materias.</li><li><strong>Jefatura de Equipo (GPA, TPA o AJ):</strong> gesti√≥n directa operativa.</li></ul><h4>5.2 Coordinaci√≥n institucional</h4><p><strong>√ìrganos relevantes:</strong> Comit√© de Direcci√≥n (√≥rgano estrat√©gico) y Comit√©s de Coordinaci√≥n (resoluci√≥n de problemas operativos). Canales formales para elevar incidencias estructurales o recurrentes.</p><h4>5.3 Gesti√≥n de incidencias comunes</h4><table class='doc-table'><tr><th>Incidencia</th><th>Procedimiento</th></tr><tr><td>Reparto incorrecto</td><td>Devoluci√≥n al equipo de inicio; correcci√≥n v√≠a SCG</td></tr><tr><td>Errores en datos</td><td>Correcci√≥n por la Jefatura de Equipo tramitador</td></tr><tr><td>Documento sin registro</td><td>Remisi√≥n inmediata al SCG</td></tr></table>" },
        { "titulo": "10. Protocolos", "contenido": "<h3>6. Instrucci√≥n interna de Jefatura ‚Äì Formato Circular</h3><p><strong>6.1 Naturaleza:</strong> Obligatorio y vinculante. <strong>6.2 Entrada en vigor:</strong> 31 de diciembre de 2025.</p><h4>7. Esquemas operativos de flujo</h4><ul><li><strong>Flujo general de atestado penal (no urgente):</strong> Actuaci√≥n policial ‚Üí Redacci√≥n ‚Üí Remisi√≥n telem√°tica ‚Üí Servicio Com√∫n General (SCG) ‚Üí Registro y reparto ‚Üí SCT (√Årea Penal) ‚Üí Instrucci√≥n.</li><li><strong>Flujo de actuaci√≥n urgente (Servicio de Guardia):</strong> Hecho urgente ‚Üí Atestado inmediato ‚Üí Remisi√≥n directa a Servicio de Guardia ‚Üí Registro en Guardia ‚Üí Resoluci√≥n judicial inmediata ‚Üí Integraci√≥n posterior en SCT.</li><li><strong>Flujo de ejecuci√≥n penal:</strong> Sentencia firme ‚Üí Servicio Com√∫n de Ejecuci√≥n (SCEJ) ‚Üí Mandamiento (prisi√≥n, libertad, embargo‚Ä¶) ‚Üí Requerimiento a Polic√≠a Local ‚Üí Ejecuci√≥n material.</li></ul><h4>8. Adaptaci√≥n por materias espec√≠ficas</h4><ul><li><strong>Tr√°fico:</strong> Atestados delitos seguridad vial ‚Üí SCG ‚Üí SCT Penal. Juicios r√°pidos ‚Üí Guardia.</li><li><strong>Violencia de G√©nero:</strong> Atestados urgentes ‚Üí Servicio de Guardia. Grupo de Instrucci√≥n n¬∫ 3 VSM.</li><li><strong>Menores:</strong> Atestados ‚Üí SCG ‚Üí SCT (Grupo de Menores).</li><li><strong>Contencioso:</strong> Denuncias administrativas judicializadas ‚Üí SCG.</li></ul><h3>9. Versi√≥n de bolsillo para patrulla</h3><p>¬øTengo un atestado? No urgente ‚Üí SCG. Detenido / urgente ‚Üí Guardia. ¬øEs ejecuci√≥n de sentencia? Siempre SCEJ. Nunca enviar directamente a un juzgado.</p><h3>10. Versi√≥n estrat√©gica para mandos</h3><p>Canal √∫nico ordinario: SCG. Guardia solo para urgencias reales. SCT = fase declarativa. SCEJ = ejecuci√≥n. Incidencias estructurales ‚Üí Comit√© de Direcci√≥n.</p><p><strong>Cierre:</strong> La correcta aplicaci√≥n de esta instrucci√≥n es responsabilidad de toda la cadena de mando. Su incumplimiento podr√° generar responsabilidades disciplinarias por disfunci√≥n operativa o perjuicio procesal.</p>" }
    ],
    // 100 TARJETAS REALES
    flashcards: [
        {f:"¬øFecha entrada vigor?", b:"31 de diciembre de 2025"}, {f:"¬øLey reguladora?", b:"Ley Org√°nica 1/2025"},
        {f:"¬ø√ìrgano que sustituye juzgados?", b:"Tribunal de Instancia (TI)"}, {f:"¬øPunto √∫nico entrada ordinaria?", b:"Servicio Com√∫n General (SCG)"},
        {f:"¬øHorario SCG?", b:"Lunes a Viernes 08:30 a 15:00"}, {f:"¬øD√≥nde entregar detenidos?", b:"Servicio de Guardia"},
        {f:"¬øQui√©n tramita la instrucci√≥n?", b:"SCT (Servicio Com√∫n Tramitaci√≥n)"}, {f:"¬øQui√©n ejecuta sentencias?", b:"SCEJ (Servicio Com√∫n Ejecuci√≥n)"},
        {f:"¬øM√°xima autoridad funcional?", b:"Director del Servicio (LAJ)"}, {f:"¬øQui√©n resuelve errores de datos?", b:"Jefatura de Equipo tramitador"},
        {f:"¬øDocumento sin registrar?", b:"Remitir al SCG inmediatamente"}, {f:"¬øUnidad Violencia Mujer?", b:"Grupo de Instrucci√≥n n¬∫ 3"},
        {f:"¬øD√≥nde est√° la Secci√≥n Menores?", b:"SCT - Equipo de Enjuiciamiento"}, {f:"¬øInternamientos no voluntarios?", b:"SCT Civil (Familia)"},
        {f:"¬øQui√©n tramita busca y captura?", b:"SCEJ (Ejecuci√≥n)"}, {f:"¬øAveriguaci√≥n patrimonial?", b:"SCEJ"},
        {f:"¬ø√ìrgano estrat√©gico OJ?", b:"Comit√© de Direcci√≥n"}, {f:"¬øPlataforma comunicaciones?", b:"LexNet"},
        {f:"¬øSistema gesti√≥n interna?", b:"Atenea"}, {f:"¬øEnv√≠o preferente?", b:"Telem√°tico"},
        {f:"¬øDelitos Leves?", b:"Grupos de Trabajo (SCT)"}, {f:"¬øCoordinador de √Årea?", b:"Jefatura de √Årea (LAJ/GPA)"},
        {f:"¬øFunciones SCG?", b:"Registro, Reparto, Actos Comunicaci√≥n, Archivo"}, {f:"¬øNotificaciones en calle?", b:"SCG - Equipo Actos Comunicaci√≥n"},
        {f:"¬øDep√≥sito de Efectos?", b:"SCG - Equipo 2"}, {f:"¬øApud-Acta?", b:"SCG - Equipo 1"},
        {f:"¬øSignificado SCT?", b:"Servicio Com√∫n de Tramitaci√≥n"}, {f:"¬øSCT Audiencia Provincial?", b:"Independiente del TI"},
        {f:"¬øSignificado SCEJ?", b:"Servicio Com√∫n de Ejecuci√≥n"}, {f:"¬øSubastas judiciales?", b:"SCEJ"},
        {f:"¬øCuenta Consignaciones?", b:"SCEJ"}, {f:"¬øSignificado OJM?", b:"Oficinas Justicia en el Municipio"},
        {f:"¬øSustituto Juzgado Paz?", b:"OJM"}, {f:"¬øPublicidad protocolo?", b:"Punto Acceso General (PAGAJ)"},
        {f:"¬øResponsable Protecci√≥n Datos?", b:"Director del Servicio Com√∫n"}, {f:"¬øNormativa Datos?", b:"LOPJ, RGPD, LO 3/2018"},
        {f:"¬øCar√°cter protocolo?", b:"Normativo, flexible, din√°mico"}, {f:"¬øVideoconferencias?", b:"Sistema EVID"},
        {f:"¬øControl cuentas?", b:"Trimestral"}, {f:"¬øSustituciones SCT?", b:"Propone Jefatura de √Årea"},
        {f:"¬øAtenci√≥n p√∫blico?", b:"09:00 a 14:00"}, {f:"¬øComunicaci√≥n entrada vigor?", b:"Sala Gobierno TSJ, Fiscal√≠a, Gerencia"},
        {f:"¬øNivel 4 organizaci√≥n?", b:"Unidades Funcionales"}, {f:"¬øNivel 1 organizaci√≥n?", b:"Equipos"},
        {f:"¬øQui√©n firma protocolo?", b:"Secretario Coordinador y Secretario Gobierno"}, {f:"¬øUbicaci√≥n funcionarios?", b:"Por equipos de trabajo"},
        {f:"¬øArchivo Judicial Gesti√≥n?", b:"SCG - Equipo 2"}, {f:"¬øRegistro electr√≥nico?", b:"SIR"},
        {f:"¬øObjetivo OJM?", b:"Acercar justicia sin sede TI"}, {f:"¬øDirecci√≥n t√©cnico-procesal?", b:"Letrado Admon. Justicia (LAJ)"},
        {f:"¬øQu√© es UPAD?", b:"Unidad Procesal Apoyo Directo"}, {f:"¬øQu√© es SCP?", b:"Servicio Com√∫n Procesal"},
        {f:"¬øPlazo detenci√≥n?", b:"72 horas m√°ximo"}, {f:"¬øPlazo Habeas Corpus?", b:"Resoluci√≥n en 24h"},
        {f:"¬øCausas aforados?", b:"TSJ o Supremo"}, {f:"¬øQu√© es PNJ?", b:"Punto Neutro Judicial"},
        {f:"¬øLevantamiento cad√°ver?", b:"Juez Guardia + Forense"}, {f:"¬øNotificaci√≥n a Polic√≠a?", b:"Unidad de Enlace/Gesti√≥n"},
        {f:"¬øQu√© es un exhorto?", b:"Comunicaci√≥n entre √≥rganos judiciales"}, {f:"¬øQu√© es un mandamiento?", b:"Orden a funcionario/polic√≠a"},
        {f:"¬øQu√© es providencia?", b:"Resoluci√≥n de tr√°mite (Juez)"}, {f:"¬øDiligencia ordenaci√≥n?", b:"Impulso procesal (LAJ)"},
        {f:"¬øQu√© es Decreto?", b:"Resoluci√≥n finalizadora (LAJ)"}, {f:"¬øRecurso a Providencia?", b:"Reforma"},
        {f:"¬øTasaci√≥n costas?", b:"LAJ"}, {f:"¬øTurno de oficio?", b:"Justicia Gratuita"},
        {f:"¬øCustodia expedientes vivos?", b:"SCT / SCEJ"}, {f:"¬øCustodia archivo?", b:"SCG"},
        {f:"¬øQu√© es SIRAJ?", b:"Sistema Registros Administrativos"}, {f:"¬øRegistro Penados?", b:"Sentencias firmes"},
        {f:"¬øOrden alejamiento?", b:"Auto (Juez)"}, {f:"¬øJuicio in voce?", b:"Sentencia oral en el acto"},
        {f:"¬øPlazo apelaci√≥n?", b:"10 d√≠as"}, {f:"¬øConformidad?", b:"Reconoce hechos, reduce pena"},
        {f:"¬øAsiste levantamiento si no va Juez?", b:"LAJ (delegado) + Forense"}, {f:"¬øQu√© es reparto?", b:"Distribuci√≥n asuntos (SCG)"},
        {f:"¬øPieza separada?", b:"Expediente paralelo"}, {f:"¬øSecreto sumario?", b:"Restricci√≥n partes (no Fiscal)"},
        {f:"¬øPide prisi√≥n provisional?", b:"Fiscal o Acusaci√≥n"}, {f:"¬øM√°ximo prisi√≥n prov.?", b:"2 a√±os (delitos graves)"},
        {f:"¬øFianza pudendo?", b:"Libertad provisional"}, {f:"¬øResponsabilidad civil?", b:"Indemnizaci√≥n econ√≥mica"},
        {f:"¬øEjecuta trabajos beneficio?", b:"Inst. Penitenciarias / SCEJ"}, {f:"¬øExpurgo?", b:"Destrucci√≥n expedientes"},
        {f:"¬øLanzamiento?", b:"Desahucio forzoso"}, {f:"¬øAcompa√±a Comisi√≥n Judicial?", b:"Polic√≠a (Auxilio)"},
        {f:"¬øAveriguaci√≥n patrimonial?", b:"B√∫squeda bienes (PNJ)"}, {f:"¬øRequisitoria?", b:"Busca y captura"},
        {f:"¬øRebeld√≠a procesal?", b:"Ausencia injustificada"}, {f:"¬øPrescribe delito leve?", b:"1 a√±o"},
        {f:"¬øPrescribe delito grave?", b:"20 a√±os (>15 pena)"}, {f:"¬øHabeas corpus ante qui√©n?", b:"Juez Instrucci√≥n lugar"},
        {f:"¬øAbogado en Habeas Corpus?", b:"No es obligatorio"}, {f:"¬øLECrim?", b:"Ley Enjuiciamiento Criminal"},
        {f:"¬øLOPJ?", b:"Ley Org√°nica Poder Judicial"}, {f:"¬øEVID?", b:"Grabaci√≥n Vistas"},
        {f:"¬øFirma digital?", b:"Autenticaci√≥n"}, {f:"¬øNombra peritos?", b:"√ìrgano judicial"},
        {f:"¬øUSB en juzgado?", b:"Prohibido (Seguridad)"}
    ],
    // 70 PREGUNTAS TEST REALES
    test: [
        {p:"¬øPuerta √∫nica entrada ordinaria?", r:["Decanato","SCG","SCT"], c:1},
        {p:"¬øHorario presentaci√≥n SCG?", r:["09-14h","08:30-15:00","24h"], c:1},
        {p:"¬øAtestado con DETENIDO?", r:["SCG","Servicio Guardia","SCT"], c:1},
        {p:"¬øQui√©n gestiona la instrucci√≥n?", r:["SCT Penal","SCEJ","SCG"], c:0},
        {p:"¬øQui√©n ejecuta una sentencia firme?", r:["SCT","SCEJ","Guardia"], c:1},
        {p:"¬øM√°xima autoridad funcional servicio?", r:["Decano","Director (LAJ)","Gestor"], c:1},
        {p:"¬øUnidad Violencia G√©nero?", r:["Grupo Instr. 3","Menores","SCG"], c:0},
        {p:"¬øError en DNI atestado?", r:["Devolver Comisar√≠a","Jefe Equipo Tramitador","Decano"], c:1},
        {p:"¬øDocumento sin registrar?", r:["Archivar","Devolver a SCG","Procesar"], c:1},
        {p:"¬øNotificaciones en calle?", r:["Polic√≠a","SCG (Actos Com.)","SCT"], c:1},
        {p:"¬øD√≥nde se tramitan delitos leves?", r:["SCT (Grupos Trabajo)","SCEJ","Juzgado Paz"], c:0},
        {p:"¬øQui√©n gestiona embargos?", r:["SCT","SCEJ","SCG"], c:1},
        {p:"¬ø√ìrgano estrat√©gico?", r:["Comit√© Direcci√≥n","Junta Personal","Sindicatos"], c:0},
        {p:"¬øLey reguladora NOJ?", r:["LO 1/2025","LECrim","Civil"], c:0},
        {p:"¬øSolicitud E/R Urgente?", r:["SCG","Guardia","SCT"], c:1},
        {p:"¬øDep√≥sito Efectos?", r:["SCG","SCT","Cient√≠fica"], c:0},
        {p:"¬øSustituye Juzgados Paz?", r:["OJM","Ayuntamientos","Registro"], c:0},
        {p:"¬øEntrada en vigor?", r:["31/12/2025","01/01/2026","Inmediata"], c:0},
        {p:"¬øTI sustituye a...?", r:["Audiencia","Juzgados Unipersonales","Supremo"], c:1},
        {p:"¬øSistema gesti√≥n procesal?", r:["Atenea","LexNet","Siraj"], c:0},
        {p:"¬øQui√©n hace el reparto?", r:["Decano","SCG","SCT"], c:1},
        {p:"¬øDivorcio contencioso?", r:["SCT Civil","SCEJ","SCG"], c:0},
        {p:"¬øCoordinador de Equipo?", r:["Jefe √Årea","Jefe Equipo","Direcci√≥n"], c:1},
        {p:"¬øSecci√≥n Menores?", r:["SCT Enjuiciamiento","Civil","SCEJ"], c:0},
        {p:"¬øFirma mandamiento prisi√≥n?", r:["Juez","LAJ","Gestor"], c:0},
        {p:"¬øPAGAJ?", r:["Punto Acceso General","Sindicato","Juzgado"], c:0},
        {p:"¬øGuardia 24h?", r:["S√≠","No","Solo fines semana"], c:0},
        {p:"¬øAtestado directo a SCT?", r:["Devolver a SCG","Tramitar","Perder"], c:0},
        {p:"¬øEjecuci√≥n multas?", r:["SCEJ","SCT","Hacienda"], c:0},
        {p:"¬øFase declarativa?", r:["Instrucci√≥n/Juicio","Ejecuci√≥n","Recurso"], c:0},
        {p:"¬øDirecci√≥n personal diaria?", r:["Jefe Equipo","Juez","Fiscal"], c:0},
        {p:"¬øAntecedentes penales?", r:["Gerencia/SCG","Comisar√≠a","Ayto"], c:0},
        {p:"¬øExpurgo?", r:["Junta/SCG","Limpieza","Polic√≠a"], c:0},
        {p:"¬øPresidente TI?", r:["S√≠","No","A veces"], c:0},
        {p:"¬øCaja Dep√≥sitos?", r:["SCEJ","Banco","SCG"], c:0},
        {p:"¬øLanzamientos?", r:["SCG (Actos Com.)","SCT","SCEJ"], c:0},
        {p:"¬øVideoconferencias?", r:["SCG/SCT","Polic√≠a","Prisi√≥n"], c:0},
        {p:"¬øMedios telem√°ticos?", r:["Obligatorio","Opcional","Solo graves"], c:0},
        {p:"¬øTrabajos beneficio?", r:["SCEJ","SCT","Polic√≠a"], c:0},
        {p:"¬øObjetivo NOJ?", r:["Agilidad","Ahorro","Personal"], c:0},
        {p:"¬øPrincipio actuaci√≥n SCP?", r:["Independencia","Jerarqu√≠a","Autonom√≠a"], c:1},
        {p:"¬øDirecci√≥n t√©cnico-procesal?", r:["Decano","LAJ Director","Fiscal"], c:1},
        {p:"¬øCertificaci√≥n archivo?", r:["SCG","SCT","Decanato"], c:0},
        {p:"¬øSoporte varios √≥rganos?", r:["UPAD","SCP","Juzgados"], c:1},
        {p:"¬øAutoriza E/R Instrucci√≥n?", r:["LAJ","Juez","Comisario"], c:1},
        {p:"¬øPiezas t√≥xicas?", r:["Despacho Juez","Protocolo destrucci√≥n","Devolver"], c:1},
        {p:"¬øLanzamientos SCEJ?", r:["No","S√≠","Solo Juez"], c:1},
        {p:"¬øEscritos tr√°mite?", r:["Juez","SCG","Comisar√≠a"], c:1},
        {p:"¬øEmbargo cuentas?", r:["PNJ","Google","Agencia"], c:0},
        {p:"¬øJefe Auxilio Judicial?", r:["Gestor","LAJ Director","Polic√≠a"], c:1},
        {p:"¬øSalas Vistas?", r:["SCT/SCG","Limpieza","Abogados"], c:0},
        {p:"¬øNotifica sentencia?", r:["Juez","SCG","Abogado"], c:1},
        {p:"¬øPlazo detenci√≥n?", r:["72h","24h","48h"], c:0},
        {p:"¬øCitaci√≥n polic√≠a juicio?", r:["Tel√©fono","Conducto/Gesti√≥n","Correo"], c:1},
        {p:"¬øAtt. Ciudadano?", r:["Externo","Unidad OJ","ONG"], c:1},
        {p:"¬øSecreto sumario?", r:["LAJ","Juez","Polic√≠a"], c:1},
        {p:"¬øTasaci√≥n costas?", r:["Colegio","LAJ","Juez"], c:1},
        {p:"¬øInicio Habeas Corpus?", r:["Querella","Solicitud","Atestado"], c:1},
        {p:"¬øUbicaci√≥n SCG?", r:["Comisar√≠a","Sede Juzgados","Ayto"], c:1},
        {p:"¬øTurno oficio?", r:["Colegio","Decano","SCG"], c:0},
        {p:"¬øRecurso Diligencia?", r:["Reposici√≥n","Amparo","Nada"], c:0},
        {p:"¬øAcceso Atenea Polic√≠a?", r:["S√≠ total","Pasarelas","Cualquiera"], c:1},
        {p:"¬øPreside Junta Jueces?", r:["Decano","Audiencia","LAJ"], c:0},
        {p:"¬øForense Guardia?", r:["Urgencias","Detenidos/Levantamientos","Sustituto"], c:1},
        {p:"¬øAgosto h√°bil?", r:["Nunca","Causas urgentes","Ma√±anas"], c:1},
        {p:"¬øJurisdicci√≥n Voluntaria?", r:["SCT Civil","SCEJ","Registro"], c:0},
        {p:"¬øFe p√∫blica?", r:["Juez","LAJ","Polic√≠a"], c:1},
        {p:"¬øExhorto?", r:["Multa","Auxilio Judicial","Sentencia"], c:1},
        {p:"¬øEjecuta desahucio?", r:["Comisi√≥n Judicial","Propietario","Ayto"], c:0},
        {p:"¬øDecomiso l√≠cito?", r:["Polic√≠a","Realizaci√≥n/Destrucci√≥n","Basura"], c:1}
    ]
};

const App = {
    data: DB, 
    user: null,
    // RESETEA AL CARGAR PARA LIMPIAR DATOS VIEJOS
    dbUsers: 'noj_users_final_v100', dbLogs: 'noj_logs_final_v100', dbSec: 'noj_sec_final_v100',

    init: async () => {
        document.addEventListener('keyup', (e) => {
            if(e.key === 'Enter' && !document.getElementById('login-screen').classList.contains('hidden')) App.login();
        });

        // USUARIOS POR DEFECTO CON JERARQU√çA
        if(!localStorage.getItem(App.dbUsers)) {
            const defs = [
                { u:'master', p:'master', r:'master', boss:'', change:true },
                { u:'admin', p:'admin', r:'admin', boss:'', change:true },
                { u:'jefatura', p:'jefatura', r:'jef', boss:'', change:true },
                { u:'mandodc', p:'1234', r:'mdc', boss:'', change:true },
                { u:'mandodt', p:'1234', r:'mdt', boss:'', change:true },
                { u:'mandout', p:'1234', r:'mut', boss:'', change:true },
                { u:'agentedc', p:'1234', r:'adc', boss:'mandodc', change:true }
            ];
            localStorage.setItem(App.dbUsers, JSON.stringify(defs));
            App.logSec('SYSTEM', 'Inicializaci√≥n');
        }

        // BARAJAR Y SELECCIONAR ALEATORIAMENTE CADA VEZ
        if(App.data.flashcards) {
            App.sessionCards = App.shuffle([...App.data.flashcards]).slice(0, 30);
        }
        if(App.data.test) {
            App.sessionTest = App.shuffle([...App.data.test]).slice(0, 20);
        }

        App.renderTemario();
        App.renderBiblio(); 
        App.renderMedia(); 
        App.renderFC(); 
        App.renderTest();
        
        if(document.getElementById('main-audio')) {
             document.getElementById('main-audio').src = App.data.audio_url;
        }
    },

    shuffle: (a) => { for(let i=a.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; },

    logSec: (act, det) => {
        const l = JSON.parse(localStorage.getItem(App.dbSec)||'[]');
        l.unshift({d: new Date().toLocaleString(), u: App.user?App.user.u:'GUEST', a:act, t:det});
        if(l.length>100) l.pop();
        localStorage.setItem(App.dbSec, JSON.stringify(l));
    },

    login: () => {
        const u = document.getElementById('user').value.trim();
        const p = document.getElementById('pass').value.trim();
        const users = JSON.parse(localStorage.getItem(App.dbUsers));
        const found = users.find(x => x.u === u && x.p === p);

        if(found) {
            App.user = found;
            if(found.change) {
                document.getElementById('login-screen').style.display='none';
                document.getElementById('password-screen').classList.remove('hidden');
                return;
            }
            App.enterApp();
        } else {
            document.getElementById('msg').innerText = "Credenciales incorrectas";
            App.logSec('LOGIN_FAIL', u);
        }
    },

    changePassword: () => {
        const p1 = document.getElementById('new-pass-1').value;
        const p2 = document.getElementById('new-pass-2').value;
        if(p1.length<4 || p1!==p2) return document.getElementById('pass-msg').innerText = "Error contrase√±a";
        const users = JSON.parse(localStorage.getItem(App.dbUsers));
        const idx = users.findIndex(x => x.u === App.user.u);
        users[idx].p = p1; users[idx].change = false;
        localStorage.setItem(App.dbUsers, JSON.stringify(users));
        App.user.p = p1;
        App.logSec('PASS_CHANGE', App.user.u);
        document.getElementById('password-screen').classList.add('hidden');
        App.enterApp();
    },

    enterApp: () => {
        document.getElementById('login-screen').style.display='none';
        document.getElementById('main-app').style.display='flex';
        document.getElementById('display-user').innerText = App.user.u.toUpperCase();
        App.logSec('LOGIN_OK', App.user.u);

        const rolesGestion = ['admin','master','jef','mdc','mdt','mut'];
        if(rolesGestion.includes(App.user.r)) {
            document.getElementById('menu-admin').classList.remove('hidden');
            App.renderAdmin();
        }
    },
    logout: () => location.reload(),

    renderTemario: () => {
        const t = document.getElementById('doc-tabs'), c = document.getElementById('doc-content');
        t.innerHTML=''; c.innerHTML='';
        App.data.secciones_temario.forEach((s,i) => {
            t.innerHTML += `<button class="doc-tab ${i===0?'active':''}" onclick="App.tab(${i})">${s.titulo}</button>`;
            c.innerHTML += `<div id="p${i}" class="doc-page ${i===0?'active':''}">${s.contenido}</div>`;
        });
    },
    tab: (i) => {
        document.querySelectorAll('.doc-tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.doc-page').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.doc-tab')[i].classList.add('active');
        document.getElementById('p'+i).classList.add('active');
    },

    renderBiblio: () => { 
        document.getElementById('file-tree').innerHTML = ''; 
        App.data.bibliografia.forEach(c => { 
            let l = c.archivos.map(f => `<li style="margin-bottom:5px;"><a href="${f.nombre}" target="_blank" style="text-decoration:none; color:#0a2e5c; font-weight:500;">üìÑ ${f.desc}</a></li>`).join(''); 
            document.getElementById('file-tree').innerHTML += `<li style="margin-bottom:15px;"><strong style="font-size:1.1rem; color:#333;">${c.nivel}</strong><ul style="list-style:none; padding-left:10px; margin-top:5px;">${l}</ul></li>`; 
        }); 
    },

    renderMedia: () => {
        const c = document.getElementById('media-container'); c.innerHTML='';
        App.data.imagenes.forEach(i => c.innerHTML += `<div class="media-card" onclick="window.open('${i.url}','_blank')"><img src="${i.url}" onerror="this.src='https://via.placeholder.com/300?text=Error+Imagen'"><p>${i.nombre}</p></div>`);
    },

    renderFC: () => { App.fcI=0; App.drawFC(); },
    drawFC: () => {
        if(!App.sessionCards) return;
        const c = App.sessionCards[App.fcI];
        document.getElementById('fc-canvas').innerHTML = `<div class="fc-inner"><div class="fc-face fc-front"><div><i class="fas fa-question-circle fa-2x"></i><br><br>${c.f}</div></div><div class="fc-face fc-back"><div>${c.b}</div></div></div>`;
        document.getElementById('fc-canvas').onclick = function() { this.classList.toggle('fc-flipped'); };
        document.getElementById('fc-count').innerText = `${App.fcI+1} / ${App.sessionCards.length}`;
    },
    moveFC: (d) => {
        App.fcI += d; 
        if(App.fcI < 0) App.fcI = App.sessionCards.length - 1;
        if(App.fcI >= App.sessionCards.length) App.fcI = 0;
        document.getElementById('fc-canvas').classList.remove('fc-flipped'); 
        setTimeout(() => App.drawFC(), 200); 
    },

    renderTest: () => {
        const div = document.getElementById('test-container');
        div.innerHTML = App.sessionTest.map((q,i) => `<div class="q-block" data-correct="${q.c}"><p><b>${i+1}. ${q.p}</b></p>${q.r.map(r => `<div class="quiz-option" onclick="App.selOpt(this)">${r}</div>`).join('')}</div>`).join('');
    },
    selOpt: (el) => {
        el.parentElement.querySelectorAll('.quiz-option').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
    },
    submitTest: () => {
        let s = 0; const blocks = document.querySelectorAll('.q-block');
        blocks.forEach(b => {
            const sel = b.querySelector('.selected'); const corr = parseInt(b.dataset.correct); const opts = b.querySelectorAll('.quiz-option');
            opts.forEach(o => o.classList.remove('correct','wrong'));
            if(sel) { if(Array.from(opts).indexOf(sel) === corr) { sel.classList.add('correct'); s++; } else { sel.classList.add('wrong'); opts[corr].classList.add('correct'); } }
        });
        document.getElementById('test-result').innerText = `Resultado: ${s} / 20 Aciertos`;
        const logs = JSON.parse(localStorage.getItem(App.dbLogs)||'[]');
        logs.push({u:App.user.u, d:new Date().toLocaleDateString(), s:s, f:blocks.length-s});
        localStorage.setItem(App.dbLogs, JSON.stringify(logs));
        if(['admin','master'].includes(App.user.r)) App.renderAdmin();
    },

    renderAdmin: () => {
        const global = ['admin','master'].includes(App.user.r); const jefatura = App.user.r === 'jef'; const readonly = !global;
        const logs = JSON.parse(localStorage.getItem(App.dbLogs)||'[]'); const users = JSON.parse(localStorage.getItem(App.dbUsers));
        const t = document.getElementById('admin-logs'); t.innerHTML='';
        
        if(readonly) document.getElementById('admin-tools').style.display='none';
        else {
            const bs = document.getElementById('new-b'); bs.innerHTML = '<option value="">-- Asignar Mando --</option>';
            users.filter(u => ['mdc','mdt','mut','jef','admin','master'].includes(u.r)).forEach(b => { bs.innerHTML += `<option value="${b.u}">${b.u} (${b.r})</option>`; });
        }

        if(global) {
            document.getElementById('security-box').style.display='block';
            const sl = JSON.parse(localStorage.getItem(App.dbSec)||'[]'); const st = document.getElementById('sec-logs'); st.innerHTML='';
            sl.forEach(s => st.innerHTML += `<tr><td>${s.d}</td><td>${s.u}</td><td>${s.a}</td><td>${s.t}</td></tr>`);
        } else { document.getElementById('security-box').style.display='none'; }

        logs.forEach(l => {
            let show = false; const uData = users.find(x => x.u === l.u); const boss = uData ? uData.boss : '';
            if(global || jefatura) show = true; else if(boss === App.user.u) show = true;
            if(show) t.innerHTML += `<tr><td>${l.u}</td><td>${uData?uData.r.toUpperCase():'?'}</td><td>${l.d}</td><td style="color:${l.s>10?'green':'red'}">${l.s}</td><td>${l.f}</td><td>${boss}</td></tr>`;
        });
    },

    addUser: () => {
        const u = document.getElementById('new-u').value; const p = document.getElementById('new-p').value; const r = document.getElementById('new-r').value; const b = document.getElementById('new-b').value;
        const users = JSON.parse(localStorage.getItem(App.dbUsers));
        if(users.find(x=>x.u===u)) return alert("Existe");
        users.push({u,p,r,boss:b, change:true}); localStorage.setItem(App.dbUsers, JSON.stringify(users));
        App.logSec('CREATE_USER', u); App.renderAdmin(); alert("Creado");
    },

    importUsers: () => {
        const raw = document.getElementById('import-data').value; const users = JSON.parse(localStorage.getItem(App.dbUsers));
        const map = {'AGENTE (DC)':'adc','AGENTE (DT)':'adt','AGENTE (UT)':'aut','MANDO (DC)':'mdc','MANDO (DT)':'mdt','MANDO (UT)':'mut','JEFATURA':'jef','ADMIN':'admin','MASTER':'master'};
        let c=0;
        raw.split('\n').forEach(l => {
            let p = l.split(/\t+/); if(p.length<2) p=l.split(/\s+/);
            if(p.length>=2) {
                let r = map[p[2]] || 'adc';
                if(!users.find(x=>x.u===p[0])) { users.push({u:p[0], p:p[1], r:r, boss:p[3]||'', change:true}); c++; }
            }
        });
        localStorage.setItem(App.dbUsers, JSON.stringify(users)); document.getElementById('import-msg').innerText = `+${c}`; App.logSec('IMPORT', c); App.renderAdmin();
    },

    clearLogs: () => { if(confirm("¬øBorrar?")) { localStorage.removeItem(App.dbLogs); App.renderAdmin(); }},
    nav: (id) => { document.querySelectorAll('.view-section').forEach(x=>x.classList.remove('active')); document.getElementById('view-'+id).classList.add('active'); }
};
window.onload = App.init;
</script>
</body>
</html>
