<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma Formaci√≥n Policial - NOJ Salamanca</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #0a2e5c; --accent: #d4af37; --bg: #f4f7f9; --text: #333; --danger: #c0392b; --success: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; background: linear-gradient(rgba(10,46,92,0.9), rgba(10,46,92,0.9)), url('jefatura.jpg') center/cover; display: flex; justify-content: center; align-items: center; }
        .login-card { background: white; padding: 40px; border-radius: 12px; width: 320px; text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.5); }
        .login-card img { width: 100px; margin-bottom: 20px; }
        .login-card input { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        .btn-enter { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 15px; }

        /* APP */
        #main-app { display: none; height: 100%; flex-direction: column; }
        .app-header { background: white; padding: 10px; text-align: center; border-bottom: 4px solid var(--accent); flex-shrink: 0; }
        .app-header img { height: 80px; }
        .top-bar { background: var(--primary); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .btn-logout { background: #c0392b; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .content-area { flex: 1; display: flex; overflow: hidden; }
        .sidebar { width: 260px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; }
        .sidebar-logo { text-align: center; padding: 20px; border-bottom: 1px solid #eee; }
        .sidebar-logo img { width: 100px; }
        .menu-item { padding: 15px; cursor: pointer; border-bottom: 1px solid #eee; color: #555; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background: #f0f4f8; color: var(--primary); border-left: 4px solid var(--primary); }
        .menu-item i { width: 25px; margin-right: 10px; }
        .viewport { flex: 1; padding: 30px; overflow-y: auto; background: #f4f7f9; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        
        /* TEMARIO */
        .doc-nav { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 20px; }
        .doc-tab { padding: 10px; background: #e0e0e0; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .doc-tab.active { background: var(--primary); color: white; }
        .doc-page { display: none; background: white; padding: 40px; border-radius: 8px; line-height: 1.6; text-align: justify; }
        .doc-page.active { display: block; }
        .doc-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .doc-table th, .doc-table td { border: 1px solid #ddd; padding: 10px; }

        /* TARJETAS (CORREGIDO GIRO Y VISIBILIDAD) */
        .fc-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .fc-container { perspective: 1000px; height: 350px; width: 100%; max-width: 600px; cursor: pointer; position: relative; }
        .fc-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .fc-flipped .fc-inner { transform: rotateY(180deg); }
        .fc-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; border-radius: 15px; font-size: 1.4rem; background: white; border: 3px solid var(--primary); box-sizing: border-box; }
        .fc-front { background: var(--primary); color: white; z-index: 2; transform: rotateY(0deg); }
        .fc-back { transform: rotateY(180deg); color: #333; background: #fff; }
        .fc-controls { display: flex; gap: 20px; margin-bottom: 30px; z-index: 10; }
        .btn-fc { padding: 12px 30px; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; width: 140px; }
        
        /* MEDIA */
        .media-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .media-card { background: white; padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .media-card:hover { transform: translateY(-5px); }
        .media-card img { max-width: 100%; height: 180px; object-fit: cover; }

        /* TEST */
        .q-block { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .quiz-option { padding: 15px; margin: 10px 0; background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; transition: background 0.2s; }
        .quiz-option:hover { background: #e9ecef; }
        .quiz-option.selected { background: #e3f2fd; border-color: var(--primary); }
        .quiz-option.correct { background: #d4edda; border-color: green; }
        .quiz-option.wrong { background: #f8d7da; border-color: red; }

        /* ADMIN */
        .admin-table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; font-size: 0.9rem; }
        .admin-table th, .admin-table td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        .import-area { width: 100%; height: 100px; padding: 10px; margin-top: 10px; font-family: monospace; font-size: 11px; }
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <img src="poli (2).png" alt="Logo">
        <h2>Acceso Restringido</h2>
        <p>NOJ Salamanca</p>
        <input type="text" id="user" placeholder="Usuario">
        <input type="password" id="pass" placeholder="Contrase√±a">
        <button class="btn-enter" onclick="App.login()">Entrar</button>
        <p id="msg" style="color:red; margin-top:10px;"></p>
    </div>
</div>

<div id="password-screen" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--primary); z-index:6000; display:flex; justify-content:center; align-items:center;">
    <div class="login-card">
        <h2 style="color:#c0392b">Seguridad</h2>
        <p>Cambie su contrase√±a inicial.</p>
        <input type="password" id="new-p1" placeholder="Nueva Contrase√±a">
        <input type="password" id="new-p2" placeholder="Repita Contrase√±a">
        <button class="btn-enter" onclick="App.changePass()">Guardar</button>
    </div>
</div>

<div id="main-app">
    <div class="app-header"><img src="pie175PLSA.jpg" alt="Cabecera"></div>
    <div class="top-bar">
        <span id="display-user"></span>
        <button class="btn-logout" onclick="location.reload()">Salir</button>
    </div>
    
    <div class="content-area">
        <div class="sidebar">
            <div class="sidebar-logo"><img src="escudoPLSA.jpg"></div>
            <div class="menu-item active" onclick="App.nav('temario')"><i class="fas fa-book"></i> Temario</div>
            <div class="menu-item" onclick="App.nav('biblio')"><i class="fas fa-folder"></i> Documentaci√≥n</div>
            <div class="menu-item" onclick="App.nav('media')"><i class="fas fa-image"></i> Multimedia</div>
            <div class="menu-item" onclick="App.nav('flashcards')"><i class="fas fa-brain"></i> Tarjetas</div>
            <div class="menu-item" onclick="App.nav('test')"><i class="fas fa-check-circle"></i> Test</div>
            <div class="menu-item hidden" id="menu-admin" onclick="App.nav('admin')"><i class="fas fa-users-cog"></i> Gesti√≥n</div>
        </div>

        <div class="viewport">
            <div id="view-temario" class="view-section active">
                <h2>Gu√≠a Operativa Detallada</h2>
                <div id="doc-tabs" class="doc-nav"></div>
                <div id="doc-content"></div>
            </div>

            <div id="view-biblio" class="view-section">
                <h2>Biblioteca Digital</h2>
                <ul id="file-tree" style="list-style:none; padding:0;"></ul>
            </div>

            <div id="view-media" class="view-section">
                <h2>Recursos Multimedia</h2>
                <div class="media-grid" id="media-container"></div>
                <div style="margin-top:20px; background:white; padding:20px; border-radius:8px;">
                    <h3>Audio Resumen Ejecutivo</h3>
                    <audio id="main-audio" controls style="width:100%"></audio>
                </div>
            </div>

            <div id="view-flashcards" class="view-section">
                <h2 style="text-align:center">Entrenamiento (30 Aleatorias)</h2>
                <div class="fc-wrapper">
                    <div id="fc-canvas" class="fc-container"></div>
                    <div class="fc-controls">
                        <button class="btn-fc" style="background:#c0392b" onclick="App.moveFC(-1)">Anterior</button>
                        <span id="fc-count" style="align-self:center; font-weight:bold;"></span>
                        <button class="btn-fc" style="background:#27ae60" onclick="App.moveFC(1)">Siguiente</button>
                    </div>
                </div>
            </div>

            <div id="view-test" class="view-section">
                <h2>Evaluaci√≥n (20 Aleatorias)</h2>
                <div id="test-container"></div>
                <button class="btn-enter" style="width:auto; margin-top:20px;" onclick="App.submitTest()">Corregir</button>
                <div id="test-result" style="margin-top:20px; font-weight:bold; font-size:1.2rem; text-align:center;"></div>
            </div>

            <div id="view-admin" class="view-section">
                <h2>Panel de Gesti√≥n</h2>
                <div id="admin-tools">
                    <div style="background:white; padding:20px; border-radius:8px; margin-bottom:20px;">
                        <h3>A√±adir Usuario</h3>
                        <input type="text" id="new-u" placeholder="Usuario" style="width:100%; padding:8px; margin-bottom:5px;">
                        <input type="text" id="new-p" placeholder="Clave" style="width:100%; padding:8px; margin-bottom:5px;">
                        <select id="new-r" style="width:100%; padding:8px; margin-bottom:5px;">
                            <optgroup label="Agentes"><option value="adc">Agente DC</option><option value="adt">Agente DT</option><option value="aut">Agente UT</option></optgroup>
                            <optgroup label="Mandos"><option value="mdc">Mando Calle</option><option value="mdt">Mando Territorial</option><option value="mut">Mando T√©cnico</option></optgroup>
                            <optgroup label="Direcci√≥n"><option value="jef">Jefatura</option><option value="admin">Admin</option><option value="master">MASTER</option></optgroup>
                        </select>
                        <select id="new-b" style="width:100%; padding:8px; margin-bottom:10px; background:#f0f7ff;"><option value="">-- Asignar Mando --</option></select>
                        <button class="btn-enter" onclick="App.addUser()">Crear Usuario</button>
                    </div>
                    <div style="background:white; padding:20px; border-radius:8px; margin-bottom:20px;">
                        <h3>Importar Excel</h3>
                        <textarea id="import-data" class="import-area" placeholder="Usuario | Clave | Rol | Jefe"></textarea>
                        <button class="btn-enter" style="background:#27ae60;" onclick="App.importUsers()">Importar Masivo</button>
                        <p id="import-msg" style="color:green; font-weight:bold;"></p>
                    </div>
                </div>
                <h3>Resultados Acad√©micos</h3>
                <table class="admin-table"><thead><tr><th>Usuario</th><th>Rol</th><th>Fecha</th><th>Nota</th><th>Fallos</th><th>Mando Asignado</th></tr></thead><tbody id="admin-logs"></tbody></table>
                <div id="security-box" style="margin-top:30px; display:none;">
                    <h3 style="color:#c0392b"><i class="fas fa-shield-alt"></i> Auditor√≠a de Seguridad</h3>
                    <div style="max-height:200px; overflow-y:auto; border:1px solid #ccc;">
                        <table class="admin-table" style="margin:0;"><thead><tr><th>Fecha</th><th>Usuario</th><th>Acci√≥n</th><th>Detalle</th></tr></thead><tbody id="sec-logs"></tbody></table>
                    </div>
                </div>
                <button class="btn-enter" style="background:#c0392b; width:auto; margin-top:20px;" onclick="App.clearLogs()">Borrar Historial</button>
            </div>
        </div>
    </div>
</div>

<script>
// --- BASE DE DATOS COMPLETA E INCRUSTADA ---
const DB = {
    audio_url: "audio.m4a",
    imagenes: [
        {nombre: "Infograf√≠a Estructura (Abrir)", url: "estructura.png"},
        {nombre: "Mapa Mental Protocolo (Abrir)", url: "mapa.png"}
    ],
    bibliografia: [
        {nivel: "Normativa", archivos: [{nombre:"OJ-PROTOCOLO-ACTUACION-SALAMANCA-FIRMADO (1).pdf", desc:"Protocolo Actuaci√≥n"}, {nombre:"Anexo-I-Manual-de-Organizacion-Salamanca-firmado.pdf", desc:"Manual Organizaci√≥n"}]},
        {nivel: "Manuales", archivos: [{nombre:"Anexo-II-Manual-del-SCT-Salamanca-firmado.pdf", desc:"Manual SCT"}, {nombre:"Anexo-III-Manual-del-SCG-Salamanca-firmado - copia.pdf", desc:"Manual SCG"}, {nombre:"Anexo-IV-Manual-SCEJ-Salamanca-firmado - copia.pdf", desc:"Manual SCEJ"}]},
        {nivel: "Gr√°ficos", archivos: [{nombre: "estructura.png", desc: "Infograf√≠a Estructura (Imagen)"}, {nombre: "mapa.png", desc: "Mapa Mental Protocolo (Imagen)"}]}
    ],
    secciones_temario: [
      { "titulo": "1. Introducci√≥n", "contenido": "<h3>1. Introducci√≥n: La transformaci√≥n del sistema judicial en Salamanca</h3><p>El presente documento tiene como finalidad servir de manual operativo y de referencia permanente para todos los miembros de la Polic√≠a Local de Salamanca, con independencia de su escala o destino funcional, ante la implantaci√≥n del nuevo modelo de Oficina Judicial (OJ).</p><p>Este modelo, que entrar√° en vigor el <strong>31 de diciembre de 2025</strong>, deriva de la Ley Org√°nica 1/2025, y supone una modificaci√≥n estructural profunda del funcionamiento de la Administraci√≥n de Justicia. Se abandona definitivamente el esquema tradicional de juzgados individuales y aislados para pasar a un sistema integrado, centralizado y especializado de servicios comunes, orientado a:</p><ul><li>Incrementar la agilidad en la tramitaci√≥n de los procedimientos.</li><li>Garantizar criterios homog√©neos de actuaci√≥n.</li><li>Optimizar los recursos humanos y materiales.</li><li>Facilitar la interoperabilidad digital entre operadores jur√≠dicos.</li></ul><p>Para la Polic√≠a Local, este cambio tiene una repercusi√≥n directa y diaria: var√≠an los puntos de entrada de la documentaci√≥n, los interlocutores, los circuitos de tramitaci√≥n y los responsables de cada fase del procedimiento. Un conocimiento preciso de esta arquitectura es indispensable para evitar errores, retrasos, devoluciones de atestados y disfunciones operativas.</p>" },
      { "titulo": "2. Visi√≥n General", "contenido": "<h3>2. Visi√≥n general de la nueva Oficina Judicial (OJ)</h3><p>La nueva OJ redefine completamente la relaci√≥n funcional entre la Polic√≠a Local y la Administraci√≥n de Justicia. Ya no se interact√∫a con ‚Äúun juzgado concreto‚Äù, sino con servicios especializados que asumen funciones bien delimitadas.</p><p>Conocer este mapa organizativo permite:</p><ul><li>Dirigir correctamente cada actuaci√≥n policial.</li><li>Identificar con rapidez el √≥rgano competente.</li><li>Reducir tiempos muertos y reiteraciones documentales.</li><li>Mejorar la coordinaci√≥n en actuaciones urgentes y complejas.</li></ul><h4>2.1 El Tribunal de Instancia (TI): eje del nuevo sistema judicial</h4><p>El Tribunal de Instancia (TI) de Salamanca constituye el n√∫cleo jurisdiccional del nuevo modelo. Integra en una √∫nica estructura todas las anteriores plazas judiciales del partido judicial, organizadas internamente en secciones por materias, lo que favorece la especializaci√≥n y la coherencia en la respuesta judicial.</p><p><strong>Secciones del Tribunal de Instancia de Salamanca:</strong></p><ul><li>Secci√≥n Civil</li><li>Secci√≥n de Instrucci√≥n</li><li>Secci√≥n de Familia, Infancia y Capacidad</li><li>Secci√≥n de lo Penal</li><li>Secci√≥n de Menores</li><li>Secci√≥n de Vigilancia Penitenciaria</li><li>Secci√≥n de lo Contencioso-Administrativo</li><li>Secci√≥n de lo Social</li></ul><p>Cada secci√≥n ejerce la funci√≥n jurisdiccional (juzgar y resolver), mientras que la tramitaci√≥n material de los procedimientos se encomienda a los Servicios Comunes.</p>" },
      { "titulo": "3. Servicios Comunes", "contenido": "<h3>2.2 Los Servicios Comunes: columna vertebral de la Oficina Judicial</h3><p>La Oficina Judicial se estructura en tres Servicios Comunes, que prestan apoyo tanto al Tribunal de Instancia como a la Audiencia Provincial. Cada uno tiene competencias exclusivas y claramente delimitadas.</p><table class='doc-table'><tr><th>Servicio Com√∫n</th><th>Acr√≥nimo</th><th>Funci√≥n principal</th></tr><tr><td>Servicio Com√∫n General</td><td><strong>SCG</strong></td><td>Punto √∫nico de entrada: recepci√≥n, registro, reparto, actos de comunicaci√≥n y archivo</td></tr><tr><td>Servicio Com√∫n de Tramitaci√≥n</td><td><strong>SCT</strong></td><td>Gesti√≥n integral de los procedimientos en fase declarativa (instrucci√≥n y enjuiciamiento)</td></tr><tr><td>Servicio Com√∫n de Ejecuci√≥n</td><td><strong>SCEJ</strong></td><td>Ejecuci√≥n de resoluciones judiciales firmes</td></tr></table><p>Este modelo elimina duplicidades y asegura que cada documento policial siga un circuito previsible y trazable.</p>" },
      { "titulo": "4. Gu√≠a Operativa", "contenido": "<h3>3. Gu√≠a operativa para la escala ejecutiva de la Polic√≠a Local</h3><p>Esta secci√≥n est√° orientada al personal operativo y de patrulla, que constituye el primer eslab√≥n del procedimiento judicial. Se centra en las actuaciones m√°s frecuentes y cr√≠ticas.</p><h4>3.1 Inicio del procedimiento: destino correcto del atestado o informe policial</h4><p><strong>Principio fundamental:</strong> Todo documento policial tiene un √∫nico punto de entrada ordinario: el <strong>Servicio Com√∫n General (SCG)</strong>.</p><p><strong>Circuito ordinario del atestado:</strong></p><ul><li><strong>Presentaci√≥n en el SCG:</strong> Preferentemente por v√≠a telem√°tica. El formato f√≠sico solo se utilizar√° cuando est√© expresamente autorizado. <strong>Horario:</strong> lunes a viernes laborables, de 08:30 a 15:00 horas.</li><li><strong>Registro oficial:</strong> El SCG registra el documento en el sistema de gesti√≥n procesal. Se garantiza la trazabilidad y la validez procesal del atestado.</li><li><strong>Reparto competencial:</strong> El SCG asigna el asunto a la secci√≥n judicial competente.</li><li><strong>Remisi√≥n al SCT correspondiente:</strong> En materia penal, el atestado se remite al Servicio Com√∫n de Tramitaci√≥n ‚Äì √Årea Penal, que asume la instrucci√≥n.</li></ul><p><strong>Importancia operativa:</strong> Un atestado mal dirigido no se corrige en destino: se devuelve al circuito inicial. Los errores en el punto de entrada generan retrasos que afectan a medidas cautelares, citaciones y se√±alamientos.</p>" },
      { "titulo": "5. Guardia (Urgencias)", "contenido": "<h4>3.2 Interacci√≥n con el Servicio de Guardia (GU)</h4><p>El Servicio de Guardia constituye una excepci√≥n al circuito ordinario y se activa exclusivamente para actuaciones urgentes e inaplazables.</p><p><strong>Documentaci√≥n que debe remitirse directamente a Guardia:</strong></p><ul><li>Atestados con persona detenida.</li><li>Atestados con investigado citado para comparecer ante el juez de guardia.</li><li>Solicitudes urgentes: Entradas y registros, Intervenciones telef√≥nicas, Medidas cautelares inmediatas.</li></ul><p><strong>Funcionamiento:</strong> El personal de guardia recepciona, registra y da curso inmediato a la actuaci√≥n. El juez de guardia adopta decisiones en tiempo real. Posteriormente, el procedimiento se integra en el circuito ordinario del SCT.</p>" },
      { "titulo": "6. Polic√≠a Judicial", "contenido": "<h3>4. Manual avanzado para agentes de Polic√≠a Judicial</h3><p>Dirigido a unidades de investigaci√≥n y polic√≠a judicial, este apartado detalla la estructura interna con la que se trabajar√° de forma continuada.</p><h4>4.1 Servicio Com√∫n de Tramitaci√≥n (SCT) ‚Äì √Årea Penal</h4><p>El SCT Penal gestiona los procedimientos penales desde el inicio hasta la firmeza de la resoluci√≥n.</p><p><strong>Estructura interna:</strong></p><ul><li><strong>Equipos de Instrucci√≥n:</strong> Investigaci√≥n penal. Diligencias, pruebas, medidas cautelares.</li><li><strong>Equipos de Enjuiciamiento:</strong> Apertura de juicio oral. Se√±alamientos y celebraci√≥n de vistas. Sentencias.</li><li><strong>Grupos de trabajo:</strong> Delitos graves y menos graves. Delitos leves (tramitaci√≥n y enjuiciamiento).</li></ul>" },
      { "titulo": "7. Unidades Espec.", "contenido": "<h4>4.2 Unidades especializadas (S4M)</h4><ul><li><strong>Violencia sobre la Mujer:</strong> Grupo de Instrucci√≥n n¬∫ 3. Competencias: Instrucci√≥n penal, Delitos leves asociados, √ìrdenes de protecci√≥n y medidas cautelares.</li><li><strong>Menores:</strong> Grupo espec√≠fico del Equipo de Enjuiciamiento. Competencia integral: Desde Fiscal√≠a de Menores hasta ejecuci√≥n de medidas.</li><li><strong>Familia, Infancia y Capacidad (√Årea Civil):</strong> Internamientos no voluntarios. Custodias y reg√≠menes de visitas. Medidas de protecci√≥n a personas vulnerables. Intervenci√≥n policial bajo mandato del LAJ.</li></ul>" },
      { "titulo": "8. Ejecuci√≥n (SCEJ)", "contenido": "<h4>4.3 Fase de ejecuci√≥n: Servicio Com√∫n de Ejecuci√≥n (SCEJ) ‚Äì √Årea Penal</h4><p>Una vez firme la sentencia, la competencia pasa al SCEJ.</p><p><strong>Actuaciones con impacto policial:</strong></p><ul><li>Mandamientos de prisi√≥n.</li><li>√ìrdenes de b√∫squeda, captura e ingreso.</li><li>Mandamientos de libertad.</li><li>Ejecuci√≥n de multas e indemnizaciones.</li><li>Embargos y averiguaciones patrimoniales.</li><li>Suspensi√≥n de penas y acumulaciones.</li></ul><h4>4.4 Gesti√≥n digital y comunicaciones</h4><p>La Oficina Judicial es √≠ntegramente digital. La calidad del expediente depende del primer env√≠o policial. <strong>Principios clave:</strong> Uso obligatorio de canales telem√°ticos. Datos completos, correctos y normalizados. Evitar duplicidades y anexos mal identificados.</p>" },
      { "titulo": "9. Mandos", "contenido": "<h3>5. Pautas para la escala t√©cnica y superior</h3><p>Este apartado se dirige a jefaturas y mandos, responsables de la coordinaci√≥n estrat√©gica.</p><h4>5.1 Estructura de mando de la Oficina Judicial</h4><ul><li><strong>Director/a del Servicio Com√∫n (LAJ):</strong> m√°xima autoridad funcional.</li><li><strong>Jefatura de √Årea (LAJ o GPA):</strong> coordinaci√≥n por materias.</li><li><strong>Jefatura de Equipo (GPA, TPA o AJ):</strong> gesti√≥n directa operativa.</li></ul><h4>5.2 Coordinaci√≥n institucional</h4><p><strong>√ìrganos relevantes:</strong> Comit√© de Direcci√≥n (√≥rgano estrat√©gico) y Comit√©s de Coordinaci√≥n (resoluci√≥n de problemas operativos). Canales formales para elevar incidencias estructurales o recurrentes.</p><h4>5.3 Gesti√≥n de incidencias comunes</h4><table class='doc-table'><tr><th>Incidencia</th><th>Procedimiento</th></tr><tr><td>Reparto incorrecto</td><td>Devoluci√≥n al equipo de inicio; correcci√≥n v√≠a SCG</td></tr><tr><td>Errores en datos</td><td>Correcci√≥n por la Jefatura de Equipo tramitador</td></tr><tr><td>Documento sin registro</td><td>Remisi√≥n inmediata al SCG</td></tr></table>" },
      { "titulo": "10. Protocolos", "contenido": "<h3>6. Instrucci√≥n interna de Jefatura ‚Äì Formato Circular</h3><p><strong>6.1 Naturaleza:</strong> Obligatorio y vinculante. <strong>6.2 Entrada en vigor:</strong> 31 de diciembre de 2025.</p><h4>7. Esquemas operativos de flujo</h4><ul><li><strong>Flujo general de atestado penal (no urgente):</strong> Actuaci√≥n policial ‚Üí Redacci√≥n ‚Üí Remisi√≥n telem√°tica ‚Üí Servicio Com√∫n General (SCG) ‚Üí Registro y reparto ‚Üí SCT (√Årea Penal) ‚Üí Instrucci√≥n.</li><li><strong>Flujo de actuaci√≥n urgente (Servicio de Guardia):</strong> Hecho urgente ‚Üí Atestado inmediato ‚Üí Remisi√≥n directa a Servicio de Guardia ‚Üí Registro en Guardia ‚Üí Resoluci√≥n judicial inmediata ‚Üí Integraci√≥n posterior en SCT.</li><li><strong>Flujo de ejecuci√≥n penal:</strong> Sentencia firme ‚Üí Servicio Com√∫n de Ejecuci√≥n (SCEJ) ‚Üí Mandamiento (prisi√≥n, libertad, embargo‚Ä¶) ‚Üí Requerimiento a Polic√≠a Local ‚Üí Ejecuci√≥n material.</li></ul><h4>8. Adaptaci√≥n por materias espec√≠ficas</h4><ul><li><strong>Tr√°fico:</strong> Atestados delitos seguridad vial ‚Üí SCG ‚Üí SCT Penal. Juicios r√°pidos ‚Üí Guardia.</li><li><strong>Violencia de G√©nero:</strong> Atestados urgentes ‚Üí Servicio de Guardia. Grupo de Instrucci√≥n n¬∫ 3 VSM.</li><li><strong>Menores:</strong> Atestados ‚Üí SCG ‚Üí SCT (Grupo de Menores).</li><li><strong>Contencioso:</strong> Denuncias administrativas judicializadas ‚Üí SCG.</li></ul><h3>9. Versi√≥n de bolsillo para patrulla</h3><p>¬øTengo un atestado? No urgente ‚Üí SCG. Detenido / urgente ‚Üí Guardia. ¬øEs ejecuci√≥n de sentencia? Siempre SCEJ. Nunca enviar directamente a un juzgado.</p><h3>10. Versi√≥n estrat√©gica para mandos</h3><p>Canal √∫nico ordinario: SCG. Guardia solo para urgencias reales. SCT = fase declarativa. SCEJ = ejecuci√≥n. Incidencias estructurales ‚Üí Comit√© de Direcci√≥n.</p><p><strong>Cierre:</strong> La correcta aplicaci√≥n de esta instrucci√≥n es responsabilidad de toda la cadena de mando. Su incumplimiento podr√° generar responsabilidades disciplinarias por disfunci√≥n operativa o perjuicio procesal.</p>" }
    ],
    // 100 TARJETAS REALES (NO COPIAS)
    flashcards: [
        {f:"¬øFecha entrada vigor?", b:"31/12/2025"}, {f:"¬øLey reguladora?", b:"LO 1/2025"}, {f:"¬øSustituto Juzgados?", b:"Tribunal Instancia"},
        {f:"¬øPunto entrada √∫nico?", b:"SCG"}, {f:"¬øHorario SCG?", b:"L-V 08:30-15:00"}, {f:"¬øAtestado detenido?", b:"Guardia"},
        {f:"¬øGesti√≥n instrucci√≥n?", b:"SCT Penal"}, {f:"¬øEjecuci√≥n sentencias?", b:"SCEJ"}, {f:"¬øM√°xima autoridad?", b:"Director LAJ"},
        {f:"¬øError datos?", b:"Jefe Equipo"}, {f:"¬øSin registrar?", b:"Remitir SCG"}, {f:"¬øViolencia Mujer?", b:"Grupo Instr. 3"},
        {f:"¬øMenores?", b:"SCT Enjuiciamiento"}, {f:"¬øInternamientos?", b:"SCT Civil"}, {f:"¬øBusca y captura?", b:"SCEJ"},
        {f:"¬øAtenea?", b:"Gesti√≥n procesal"}, {f:"¬øLexNet?", b:"Comunicaciones"}, {f:"¬øDelitos Leves?", b:"Grupos Trabajo SCT"},
        {f:"¬øNotificaciones calle?", b:"SCG"}, {f:"¬øDep√≥sito Efectos?", b:"SCG"}, {f:"¬øSiglas SCT?", b:"SC Tramitaci√≥n"},
        {f:"¬øSiglas SCEJ?", b:"SC Ejecuci√≥n"}, {f:"¬øSiglas OJM?", b:"Oficina Justicia Municipio"}, {f:"¬øSustituto Paz?", b:"OJM"},
        {f:"¬øFirma protocolo?", b:"Secretarios Coord/Gob"}, {f:"¬øSubastas?", b:"SCEJ"}, {f:"¬øCaja Dep√≥sitos?", b:"SCEJ"},
        {f:"¬øControl cuentas?", b:"Trimestral"}, {f:"¬øVideoconferencias?", b:"EVID"}, {f:"¬øSustituciones?", b:"Jefe √Årea"},
        {f:"¬øAtenci√≥n p√∫blico?", b:"09-14h"}, {f:"¬øNivel b√°sico?", b:"Equipos"}, {f:"¬øPublicidad?", b:"PAGAJ"},
        {f:"¬øArchivo?", b:"SCG"}, {f:"¬øRegistro elect?", b:"SIR"}, {f:"¬øObj OJM?", b:"Acercar justicia"},
        {f:"¬øLanzamientos?", b:"Polic√≠a a requerimiento"}, {f:"¬øUrgencias E/R?", b:"Guardia"}, {f:"¬øInvestigado citado?", b:"Guardia"},
        {f:"¬øJuicios r√°pidos?", b:"Guardia -> SCT"}, {f:"¬øRetirada carnet?", b:"SCEJ"}, {f:"¬øDenuncias admin?", b:"SCG"},
        {f:"¬øSuspensiones?", b:"SCEJ"}, {f:"¬øLibertad?", b:"SCEJ"}, {f:"¬øFallo LexNet?", b:"F√≠sico justificado"},
        {f:"¬øJefe Equipo?", b:"Gestor/Tramitador"}, {f:"¬øJefe √Årea?", b:"LAJ/Gestor"}, {f:"¬øComit√© Direcci√≥n?", b:"Estrat√©gico"},
        {f:"¬øComit√© Coord?", b:"Operativo"}, {f:"¬øReparto error?", b:"Devolver inicio"}, {f:"¬øSede SCG?", b:"Col√≥n/Gran V√≠a"},
        {f:"¬øTurno oficio?", b:"Colegio Abogados"}, {f:"¬øRecurso Diligencia?", b:"Reposici√≥n"}, {f:"¬øAcceso Atenea?", b:"Pasarelas"},
        {f:"¬øPreside Junta?", b:"Decano"}, {f:"¬øForense Guardia?", b:"Urgencias"}, {f:"¬øAgosto?", b:"Causas urgentes"},
        {f:"¬øJuris Voluntaria?", b:"SCT Civil"}, {f:"¬øFe p√∫blica?", b:"LAJ"}, {f:"¬øExhorto?", b:"Auxilio judicial"},
        {f:"¬øDesahucios?", b:"Comisi√≥n Judicial"}, {f:"¬øDecomisos?", b:"Destrucci√≥n"}, {f:"¬øRebelde?", b:"Busca y captura"},
        {f:"¬øLibertad cond?", b:"Vig. Penitenciaria"}, {f:"¬øHomicidio?", b:"Jurado"}, {f:"¬øNotif detenido?", b:"Lectura derechos"},
        {f:"¬øFallo EVID?", b:"Acta escrita"}, {f:"¬øIncapacidades?", b:"SCT Familia"}, {f:"¬øDaci√≥n cuenta?", b:"Informar estado"},
        {f:"¬øOrden protecci√≥n?", b:"V√≠ctima/Fiscal/Oficio"}, {f:"¬øArchivo def?", b:"SCG"}, {f:"¬øAcceso sede?", b:"Guardia Civil"},
        {f:"¬øApud Acta?", b:"Apoderamiento"}, {f:"¬øCaducidad req?", b:"Prescripci√≥n"}, {f:"¬øDirige invest?", b:"Juez Instr."},
        {f:"¬øJuicio R√°pido?", b:"Diligencias Urgentes"}, {f:"¬øMenor detenido?", b:"Fiscal√≠a"}, {f:"¬øDiligencia const?", b:"LAJ"},
        {f:"¬øValor atestado?", b:"Denuncia"}, {f:"¬øConflicto comp?", b:"Audiencia"}, {f:"¬øSubasta bienes?", b:"Portal BOE"},
        {f:"¬øEscritos 24h?", b:"LexNet"}, {f:"¬øDetenci√≥n max?", b:"72h"}, {f:"¬øHabeas Corpus?", b:"24h"},
        {f:"¬øAforados?", b:"TSJ/Supremo"}, {f:"¬øPNJ?", b:"Punto Neutro"}, {f:"¬øLevantamiento?", b:"Guardia"},
        {f:"¬øNotif polic√≠a?", b:"Enlace"}, {f:"¬øMandamiento?", b:"Orden"}, {f:"¬øProvidencia?", b:"Juez"},
        {f:"¬øDecreto?", b:"LAJ"}, {f:"¬øTasaci√≥n?", b:"LAJ"}, {f:"¬øCustodia activos?", b:"SCT/SCEJ"},
        {f:"¬øCustodia archivo?", b:"SCG"}, {f:"¬øSIRAJ?", b:"Registros Admin"}, {f:"¬øReg Penados?", b:"Sentencias"},
        {f:"¬øAlejamiento?", b:"Auto Juez"}, {f:"¬øJuicio in voce?", b:"Oral"}, {f:"¬øApelaci√≥n?", b:"10 d√≠as"},
        {f:"¬øConformidad?", b:"Reconoce hechos"}, {f:"¬øSecciones TI?", b:"Civil, Penal, Menores..."}, {f:"¬øFunciones Polic√≠a?", b:"Auxilio y Ejecuci√≥n"},
        {f:"¬øActos Comunicaci√≥n?", b:"SCG Equipo 2"}, {f:"¬øRegistro Civil?", b:"Independiente"}, {f:"¬øJuez Decano?", b:"Representativo"},
        {f:"¬øJunta Jueces?", b:"Unificaci√≥n Criterios"}, {f:"¬øFiscal√≠a?", b:"Defensa Legalidad"}, {f:"¬øLetrados?", b:"Defensa Partes"},
        {f:"¬øProcuradores?", b:"Representaci√≥n"}, {f:"¬øGraduados Sociales?", b:"Laboral"}, {f:"¬øM√©dicos Forenses?", b:"IML"},
        {f:"¬øIT?", b:"Inform√°tica"}, {f:"¬øGerencia?", b:"Medios Materiales"}, {f:"¬øSede Electr√≥nica?", b:"Tr√°mites Digitales"}
    ],
    // 70 PREGUNTAS TEST REALES (NO COPIAS)
    test: [
        {p:"¬øPuerta √∫nica entrada?", r:["Decanato","SCG","SCT"], c:1}, {p:"¬øHorario SCG?", r:["09-14","08:30-15:00","24h"], c:1},
        {p:"¬øAtestado DETENIDO?", r:["SCG","Guardia","SCT"], c:1}, {p:"¬øInstrucci√≥n?", r:["SCT","SCEJ","SCG"], c:0},
        {p:"¬øEjecuci√≥n?", r:["SCT","SCEJ","Guardia"], c:1}, {p:"¬øAutoridad funcional?", r:["Decano","LAJ","Gestor"], c:1},
        {p:"¬øViolencia Mujer?", r:["Grupo 3","Menores","SCG"], c:0}, {p:"¬øError DNI?", r:["Comisar√≠a","Jefe Equipo","Decano"], c:1},
        {p:"¬øSin registrar?", r:["Archivar","Devolver SCG","Procesar"], c:1}, {p:"¬øNotif. calle?", r:["Polic√≠a","SCG","SCT"], c:1},
        {p:"¬øDelitos leves?", r:["SCT","SCEJ","Paz"], c:0}, {p:"¬øEmbargos?", r:["SCT","SCEJ","SCG"], c:1},
        {p:"¬øEstrategia?", r:["Comit√© Direcci√≥n","Sindicato","Junta"], c:0}, {p:"¬øLey?", r:["LO 1/2025","LECrim","Civil"], c:0},
        {p:"¬øE/R Urgente?", r:["SCG","Guardia","SCT"], c:1}, {p:"¬øDep√≥sito?", r:["SCG","SCT","Cient√≠fica"], c:0},
        {p:"¬øJuzgados Paz?", r:["OJM","Ayto","Registro"], c:0}, {p:"¬øVigor?", r:["31/12/25","01/01/26","Ya"], c:0},
        {p:"¬øTI sustituye?", r:["Audiencia","Unipersonales","Supremo"], c:1}, {p:"¬øGesti√≥n?", r:["Atenea","LexNet","Siraj"], c:0},
        {p:"¬øReparto?", r:["Decano","SCG","SCT"], c:1}, {p:"¬øDivorcio?", r:["SCT Civil","SCEJ","SCG"], c:0},
        {p:"¬øCoord. Equipo?", r:["Jefe √Årea","Jefe Equipo","Direcci√≥n"], c:0}, {p:"¬øMenores?", r:["SCT Enjuicia","Civil","SCEJ"], c:0},
        {p:"¬øFirma prisi√≥n?", r:["Juez","LAJ","Gestor"], c:0}, {p:"¬øPAGAJ?", r:["Punto Acceso","Sindicato","Juzgado"], c:0},
        {p:"¬øGuardia 24h?", r:["S√≠, urgencias","No","Fines semana"], c:0}, {p:"¬øAtestado directo?", r:["Devolver SCG","Tramitar","Perder"], c:0},
        {p:"¬øEjecuta multas?", r:["SCEJ","SCT","Hacienda"], c:0}, {p:"¬øFase declarativa?", r:["Instrucci√≥n","Ejecuci√≥n","Recurso"], c:0},
        {p:"¬øDirecci√≥n diaria?", r:["Jefe Equipo","Juez","Fiscal"], c:0}, {p:"¬øAntecedentes?", r:["Gerencia","Comisar√≠a","Ayto"], c:0},
        {p:"¬øExpurgo?", r:["Junta","Limpieza","Polic√≠a"], c:0}, {p:"¬øPresidente TI?", r:["S√≠","No","A veces"], c:0},
        {p:"¬øCaja dep√≥sitos?", r:["SCEJ","Banco","SCG"], c:0}, {p:"¬øLanzamientos?", r:["SCG","SCT","SCEJ"], c:0},
        {p:"¬øVideoconf?", r:["SCG/SCT","Polic√≠a","Prisi√≥n"], c:0}, {p:"¬øTelem√°tico?", r:["Obligatorio","Opcional","Graves"], c:0},
        {p:"¬øTrabajos benef?", r:["SCEJ","SCT","Polic√≠a"], c:0}, {p:"¬øObjetivo NOJ?", r:["Agilidad","Ahorro","Personal"], c:0},
        {p:"¬øPrincipio SCP?", r:["Independencia","Jerarqu√≠a","Autonom√≠a"], c:1}, {p:"¬øDirecci√≥n T√©c?", r:["Decano","LAJ","Fiscal"], c:1},
        {p:"¬øCertific. Archivo?", r:["SCG","SCT","Decanato"], c:0}, {p:"¬øSoporte varios?", r:["UPAD","SCP","Juzgados"], c:1},
        {p:"¬øAutoriza E/R?", r:["LAJ","Juez","Comisario"], c:1}, {p:"¬øPiezas t√≥xicas?", r:["Despacho","Protocolo","Devolver"], c:1},
        {p:"¬øLanzamientos SCEJ?", r:["No","S√≠","Solo Juez"], c:1}, {p:"¬øEscritos tr√°mite?", r:["Juez","SCG","Comisar√≠a"], c:1},
        {p:"¬øEmbargo cuentas?", r:["PNJ","Google","Agencia"], c:0}, {p:"¬øJefe Auxilio?", r:["Gestor","LAJ","Polic√≠a"], c:1},
        {p:"¬øSalas Vistas?", r:["SCT/SCG","Limpieza","Abogados"], c:0}, {p:"¬øNotif. sentencia?", r:["Juez","SCG","Abogado"], c:1},
        {p:"¬øPlazo detenci√≥n?", r:["72h","24h","48h"], c:0}, {p:"¬øCitaci√≥n polic√≠a?", r:["Tel√©fono","Conducto","Correo"], c:1},
        {p:"¬øAtt. Ciudadano?", r:["Externo","OJ","ONG"], c:1}, {p:"¬øSecreto sumario?", r:["LAJ","Juez","Polic√≠a"], c:1},
        {p:"¬øTasaci√≥n?", r:["Colegio","LAJ","Juez"], c:1}, {p:"¬øHabeas Corpus?", r:["Querella","Solicitud","Atestado"], c:1},
        {p:"¬øUbicaci√≥n SCG?", r:["Comisar√≠a","Juzgados","Ayto"], c:1}, {p:"¬øTurno oficio?", r:["Colegio","Decano","SCG"], c:0},
        {p:"¬øRecurso Diligencia?", r:["Reposici√≥n","Amparo","Nada"], c:0}, {p:"¬øAcceso Atenea?", r:["S√≠","Pasarela","Cualquiera"], c:1},
        {p:"¬øPreside Junta?", r:["Decano","Audiencia","LAJ"], c:0}, {p:"¬øForense Guardia?", r:["Urgencias","Detenidos","Sustituto"], c:1},
        {p:"¬øAgosto?", r:["Nunca","Urgentes","Ma√±anas"], c:1}, {p:"¬øJuris. Voluntaria?", r:["SCT Civil","SCEJ","Registro"], c:0},
        {p:"¬øFe p√∫blica?", r:["Juez","LAJ","Polic√≠a"], c:1}, {p:"¬øExhorto?", r:["Multa","Auxilio","Sentencia"], c:1},
        {p:"¬øEjecuta desahucio?", r:["Comisi√≥n","Propietario","Ayto"], c:0}, {p:"¬øDecomiso l√≠cito?", r:["Polic√≠a","Realizaci√≥n","Basura"], c:1}
    ]
};

const App = {
    data: DB,
    user: null,
    dbUsers: 'noj_users_v70_definitive', dbLogs: 'noj_logs_v70_definitive', dbSec: 'noj_sec_v70_definitive',

    init: async () => {
        document.addEventListener('keyup', (e) => {
            if(e.key === 'Enter' && !document.getElementById('login-screen').classList.contains('hidden')) App.login();
        });

        if(!localStorage.getItem(App.dbUsers)) {
            const defs = [
                { u:'master', p:'master', r:'master', boss:'', change:true },
                { u:'admin', p:'admin', r:'admin', boss:'', change:true },
                { u:'jefatura', p:'jefatura', r:'jef', boss:'', change:true },
                { u:'mandodc', p:'1234', r:'mdc', boss:'', change:true },
                { u:'mandodt', p:'1234', r:'mdt', boss:'', change:true },
                { u:'mandout', p:'1234', r:'mut', boss:'', change:true },
                { u:'agentedc', p:'1234', r:'adc', boss:'mandodc', change:true }
            ];
            localStorage.setItem(App.dbUsers, JSON.stringify(defs));
            App.logSec('SYSTEM', 'Inicializaci√≥n V70');
        }

        // BARAJAR Y CORTAR PARA CADA SESI√ìN
        if(App.data.flashcards) App.sessionCards = App.shuffle([...App.data.flashcards]).slice(0, 30);
        if(App.data.test) App.sessionTest = App.shuffle([...App.data.test]).slice(0, 20);

        App.renderTemario();
        App.renderBiblio();
        App.renderMedia();
        App.renderFC();
        App.renderTest();
        if(document.getElementById('main-audio')) document.getElementById('main-audio').src = App.data.audio_url;
    },

    shuffle: (a) => { for(let i=a.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; },

    logSec: (a, d) => {
        const l = JSON.parse(localStorage.getItem(App.dbSec)||'[]');
        l.unshift({d:new Date().toLocaleString(), u:App.user?App.user.u:'GUEST', a:a, t:d});
        if(l.length>100) l.pop(); localStorage.setItem(App.dbSec, JSON.stringify(l));
    },

    login: () => {
        const u = document.getElementById('user').value.trim();
        const p = document.getElementById('pass').value.trim();
        const users = JSON.parse(localStorage.getItem(App.dbUsers));
        const found = users.find(x => x.u === u && x.p === p);
        if(found) {
            App.user = found;
            if(found.change) { document.getElementById('login-screen').style.display='none'; document.getElementById('password-screen').classList.remove('hidden'); return; }
            App.enterApp();
        } else { document.getElementById('msg').innerText = "Credenciales incorrectas"; App.logSec('LOGIN_FAIL', u); }
    },

    changePass: () => {
        const p1 = document.getElementById('new-p1').value; const p2 = document.getElementById('new-p2').value;
        if(p1.length<4 || p1!==p2) return document.getElementById('pass-msg').innerText = "Error contrase√±a";
        const users = JSON.parse(localStorage.getItem(App.dbUsers));
        const idx = users.findIndex(x => x.u === App.user.u);
        users[idx].p = p1; users[idx].change = false;
        localStorage.setItem(App.dbUsers, JSON.stringify(users)); App.user.p = p1;
        App.logSec('PASS_CHANGE', App.user.u); document.getElementById('password-screen').classList.add('hidden'); App.enterApp();
    },

    enterApp: () => {
        document.getElementById('login-screen').style.display='none';
        document.getElementById('main-app').style.display='flex';
        document.getElementById('display-user').innerText = App.user.u.toUpperCase();
        App.logSec('LOGIN_OK', App.user.u);
        if(['admin','master','jef','mdc','mdt','mut'].includes(App.user.r)) { document.getElementById('menu-admin').classList.remove('hidden'); App.renderAdmin(); }
    },
    logout: () => location.reload(),

    renderTemario: () => {
        const t = document.getElementById('doc-tabs'), c = document.getElementById('doc-content'); t.innerHTML=''; c.innerHTML='';
        App.data.secciones_temario.forEach((s,i) => {
            t.innerHTML += `<button class="doc-tab ${i===0?'active':''}" onclick="App.tab(${i})">${s.titulo}</button>`;
            c.innerHTML += `<div id="p${i}" class="doc-page ${i===0?'active':''}">${s.contenido}</div>`;
        });
    },
    tab: (i) => {
        document.querySelectorAll('.doc-tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.doc-page').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.doc-tab')[i].classList.add('active');
        document.getElementById('p'+i).classList.add('active');
    },

    renderBiblio: () => { 
        document.getElementById('file-tree').innerHTML = ''; 
        App.data.bibliografia.forEach(c => { 
            let l = c.archivos.map(f => `<li style="margin-bottom:5px;"><a href="${f.nombre}" target="_blank" style="text-decoration:none; color:#0a2e5c;">üìÑ ${f.desc}</a></li>`).join(''); 
            document.getElementById('file-tree').innerHTML += `<li style="margin-bottom:15px;"><strong>${c.nivel}</strong><ul style="list-style:none; padding-left:10px;">${l}</ul></li>`; 
        }); 
    },

    renderMedia: () => {
        const c = document.getElementById('media-container'); c.innerHTML='';
        App.data.imagenes.forEach(i => c.innerHTML += `<div class="media-card" onclick="window.open('${i.url}','_blank')"><img src="${i.url}" onerror="this.src='//via.placeholder.com/300'"><p>${i.nombre}</p></div>`);
    },

    renderFC: () => { App.fcI=0; App.drawFC(); },
    drawFC: () => {
        if(!App.sessionCards) return;
        const c = App.sessionCards[App.fcI];
        document.getElementById('fc-canvas').innerHTML = `<div class="fc-inner"><div class="fc-face fc-front"><div><i class="fas fa-question-circle fa-2x"></i><br><br>${c.f}</div></div><div class="fc-face fc-back"><div>${c.b}</div></div></div>`;
        document.getElementById('fc-canvas').onclick = function() { this.classList.toggle('fc-flipped'); };
        document.getElementById('fc-count').innerText = `${App.fcI+1} / ${App.sessionCards.length}`;
    },
    moveFC: (d) => {
        App.fcI += d; if(App.fcI < 0) App.fcI = App.sessionCards.length - 1;
        if(App.fcI >= App.sessionCards.length) App.fcI = 0;
        document.getElementById('fc-canvas').classList.remove('fc-flipped'); setTimeout(() => App.drawFC(), 200);
    },

    renderTest: () => {
        document.getElementById('test-container').innerHTML = App.sessionTest.map((q,i) => `<div class="q-block" data-c="${q.c}"><p><b>${i+1}. ${q.p}</b></p>${q.r.map(r => `<div class="quiz-option" onclick="App.selOpt(this)">${r}</div>`).join('')}</div>`).join('');
    },
    selOpt: (el) => {
        el.parentElement.querySelectorAll('.quiz-option').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
    },
    submitTest: () => {
        let s = 0; document.querySelectorAll('.q-block').forEach(b => {
            const sel = b.querySelector('.selected'); const c = parseInt(b.dataset.c); const opts = b.querySelectorAll('.quiz-option');
            opts.forEach(o => o.classList.remove('correct','wrong'));
            if(sel) { if(Array.from(opts).indexOf(sel)===c) { sel.classList.add('correct'); s++; } else { sel.classList.add('wrong'); opts[c].classList.add('correct'); } }
        });
        document.getElementById('test-result').innerText = `Resultado: ${s} / 20 Aciertos`;
        const logs = JSON.parse(localStorage.getItem(App.dbLogs)||'[]');
        logs.push({u:App.user.u, d:new Date().toLocaleDateString(), s:s, f:20-s});
        localStorage.setItem(App.dbLogs, JSON.stringify(logs));
        if(['admin','master'].includes(App.user.r)) App.renderAdmin();
    },

    renderAdmin: () => {
        const global = ['admin','master'].includes(App.user.r); const jefatura = App.user.r === 'jef';
        const logs = JSON.parse(localStorage.getItem(App.dbLogs)||'[]'); const users = JSON.parse(localStorage.getItem(App.dbUsers));
        const t = document.getElementById('admin-logs'); t.innerHTML='';

        if(!global) document.getElementById('admin-tools').style.display='none';
        else {
            const bs = document.getElementById('new-b'); bs.innerHTML = '<option value="">-- Asignar Jefe --</option>';
            users.filter(u => ['mdc','mdt','mut','jef'].includes(u.r)).forEach(b => { bs.innerHTML += `<option value="${b.u}">${b.u} (${b.r})</option>`; });
        }

        if(global) {
            document.getElementById('security-box').style.display='block';
            const sl = JSON.parse(localStorage.getItem(App.dbSec)||'[]'); const st = document.getElementById('sec-logs'); st.innerHTML='';
            sl.forEach(s => st.innerHTML += `<tr><td>${s.d}</td><td>${s.u}</td><td>${s.a}</td><td>${s.t || ''}</td></tr>`);
        } else { document.getElementById('security-box').style.display='none'; }

        logs.forEach(l => {
            let show = false; const uData = users.find(x => x.u === l.u); const boss = uData ? uData.boss : '';
            if(global || jefatura) show = true; else if(boss === App.user.u) show = true;
            if(show) t.innerHTML += `<tr><td>${l.u}</td><td>${uData?uData.r:'?'}</td><td>${l.d}</td><td>${l.s}</td><td>${boss}</td></tr>`;
        });
    },

    addUser: () => {
        const u = document.getElementById('new-u').value; const p = document.getElementById('new-p').value; const r = document.getElementById('new-r').value; const b = document.getElementById('new-b').value;
        const users = JSON.parse(localStorage.getItem(App.dbUsers));
        if(users.find(x=>x.u===u)) return alert("Existe");
        users.push({u,p,r,boss:b, change:true}); localStorage.setItem(App.dbUsers, JSON.stringify(users));
        App.logSec('CREATE', u); App.renderAdmin(); alert("Ok");
    },
    importUsers: () => {
        const raw = document.getElementById('import-data').value; const users = JSON.parse(localStorage.getItem(App.dbUsers));
        const map = {'AGENTE (DC)':'adc','AGENTE (DT)':'adt','AGENTE (UT)':'aut','MANDO (DC)':'mdc','MANDO (DT)':'mdt','MANDO (UT)':'mut','JEFATURA':'jef','ADMIN':'admin','MASTER':'master'};
        let c=0;
        raw.split('\n').forEach(l => {
            let p = l.split(/\t+/); if(p.length<2) p=l.split(/\s+/);
            if(p.length>=2) {
                let r = map[p[2]] || 'adc';
                if(!users.find(x=>x.u===p[0])) { users.push({u:p[0], p:p[1], r:r, boss:p[3]||'', change:true}); c++; }
            }
        });
        localStorage.setItem(App.dbUsers, JSON.stringify(users)); document.getElementById('import-msg').innerText = `+${c}`; App.logSec('IMPORT', c); App.renderAdmin();
    },
    clearLogs: () => { if(confirm("¬øBorrar?")) { localStorage.removeItem(App.dbLogs); App.renderAdmin(); }},
    nav: (id) => { document.querySelectorAll('.view-section').forEach(x=>x.classList.remove('active')); document.getElementById('view-'+id).classList.add('active'); }
};
window.onload = App.init;
</script>
</body>
</html>
